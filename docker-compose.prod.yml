# Fungsi file: Mendefinisikan override konfigurasi produksi untuk orkestrasi layanan kontainer.
# docker-compose.prod.yml
# Production deployment dengan Nginx reverse proxy
#
# Penggunaan:
#   docker compose -f docker-compose.yml -f docker-compose.prod.yml pull api ui
#   docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --no-build
#
# File ini meng-override docker-compose.yml untuk production:
# - Menambah Nginx sebagai reverse proxy (port 80/443)
# - Environment diset Production
# - Port internal API & UI tidak di-expose langsung

services:
  api:
    build: !reset null
    image: ${API_IMAGE_REPO:-ghcr.io/marcellohugo/cashflowpoly-analytics-platform/api}:${IMAGE_TAG:-latest}
    pull_policy: always
    environment:
      ASPNETCORE_ENVIRONMENT: Production
    ports: !override []
    # Hapus port mapping langsung, semua traffic lewat Nginx

  ui:
    build: !reset null
    image: ${UI_IMAGE_REPO:-ghcr.io/marcellohugo/cashflowpoly-analytics-platform/ui}:${IMAGE_TAG:-latest}
    pull_policy: always
    environment:
      ASPNETCORE_ENVIRONMENT: Production
    ports: !override []

  db:
    ports: !override []
    # Database tidak di-expose ke luar di production

  nginx:
    image: nginx:alpine
    container_name: cashflowpoly-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      ui:
        condition: service_healthy
      api:
        condition: service_healthy
    networks:
      - cashflowpoly-net
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 5

  # Cloudflare Named Tunnel - domain permanen: tugasakhirmarco.my.id
  # Aktifkan dengan: docker compose --profile tunnel up -d
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cashflowpoly-tunnel
    restart: unless-stopped
    profiles: ["tunnel"]
    command: tunnel --no-autoupdate run --token ${CLOUDFLARE_TUNNEL_TOKEN}
    environment:
      - TUNNEL_LOGLEVEL=debug
    depends_on:
      nginx:
        condition: service_healthy
    networks:
      - cashflowpoly-net

