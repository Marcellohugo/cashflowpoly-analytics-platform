@model Cashflowpoly.Ui.Models.SessionDetailViewModel
@using System.Text.Json

@{
    ViewData["Title"] = Context.T("sessions.detail_title");
    var isInstructor = Context.Session.IsInstructor();
    var playerDisplayNames = Model.PlayerDisplayNames;
    var fallbackPlayerNames = new Dictionary<Guid, string>();
    var fallbackPlayerIndex = 1;
    var knownPlayerIds = (Model.Analytics?.ByPlayer.Select(item => item.PlayerId) ?? Enumerable.Empty<Guid>())
        .Concat(Model.Timeline.Where(item => item.PlayerId.HasValue).Select(item => item.PlayerId!.Value))
        .Distinct()
        .ToList();

    foreach (var playerId in knownPlayerIds)
    {
        if (playerDisplayNames.TryGetValue(playerId, out var displayName) && !string.IsNullOrWhiteSpace(displayName))
        {
            continue;
        }

        fallbackPlayerNames[playerId] = $"{Context.T("common.player")} {fallbackPlayerIndex}";
        fallbackPlayerIndex++;
    }

    string ResolvePlayerName(Guid playerId)
    {
        if (playerDisplayNames.TryGetValue(playerId, out var displayName) && !string.IsNullOrWhiteSpace(displayName))
        {
            return displayName;
        }

        if (fallbackPlayerNames.TryGetValue(playerId, out var fallbackName))
        {
            return fallbackName;
        }

        return Context.T("common.player");
    }

    string F(double value) => value.ToString("0.##");
}

<style>
    .session-board-node[data-seq] {
        cursor: pointer;
    }

    .session-board-node.is-focused {
        outline: 3px solid #2d7dd2;
        box-shadow: 0 14px 24px rgba(45, 125, 210, 0.26);
        transform: translateY(-4px);
    }

    .session-journey-title {
        max-width: 18ch;
        line-height: 1.15;
        text-wrap: balance;
    }

    .session-board-node {
        grid-template-rows: auto auto auto auto minmax(0, 1fr);
        min-height: 10.4rem;
    }

    .session-board-detail {
        margin-top: 0.35rem;
        font-size: 0.75rem;
        line-height: 1.35;
        color: #475569;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 3;
        overflow: hidden;
    }

    .session-board-title {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
        overflow: hidden;
    }

    .session-journey-insight-grid {
        margin-top: 0.8rem;
        display: grid;
        gap: 0.65rem;
        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
    }

    .session-journey-insight-card {
        border: 1px solid #a8e5de;
        border-radius: 0.85rem;
        background: rgba(255, 255, 255, 0.9);
        padding: 0.62rem 0.7rem;
        min-width: 0;
        min-height: 4.45rem;
        display: grid;
        align-content: start;
    }

    .session-journey-insight-label {
        margin: 0;
        font-size: 0.68rem;
        letter-spacing: 0.07em;
        text-transform: uppercase;
        color: #547286;
        font-weight: 800;
    }

    .session-journey-insight-value {
        margin: 0.32rem 0 0;
        color: #15394f;
        font-size: 0.92rem;
        font-weight: 800;
        line-height: 1.25;
    }

    @@media (max-width: 640px) {
        .session-journey-title {
            max-width: none;
        }

        .session-board-node {
            min-height: 9.2rem;
        }

        .session-journey-insight-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .session-journey-insight-card:last-child {
            grid-column: 1 / -1;
        }
    }
</style>

<section class="section-shell">
    <div class="ruleset-hero">
        <div>
            <p class="eyebrow text-emerald-700">@Context.T("sessions.analytics_title")</p>
            <h1 class="headline">@Context.T("sessions.detail_title")</h1>
            <p class="mt-2 text-xs text-slate-500 font-mono">@Model.SessionId</p>
        </div>
        <div class="ruleset-hero-meta">
            @if (!string.IsNullOrWhiteSpace(Model.SessionStatus))
            {
                var sessionStatusClass = string.Equals(Model.SessionStatus, "STARTED", StringComparison.OrdinalIgnoreCase)
                    ? "status-active"
                    : string.Equals(Model.SessionStatus, "CREATED", StringComparison.OrdinalIgnoreCase)
                        ? "status-draft"
                        : "status-retired";
                <span class="status-pill @sessionStatusClass">@Context.TSessionStatus(Model.SessionStatus)</span>
            }
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
    {
        <div class="mt-4 alert alert-error" aria-live="polite">
            @Model.ErrorMessage
        </div>
    }

    <div class="mt-6 metric-panel">
        <p class="eyebrow">@Context.T("sessions.active_ruleset.title")</p>
        @if (Model.Analytics?.RulesetId is Guid activeRulesetId)
        {
            <h2 class="text-xl font-semibold text-slate-900">
                @(string.IsNullOrWhiteSpace(Model.Analytics.RulesetName) ? Context.T("common.ruleset") : Model.Analytics.RulesetName)
            </h2>
            <p class="mt-1 text-xs font-mono text-slate-500">@activeRulesetId</p>
            <p class="mt-2 text-sm text-slate-600">@Context.T("sessions.active_ruleset.subtitle")</p>
            <div class="mt-3 action-toolbar">
                <a class="btn-ghost"
                   asp-controller="Rulesets"
                   asp-action="Details"
                   asp-route-rulesetId="@activeRulesetId">@Context.T("common.view")</a>
                @if (isInstructor)
                {
                    <a class="btn-primary"
                       asp-controller="Sessions"
                       asp-action="Ruleset"
                       asp-route-sessionId="@Model.SessionId">@Context.T("sessions.activate_ruleset")</a>
                }
            </div>
        }
        else
        {
            <p class="mt-2 text-sm text-slate-600">@Context.T("sessions.active_ruleset.empty")</p>
            @if (isInstructor)
            {
                <div class="mt-3 action-toolbar">
                    <a class="btn-primary"
                       asp-controller="Sessions"
                       asp-action="Ruleset"
                       asp-route-sessionId="@Model.SessionId">@Context.T("sessions.activate_ruleset")</a>
                </div>
            }
        }
    </div>

    @if (Model.Analytics is not null)
    {
        var rankedPlayers = Model.Analytics.ByPlayer
            .OrderByDescending(item => item.HappinessPointsTotal)
            .ThenByDescending(item => item.CashInTotal - item.CashOutTotal)
            .ThenBy(item => item.JoinOrder > 0 ? item.JoinOrder : int.MaxValue)
            .ThenBy(item => item.PlayerId)
            .ToList();
        var playerRankLookup = rankedPlayers
            .Select((item, index) => new { item.PlayerId, Rank = index + 1 })
            .ToDictionary(item => item.PlayerId, item => item.Rank);
        var donationChampions = Model.Analytics.ByPlayer
            .OrderByDescending(item => item.DonationPointsTotal)
            .ThenByDescending(item => item.DonationTotal)
            .ThenBy(item => item.JoinOrder > 0 ? item.JoinOrder : int.MaxValue)
            .ThenBy(item => item.PlayerId)
            .Take(3)
            .ToList();
        var pensionChampions = Model.Analytics.ByPlayer
            .OrderByDescending(item => item.PensionPointsTotal)
            .ThenByDescending(item => item.SavingGoalPointsTotal)
            .ThenByDescending(item => item.CashInTotal - item.CashOutTotal)
            .ThenBy(item => item.JoinOrder > 0 ? item.JoinOrder : int.MaxValue)
            .ThenBy(item => item.PlayerId)
            .Take(3)
            .ToList();
        var hasCategoryChampions = donationChampions.Count > 0 || pensionChampions.Count > 0;

        <div class="mt-6 grid gap-4 md:grid-cols-5">
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("metric.total_event")</p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">@Model.Analytics.Summary.EventCount</p>
            </div>
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("metric.cash_in")</p>
                <p class="mt-2 text-2xl font-semibold text-emerald-700">@Model.Analytics.Summary.CashInTotal</p>
            </div>
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("metric.cash_out")</p>
                <p class="mt-2 text-2xl font-semibold text-rose-700">@Model.Analytics.Summary.CashOutTotal</p>
            </div>
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("metric.net_cashflow")</p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">@Model.Analytics.Summary.CashflowNetTotal</p>
            </div>
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("metric.violations")</p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">@Model.Analytics.Summary.RulesViolationsCount</p>
            </div>
        </div>

        @if (hasCategoryChampions)
        {
            <div class="mt-6 winner-card">
                <div class="winner-card-icon" aria-hidden="true">
                    <svg viewBox="0 0 120 120" role="presentation">
                        <circle cx="60" cy="60" r="52" fill="#fff4c2" />
                        <path d="M40 25h40v18c0 11-9 20-20 20s-20-9-20-20V25z" fill="#f59e0b" />
                        <path d="M45 63h30v12H45z" fill="#12a89a" />
                        <path d="M42 75h36v14H42z" fill="#0d857a" />
                        <circle cx="60" cy="43" r="9" fill="#fff" />
                        <circle cx="56" cy="41" r="2" fill="#1f3f5a" />
                        <circle cx="64" cy="41" r="2" fill="#1f3f5a" />
                        <path d="M54 48c2 3 4 4 6 4s4-1 6-4" fill="none" stroke="#1f3f5a" stroke-width="2.5" stroke-linecap="round" />
                    </svg>
                </div>
                <div class="w-full">
                    <p class="eyebrow">@Context.T("sessions.champion.title")</p>
                    <h2 class="text-2xl font-semibold text-slate-900">@Context.T("sessions.champion.subtitle")</h2>
                    <div class="mt-4 grid gap-3 md:grid-cols-2">
                        <article class="metric-panel">
                            <h3>@Context.T("sessions.champion.donation")</h3>
                            <div class="mt-3 winner-meta">
                                @for (var championIndex = 0; championIndex < donationChampions.Count; championIndex++)
                                {
                                    var item = donationChampions[championIndex];
                                    <span>
                                        @Context.T("sessions.rank_label") @(championIndex + 1): @ResolvePlayerName(item.PlayerId) |
                                        @Context.T("metric.donation_points"): @F(item.DonationPointsTotal) |
                                        @Context.T("metric.donation"): @F(item.DonationTotal)
                                    </span>
                                }
                            </div>
                        </article>
                        <article class="metric-panel">
                            <h3>@Context.T("sessions.champion.pension")</h3>
                            <div class="mt-3 winner-meta">
                                @for (var championIndex = 0; championIndex < pensionChampions.Count; championIndex++)
                                {
                                    var item = pensionChampions[championIndex];
                                    <span>
                                        @Context.T("sessions.rank_label") @(championIndex + 1): @ResolvePlayerName(item.PlayerId) |
                                        @Context.T("metric.pension_points"): @F(item.PensionPointsTotal) |
                                        @Context.T("metric.saving_goal"): @F(item.SavingGoalPointsTotal)
                                    </span>
                                }
                            </div>
                        </article>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="mt-6 alert alert-info">@Context.T("sessions.champion.none")</div>
        }

        <div class="mt-8 table-wrap">
            <table class="w-full text-left text-sm mobile-card-table">
                <thead class="table-head">
                    <tr>
                        <th class="px-4 py-3 text-right">@Context.T("common.turn_order")</th>
                        <th class="px-4 py-3 text-right">@Context.T("common.rank")</th>
                        <th class="px-4 py-3">@Context.T("common.name")</th>
                        <th class="px-4 py-3 text-right">@Context.T("metric.cash_in")</th>
                        <th class="px-4 py-3 text-right">@Context.T("metric.cash_out")</th>
                        <th class="px-4 py-3 text-right">@Context.T("metric.donation")</th>
                        <th class="px-4 py-3 text-right">@Context.T("metric.donation_points")</th>
                        <th class="px-4 py-3 text-right">@Context.T("metric.pension_points")</th>
                        <th class="px-4 py-3 text-right">@Context.T("metric.gold_qty")</th>
                        <th class="px-4 py-3 text-right">@Context.T("metric.happiness")</th>
                        <th class="px-4 py-3 text-right">@Context.T("common.detail")</th>
                    </tr>
                </thead>
                <tbody>
                @if (Model.Analytics.ByPlayer.Count == 0)
                {
                    <tr>
                        <td class="px-4 py-4 text-slate-500 mobile-card-empty" colspan="11">@Context.T("state.no_player_data")</td>
                    </tr>
                }
                else
                {
                    foreach (var item in Model.Analytics.ByPlayer)
                    {
                        var rank = playerRankLookup.TryGetValue(item.PlayerId, out var resolvedRank)
                            ? resolvedRank
                            : 0;
                        var winnerRowClass = rank == 1
                            ? "winner-row"
                            : string.Empty;
                        <tr class="border-t border-slate-200 @winnerRowClass">
                            <td class="px-4 py-3 text-right text-slate-700" data-label="@Context.T("common.turn_order")">@(item.JoinOrder > 0 ? item.JoinOrder : "-")</td>
                            <td class="px-4 py-3 text-right text-slate-700" data-label="@Context.T("common.rank")">@(rank > 0 ? rank : "-")</td>
                            <td class="px-4 py-3 text-slate-700" data-label="@Context.T("common.name")">
                                @ResolvePlayerName(item.PlayerId)
                            </td>
                            <td class="px-4 py-3 text-right" data-label="@Context.T("metric.cash_in")">@item.CashInTotal</td>
                            <td class="px-4 py-3 text-right" data-label="@Context.T("metric.cash_out")">@item.CashOutTotal</td>
                            <td class="px-4 py-3 text-right" data-label="@Context.T("metric.donation")">@item.DonationTotal</td>
                            <td class="px-4 py-3 text-right" data-label="@Context.T("metric.donation_points")">@F(item.DonationPointsTotal)</td>
                            <td class="px-4 py-3 text-right" data-label="@Context.T("metric.pension_points")">@F(item.PensionPointsTotal)</td>
                            <td class="px-4 py-3 text-right" data-label="@Context.T("metric.gold_qty")">@item.GoldQty</td>
                            <td class="px-4 py-3 text-right" data-label="@Context.T("metric.happiness")">@item.HappinessPointsTotal</td>
                            <td class="px-4 py-3 text-right" data-label="@Context.T("common.detail")">
                                <a class="table-link"
                                   asp-controller="Players" asp-action="Details" asp-route-sessionId="@Model.SessionId"
                                   asp-route-playerId="@item.PlayerId">@Context.T("common.view")</a>
                            </td>
                        </tr>
                    }
                }
                </tbody>
            </table>
        </div>

    }

    <div class="mt-8 session-journey-shell">
        <div class="session-journey-head">
            <div>
                <p class="eyebrow">@Context.T("sessions.timeline")</p>
                <h2 class="text-2xl font-semibold text-slate-900 session-journey-title">@Context.T("sessions.timeline_title")</h2>
                <p class="subhead">@Context.T("sessions.timeline_subtitle")</p>
                <p class="mt-2 text-sm text-slate-600">@Context.T("sessions.journey.board_subtitle")</p>
            </div>
            <div class="session-journey-sync">
                <span>@Context.T("sessions.journey.last_sync")</span>
                <strong id="session-journey-synced">@DateTimeOffset.Now.ToLocalTime().ToString("dd/MM/yyyy HH:mm:ss")</strong>
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(Model.TimelineErrorMessage))
        {
            <div id="session-journey-error" class="mt-4 alert alert-warning" aria-live="polite">
                @Model.TimelineErrorMessage
            </div>
        }
        else
        {
            <div id="session-journey-error" class="mt-4 alert alert-warning hidden" aria-live="polite"></div>
        }

        <div class="session-board-wrap">
            <div id="session-board-track" class="session-board-track"></div>
        </div>

        <div class="session-journey-legend">
            <span class="session-journey-legend-item actor-player">@Context.T("sessions.actor.player")</span>
            <span class="session-journey-legend-item actor-system">@Context.T("sessions.actor.system")</span>
            <span class="session-journey-legend-item actor-instructor">@Context.T("sessions.actor.instructor")</span>
            <span class="session-journey-legend-item actor-other">@Context.T("sessions.actor.other")</span>
        </div>

        <div class="session-journey-insight-grid">
            <article class="session-journey-insight-card">
                <p class="session-journey-insight-label">@Context.T("metric.total_event")</p>
                <p id="session-journey-insight-total" class="session-journey-insight-value">0</p>
            </article>
            <article class="session-journey-insight-card">
                <p class="session-journey-insight-label">@Context.T("sessions.timeline_day_turn")</p>
                <p id="session-journey-insight-day-turn" class="session-journey-insight-value">-</p>
            </article>
            <article class="session-journey-insight-card">
                <p class="session-journey-insight-label">@Context.T("sessions.timeline_actor")</p>
                <p id="session-journey-insight-actor" class="session-journey-insight-value">-</p>
            </article>
            <article class="session-journey-insight-card">
                <p class="session-journey-insight-label">@Context.T("sessions.journey.latest_activity")</p>
                <p id="session-journey-insight-action" class="session-journey-insight-value">-</p>
            </article>
        </div>

    </div>
</section>

@section Scripts {
    <script>
        (() => {
            const boardTrackEl = document.getElementById("session-board-track");
            const errorEl = document.getElementById("session-journey-error");
            const syncedEl = document.getElementById("session-journey-synced");
            const insightTotalEl = document.getElementById("session-journey-insight-total");
            const insightDayTurnEl = document.getElementById("session-journey-insight-day-turn");
            const insightActorEl = document.getElementById("session-journey-insight-actor");
            const insightActionEl = document.getElementById("session-journey-insight-action");

            if (!boardTrackEl || !errorEl || !syncedEl) {
                return;
            }

            const timelineUrl = "@Url.Action("Timeline", "Sessions", new { sessionId = Model.SessionId })";
            const activeLanguage = @Html.Raw(JsonSerializer.Serialize(UiText.NormalizeLanguage(Context.Session.GetString(AuthConstants.SessionLanguageKey))));
            const browserLocale = activeLanguage === "en" ? "en-US" : "id-ID";
            const emptyMessage = @Html.Raw(JsonSerializer.Serialize(Context.T("sessions.journey.no_events")));
            const realtimeStatusTemplate = @Html.Raw(JsonSerializer.Serialize(Context.T("sessions.journey.realtime_status")));
            const realtimeNetworkMessage = @Html.Raw(JsonSerializer.Serialize(Context.T("sessions.journey.realtime_network")));
            const activityFallbackLabel = @Html.Raw(JsonSerializer.Serialize(Context.T("sessions.activity_default")));
            const dayLabel = @Html.Raw(JsonSerializer.Serialize(Context.T("sessions.day_label")));
            const turnLabel = @Html.Raw(JsonSerializer.Serialize(Context.T("sessions.turn_label")));
            const seqLabel = @Html.Raw(JsonSerializer.Serialize(Context.T("sessions.timeline_seq")));
            const actorLabels = {
                PLAYER: @Html.Raw(JsonSerializer.Serialize(Context.T("sessions.actor.player"))),
                SYSTEM: @Html.Raw(JsonSerializer.Serialize(Context.T("sessions.actor.system"))),
                INSTRUCTOR: @Html.Raw(JsonSerializer.Serialize(Context.T("sessions.actor.instructor"))),
                OTHER: @Html.Raw(JsonSerializer.Serialize(Context.T("sessions.actor.other")))
            };
            const playerLookupRaw = @Html.Raw(JsonSerializer.Serialize(Model.PlayerDisplayNames));
            const initialTimelineRaw = @Html.Raw(JsonSerializer.Serialize(Model.Timeline));
            const pollIntervalMs = 10000;
            const maxBoardNodes = 24;

            const playerLookup = Object.fromEntries(
                Object.entries(playerLookupRaw ?? {}).map(([key, value]) => [String(key).toLowerCase(), value])
            );
            let timeline = [];
            let pollingTimerId = null;
            let lastSequence = 0;

            const hasOwn = (obj, key) => Object.prototype.hasOwnProperty.call(obj, key);
            const toNumber = (value, fallback = 0) => {
                const numericValue = Number(value);
                return Number.isFinite(numericValue) ? numericValue : fallback;
            };
            const readValue = (obj, camelKey, pascalKey) => {
                if (!obj || typeof obj !== "object") {
                    return undefined;
                }

                if (hasOwn(obj, camelKey)) {
                    return obj[camelKey];
                }

                if (hasOwn(obj, pascalKey)) {
                    return obj[pascalKey];
                }

                return undefined;
            };
            const escapeHtml = (text) =>
                String(text ?? "")
                    .replaceAll("&", "&amp;")
                    .replaceAll("<", "&lt;")
                    .replaceAll(">", "&gt;")
                    .replaceAll("\"", "&quot;")
                    .replaceAll("'", "&#39;");
            const actorBucket = (actorType) => {
                const normalized = String(actorType ?? "").toUpperCase();
                return normalized === "PLAYER" || normalized === "SYSTEM" || normalized === "INSTRUCTOR"
                    ? normalized
                    : "OTHER";
            };
            const flowBucket = (actionType) => {
                const normalized = String(actionType ?? "").toLowerCase();
                if (normalized.startsWith("setup.")) return "setup";
                if (normalized.startsWith("day.")) return "day";
                if (normalized.startsWith("risk.")) return "risk";
                if (normalized.startsWith("loan.")) return "loan";
                if (normalized.startsWith("saving.")) return "saving";
                if (normalized.startsWith("mission.")) return "mission";
                if (normalized.includes("order")) return "order";
                return "generic";
            };
            const actorLabel = (item) => {
                const bucket = actorBucket(item.actorType);
                if (bucket === "PLAYER") {
                    if (item.playerDisplayName) {
                        return item.playerDisplayName;
                    }
                    const lookupName = playerLookup[String(item.playerId ?? "").toLowerCase()];
                    return lookupName || actorLabels.PLAYER;
                }

                if (bucket === "SYSTEM") return actorLabels.SYSTEM;
                if (bucket === "INSTRUCTOR") return actorLabels.INSTRUCTOR;
                return actorLabels.OTHER;
            };
            const actionLabel = (item) => item.flowLabel || item.actionType || activityFallbackLabel;
            const normalizeTimeline = (rawTimeline) => {
                if (!Array.isArray(rawTimeline)) {
                    return [];
                }

                return rawTimeline
                    .map((item) => {
                        const sequenceNumber = toNumber(readValue(item, "sequenceNumber", "SequenceNumber"), 0);
                        return {
                            timestamp: readValue(item, "timestamp", "Timestamp"),
                            sequenceNumber,
                            dayIndex: toNumber(readValue(item, "dayIndex", "DayIndex"), 0),
                            weekday: String(readValue(item, "weekday", "Weekday") ?? ""),
                            turnNumber: Math.max(1, toNumber(readValue(item, "turnNumber", "TurnNumber"), 1)),
                            actorType: String(readValue(item, "actorType", "ActorType") ?? ""),
                            playerId: readValue(item, "playerId", "PlayerId"),
                            playerDisplayName: readValue(item, "playerDisplayName", "PlayerDisplayName"),
                            actionType: String(readValue(item, "actionType", "ActionType") ?? ""),
                            flowLabel: String(readValue(item, "flowLabel", "FlowLabel") ?? ""),
                            flowDescription: String(readValue(item, "flowDescription", "FlowDescription") ?? "")
                        };
                    })
                    .filter((item) => item.sequenceNumber > 0)
                    .sort((a, b) => {
                        if (a.sequenceNumber !== b.sequenceNumber) {
                            return a.sequenceNumber - b.sequenceNumber;
                        }

                        return String(a.timestamp ?? "").localeCompare(String(b.timestamp ?? ""));
                    });
            };
            const formatDateTime = (rawValue) => {
                const dt = new Date(rawValue);
                if (Number.isNaN(dt.getTime())) {
                    return "-";
                }

                return dt.toLocaleString(browserLocale, {
                    day: "2-digit",
                    month: "2-digit",
                    year: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                    second: "2-digit"
                });
            };
            const clearFocusedItems = () => {
                boardTrackEl.querySelectorAll(".session-board-node.is-focused").forEach((node) => {
                    node.classList.remove("is-focused");
                });
            };
            const focusBySequence = (sequenceNumber) => {
                const normalizedSeq = toNumber(sequenceNumber, 0);
                if (normalizedSeq <= 0) {
                    return;
                }

                clearFocusedItems();
                const boardNode = boardTrackEl.querySelector(`.session-board-node[data-seq="${normalizedSeq}"]`);

                if (boardNode) {
                    boardNode.classList.add("is-focused");
                    boardNode.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "center" });
                }
            };
            const bindJourneyInteractions = () => {
                boardTrackEl.querySelectorAll(".session-board-node[data-seq]").forEach((node) => {
                    node.addEventListener("click", () => {
                        focusBySequence(node.getAttribute("data-seq"));
                    });
                });
            };
            const setError = (message) => {
                if (!message) {
                    errorEl.textContent = "";
                    errorEl.classList.add("hidden");
                    return;
                }

                errorEl.textContent = message;
                errorEl.classList.remove("hidden");
            };
            const mergeTimeline = (incoming) => {
                if (!Array.isArray(incoming) || incoming.length === 0) {
                    return;
                }

                const map = new Map(timeline.map((item) => [item.sequenceNumber, item]));
                incoming.forEach((item) => {
                    map.set(item.sequenceNumber, item);
                });
                timeline = Array.from(map.values()).sort((a, b) => a.sequenceNumber - b.sequenceNumber);
            };
            const renderJourneyBoard = () => {
                const boardEvents = timeline.slice(-maxBoardNodes);
                if (boardEvents.length === 0) {
                    boardTrackEl.innerHTML = `<div class="session-journey-empty">${escapeHtml(emptyMessage)}</div>`;
                    return;
                }

                boardTrackEl.innerHTML = boardEvents.map((item, index) => {
                    const laneClass = index % 2 === 0 ? "lane-top" : "lane-bottom";
                    const actorClass = `actor-${actorBucket(item.actorType).toLowerCase()}`;
                    const flowClass = `flow-${flowBucket(item.actionType)}`;
                    const dayTurnLabel = `${dayLabel} ${item.dayIndex + 1} | ${turnLabel} ${item.turnNumber}`;
                    const detailLabel = item.flowDescription || activityFallbackLabel;
                    return `
                        <article class="session-board-node ${laneClass} ${actorClass} ${flowClass}" data-seq="${item.sequenceNumber}">
                            <div class="session-board-node-head">
                                <span class="session-board-pin">${index + 1}</span>
                                <span class="session-board-seq">${escapeHtml(seqLabel)} ${item.sequenceNumber}</span>
                            </div>
                            <h4 class="session-board-title">${escapeHtml(actionLabel(item))}</h4>
                            <p class="session-board-subtitle">${escapeHtml(actorLabel(item))}</p>
                            <p class="session-board-meta">${escapeHtml(dayTurnLabel)} | ${escapeHtml(item.weekday || "-")}</p>
                            <p class="session-board-detail">${escapeHtml(detailLabel)}</p>
                        </article>`;
                }).join("");
            };
            const renderJourneyInsights = () => {
                if (!insightTotalEl || !insightDayTurnEl || !insightActorEl || !insightActionEl) {
                    return;
                }

                if (timeline.length === 0) {
                    insightTotalEl.textContent = "0";
                    insightDayTurnEl.textContent = "-";
                    insightActorEl.textContent = "-";
                    insightActionEl.textContent = "-";
                    return;
                }

                const latestItem = timeline[timeline.length - 1];
                insightTotalEl.textContent = `${timeline.length}`;
                insightDayTurnEl.textContent = `${dayLabel} ${latestItem.dayIndex + 1} | ${turnLabel} ${latestItem.turnNumber}`;
                insightActorEl.textContent = actorLabel(latestItem);
                insightActionEl.textContent = actionLabel(latestItem);
            };
            const renderAll = () => {
                renderJourneyBoard();
                renderJourneyInsights();
                bindJourneyInteractions();
                lastSequence = timeline.length > 0
                    ? Math.max(...timeline.map((item) => item.sequenceNumber))
                    : 0;
            };
            const syncTimeline = async () => {
                try {
                    const response = await fetch(`${timelineUrl}?fromSeq=${encodeURIComponent(lastSequence)}&limit=200`, {
                        method: "GET",
                        headers: { "Accept": "application/json" }
                    });

                    if (!response.ok) {
                        setError(realtimeStatusTemplate.replace("{status}", `${response.status}`));
                        return;
                    }

                    const data = await response.json();
                    const incomingTimeline = normalizeTimeline(data?.timeline);
                    mergeTimeline(incomingTimeline);
                    renderAll();
                    setError(data?.errorMessage || "");
                    syncedEl.textContent = formatDateTime(data?.lastSyncedAt ?? new Date().toISOString());
                } catch {
                    setError(realtimeNetworkMessage);
                }
            };
            const startPolling = () => {
                if (pollingTimerId !== null) {
                    return;
                }

                syncTimeline();
                pollingTimerId = setInterval(syncTimeline, pollIntervalMs);
            };
            const stopPolling = () => {
                if (pollingTimerId === null) {
                    return;
                }

                clearInterval(pollingTimerId);
                pollingTimerId = null;
            };
            const handleVisibility = () => {
                if (document.visibilityState === "visible") {
                    startPolling();
                    return;
                }

                stopPolling();
            };

            timeline = normalizeTimeline(initialTimelineRaw);
            renderAll();
            document.addEventListener("visibilitychange", handleVisibility);
            handleVisibility();
        })();
    </script>
}
