@model Cashflowpoly.Ui.Models.SessionDetailViewModel
@using System.Text.Json

@{
    ViewData["Title"] = Context.T("sessions.detail_title");
    var isInstructor = Context.Session.IsInstructor();
    var playerDisplayNames = Model.PlayerDisplayNames;
    var fallbackPlayerNames = new Dictionary<Guid, string>();
    var fallbackPlayerIndex = 1;
    var knownPlayerIds = (Model.Analytics?.ByPlayer.Select(item => item.PlayerId) ?? Enumerable.Empty<Guid>())
        .Concat(Model.Timeline.Where(item => item.PlayerId.HasValue).Select(item => item.PlayerId!.Value))
        .Distinct()
        .ToList();

    foreach (var playerId in knownPlayerIds)
    {
        if (playerDisplayNames.TryGetValue(playerId, out var displayName) && !string.IsNullOrWhiteSpace(displayName))
        {
            continue;
        }

        fallbackPlayerNames[playerId] = $"{Context.T("common.player")} {fallbackPlayerIndex}";
        fallbackPlayerIndex++;
    }

    string ResolvePlayerName(Guid playerId)
    {
        if (playerDisplayNames.TryGetValue(playerId, out var displayName) && !string.IsNullOrWhiteSpace(displayName))
        {
            return displayName;
        }

        if (fallbackPlayerNames.TryGetValue(playerId, out var fallbackName))
        {
            return fallbackName;
        }

        return Context.T("common.player");
    }

    string F(double value) => value.ToString("0.##");
}

<style>
    .session-board-node[data-seq],
    .session-journey-feed-item[data-seq] {
        cursor: pointer;
    }

    .session-board-node.is-focused {
        outline: 3px solid #2d7dd2;
        box-shadow: 0 14px 24px rgba(45, 125, 210, 0.26);
        transform: translateY(-4px);
    }

    .session-journey-feed-item.is-focused {
        border-color: #2d7dd2;
        box-shadow: 0 10px 20px rgba(45, 125, 210, 0.2);
    }

    .session-board-detail {
        margin-top: 0.35rem;
        font-size: 0.75rem;
        line-height: 1.35;
        color: #475569;
    }

    .session-journey-feed-detail {
        margin-top: 0.45rem;
        font-size: 0.75rem;
        line-height: 1.35;
        color: #475569;
    }
</style>

<section class="section-shell">
    <div class="ruleset-hero">
        <div>
            <p class="eyebrow text-emerald-700">@Context.T("sessions.analytics_title")</p>
            <h1 class="headline">@Context.T("sessions.detail_title")</h1>
            <p class="mt-2 text-xs text-slate-500 font-mono">@Model.SessionId</p>
        </div>
        <div class="ruleset-hero-meta">
            @if (!string.IsNullOrWhiteSpace(Model.SessionStatus))
            {
                var sessionStatusClass = string.Equals(Model.SessionStatus, "STARTED", StringComparison.OrdinalIgnoreCase)
                    ? "status-active"
                    : string.Equals(Model.SessionStatus, "CREATED", StringComparison.OrdinalIgnoreCase)
                        ? "status-draft"
                        : "status-retired";
                <span class="status-pill @sessionStatusClass">@Context.TSessionStatus(Model.SessionStatus)</span>
            }
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
    {
        <div class="mt-4 alert alert-error" aria-live="polite">
            @Model.ErrorMessage
        </div>
    }

    <div class="mt-6 metric-panel">
        <p class="eyebrow">@Context.T("sessions.active_ruleset.title")</p>
        @if (Model.Analytics?.RulesetId is Guid activeRulesetId)
        {
            <h2 class="text-xl font-semibold text-slate-900">
                @(string.IsNullOrWhiteSpace(Model.Analytics.RulesetName) ? Context.T("common.ruleset") : Model.Analytics.RulesetName)
            </h2>
            <p class="mt-1 text-xs font-mono text-slate-500">@activeRulesetId</p>
            <p class="mt-2 text-sm text-slate-600">@Context.T("sessions.active_ruleset.subtitle")</p>
            <div class="mt-3 action-toolbar">
                <a class="btn-ghost"
                   asp-controller="Rulesets"
                   asp-action="Details"
                   asp-route-rulesetId="@activeRulesetId">@Context.T("common.view")</a>
            </div>
        }
        else
        {
            <p class="mt-2 text-sm text-slate-600">@Context.T("sessions.active_ruleset.empty")</p>
        }
    </div>

    @if (Model.Analytics is not null)
    {
        var rankedPlayers = Model.Analytics.ByPlayer
            .OrderByDescending(item => item.HappinessPointsTotal)
            .ThenByDescending(item => item.CashInTotal - item.CashOutTotal)
            .ThenBy(item => item.JoinOrder > 0 ? item.JoinOrder : int.MaxValue)
            .ThenBy(item => item.PlayerId)
            .ToList();
        var playerRankLookup = rankedPlayers
            .Select((item, index) => new { item.PlayerId, Rank = index + 1 })
            .ToDictionary(item => item.PlayerId, item => item.Rank);
        var donationChampions = Model.Analytics.ByPlayer
            .OrderByDescending(item => item.DonationPointsTotal)
            .ThenByDescending(item => item.DonationTotal)
            .ThenBy(item => item.JoinOrder > 0 ? item.JoinOrder : int.MaxValue)
            .ThenBy(item => item.PlayerId)
            .Take(3)
            .ToList();
        var pensionChampions = Model.Analytics.ByPlayer
            .OrderByDescending(item => item.PensionPointsTotal)
            .ThenByDescending(item => item.SavingGoalPointsTotal)
            .ThenByDescending(item => item.CashInTotal - item.CashOutTotal)
            .ThenBy(item => item.JoinOrder > 0 ? item.JoinOrder : int.MaxValue)
            .ThenBy(item => item.PlayerId)
            .Take(3)
            .ToList();
        var hasCategoryChampions = donationChampions.Count > 0 || pensionChampions.Count > 0;

        <div class="mt-6 grid gap-4 md:grid-cols-5">
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("metric.total_event")</p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">@Model.Analytics.Summary.EventCount</p>
            </div>
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("metric.cash_in")</p>
                <p class="mt-2 text-2xl font-semibold text-emerald-700">@Model.Analytics.Summary.CashInTotal</p>
            </div>
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("metric.cash_out")</p>
                <p class="mt-2 text-2xl font-semibold text-rose-700">@Model.Analytics.Summary.CashOutTotal</p>
            </div>
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("metric.net_cashflow")</p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">@Model.Analytics.Summary.CashflowNetTotal</p>
            </div>
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("metric.violations")</p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">@Model.Analytics.Summary.RulesViolationsCount</p>
            </div>
        </div>

        @if (hasCategoryChampions)
        {
            <div class="mt-6 winner-card">
                <div class="winner-card-icon" aria-hidden="true">
                    <svg viewBox="0 0 120 120" role="presentation">
                        <circle cx="60" cy="60" r="52" fill="#fff4c2" />
                        <path d="M40 25h40v18c0 11-9 20-20 20s-20-9-20-20V25z" fill="#f59e0b" />
                        <path d="M45 63h30v12H45z" fill="#12a89a" />
                        <path d="M42 75h36v14H42z" fill="#0d857a" />
                        <circle cx="60" cy="43" r="9" fill="#fff" />
                        <circle cx="56" cy="41" r="2" fill="#1f3f5a" />
                        <circle cx="64" cy="41" r="2" fill="#1f3f5a" />
                        <path d="M54 48c2 3 4 4 6 4s4-1 6-4" fill="none" stroke="#1f3f5a" stroke-width="2.5" stroke-linecap="round" />
                    </svg>
                </div>
                <div class="w-full">
                    <p class="eyebrow">@Context.T("sessions.champion.title")</p>
                    <h2 class="text-2xl font-semibold text-slate-900">@Context.T("sessions.champion.subtitle")</h2>
                    <div class="mt-4 grid gap-3 md:grid-cols-2">
                        <article class="metric-panel">
                            <h3>@Context.T("sessions.champion.donation")</h3>
                            <div class="mt-3 winner-meta">
                                @for (var championIndex = 0; championIndex < donationChampions.Count; championIndex++)
                                {
                                    var item = donationChampions[championIndex];
                                    <span>
                                        @Context.T("sessions.rank_label") @(championIndex + 1): @ResolvePlayerName(item.PlayerId) |
                                        @Context.T("metric.donation_points"): @F(item.DonationPointsTotal) |
                                        @Context.T("metric.donation"): @F(item.DonationTotal)
                                    </span>
                                }
                            </div>
                        </article>
                        <article class="metric-panel">
                            <h3>@Context.T("sessions.champion.pension")</h3>
                            <div class="mt-3 winner-meta">
                                @for (var championIndex = 0; championIndex < pensionChampions.Count; championIndex++)
                                {
                                    var item = pensionChampions[championIndex];
                                    <span>
                                        @Context.T("sessions.rank_label") @(championIndex + 1): @ResolvePlayerName(item.PlayerId) |
                                        @Context.T("metric.pension_points"): @F(item.PensionPointsTotal) |
                                        @Context.T("metric.saving_goal"): @F(item.SavingGoalPointsTotal)
                                    </span>
                                }
                            </div>
                        </article>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="mt-6 alert alert-info">@Context.T("sessions.champion.none")</div>
        }

        @if (isInstructor)
        {
            <div class="mt-6 action-toolbar">
                <a class="btn-ghost"
                   asp-controller="Sessions" asp-action="Ruleset" asp-route-sessionId="@Model.SessionId">@Context.T("sessions.activate_ruleset")</a>
            </div>
        }

        <div class="mt-8 table-wrap">
            <table class="w-full text-left text-sm mobile-card-table">
                <thead class="table-head">
                    <tr>
                        <th class="px-4 py-3 text-right">@Context.T("common.turn_order")</th>
                        <th class="px-4 py-3 text-right">@Context.T("common.rank")</th>
                        <th class="px-4 py-3">@Context.T("common.name")</th>
                        <th class="px-4 py-3 text-right">@Context.T("metric.cash_in")</th>
                        <th class="px-4 py-3 text-right">@Context.T("metric.cash_out")</th>
                        <th class="px-4 py-3 text-right">@Context.T("metric.donation")</th>
                        <th class="px-4 py-3 text-right">@Context.T("metric.donation_points")</th>
                        <th class="px-4 py-3 text-right">@Context.T("metric.pension_points")</th>
                        <th class="px-4 py-3 text-right">@Context.T("metric.gold_qty")</th>
                        <th class="px-4 py-3 text-right">@Context.T("metric.happiness")</th>
                        <th class="px-4 py-3 text-right">@Context.T("common.detail")</th>
                    </tr>
                </thead>
                <tbody>
                @if (Model.Analytics.ByPlayer.Count == 0)
                {
                    <tr>
                        <td class="px-4 py-4 text-slate-500 mobile-card-empty" colspan="11">@Context.T("state.no_player_data")</td>
                    </tr>
                }
                else
                {
                    foreach (var item in Model.Analytics.ByPlayer)
                    {
                        var rank = playerRankLookup.TryGetValue(item.PlayerId, out var resolvedRank)
                            ? resolvedRank
                            : 0;
                        var winnerRowClass = rank == 1
                            ? "winner-row"
                            : string.Empty;
                        <tr class="border-t border-slate-200 @winnerRowClass">
                            <td class="px-4 py-3 text-right text-slate-700" data-label="@Context.T("common.turn_order")">@(item.JoinOrder > 0 ? item.JoinOrder : "-")</td>
                            <td class="px-4 py-3 text-right text-slate-700" data-label="@Context.T("common.rank")">@(rank > 0 ? rank : "-")</td>
                            <td class="px-4 py-3 text-slate-700" data-label="@Context.T("common.name")">
                                @ResolvePlayerName(item.PlayerId)
                                @if (rank > 0 && rank <= 3)
                                {
                                    <span class="winner-chip">@Context.T("sessions.rank_label") @rank</span>
                                }
                            </td>
                            <td class="px-4 py-3 text-right" data-label="@Context.T("metric.cash_in")">@item.CashInTotal</td>
                            <td class="px-4 py-3 text-right" data-label="@Context.T("metric.cash_out")">@item.CashOutTotal</td>
                            <td class="px-4 py-3 text-right" data-label="@Context.T("metric.donation")">@item.DonationTotal</td>
                            <td class="px-4 py-3 text-right" data-label="@Context.T("metric.donation_points")">@F(item.DonationPointsTotal)</td>
                            <td class="px-4 py-3 text-right" data-label="@Context.T("metric.pension_points")">@F(item.PensionPointsTotal)</td>
                            <td class="px-4 py-3 text-right" data-label="@Context.T("metric.gold_qty")">@item.GoldQty</td>
                            <td class="px-4 py-3 text-right" data-label="@Context.T("metric.happiness")">@item.HappinessPointsTotal</td>
                            <td class="px-4 py-3 text-right" data-label="@Context.T("common.detail")">
                                <a class="table-link"
                                   asp-controller="Players" asp-action="Details" asp-route-sessionId="@Model.SessionId"
                                   asp-route-playerId="@item.PlayerId">@Context.T("common.view")</a>
                            </td>
                        </tr>
                    }
                }
                </tbody>
            </table>
        </div>

    }

    <div class="mt-8 session-journey-shell">
        <div class="session-journey-head">
            <div>
                <p class="eyebrow">@Context.T("sessions.timeline")</p>
                <h2 class="text-2xl font-semibold text-slate-900">@Context.T("sessions.timeline_title")</h2>
                <p class="subhead">@Context.T("sessions.timeline_subtitle")</p>
                <p class="mt-2 text-sm text-slate-600">@Context.T("sessions.journey.board_subtitle")</p>
            </div>
            <div class="session-journey-sync">
                <span>@Context.T("sessions.journey.last_sync")</span>
                <strong id="session-journey-synced">@DateTimeOffset.Now.ToLocalTime().ToString("dd/MM/yyyy HH:mm:ss")</strong>
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(Model.TimelineErrorMessage))
        {
            <div id="session-journey-error" class="mt-4 alert alert-warning" aria-live="polite">
                @Model.TimelineErrorMessage
            </div>
        }
        else
        {
            <div id="session-journey-error" class="mt-4 alert alert-warning hidden" aria-live="polite"></div>
        }

        <div class="session-board-wrap">
            <div id="session-board-track" class="session-board-track"></div>
        </div>

        <div class="session-journey-legend">
            <span class="session-journey-legend-item actor-player">@Context.T("sessions.actor.player")</span>
            <span class="session-journey-legend-item actor-system">@Context.T("sessions.actor.system")</span>
            <span class="session-journey-legend-item actor-instructor">@Context.T("sessions.actor.instructor")</span>
            <span class="session-journey-legend-item actor-other">@Context.T("sessions.actor.other")</span>
        </div>

        <div class="mt-5 chart-card">
            <h3 class="chart-title">@Context.T("sessions.journey.graph_title")</h3>
            <p class="text-sm text-slate-600">@Context.T("sessions.journey.graph_subtitle")</p>
            <canvas id="session-journey-graph" height="120"></canvas>
            <p id="session-journey-graph-fallback" class="mt-2 hidden text-sm text-slate-500"></p>
        </div>

        <div class="mt-5">
            <h3 class="chart-title">@Context.T("sessions.journey.latest_activity")</h3>
            <ol id="session-journey-feed" class="session-journey-feed"></ol>
        </div>
    </div>
</section>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
    <script>
        (() => {
            const boardTrackEl = document.getElementById("session-board-track");
            const feedEl = document.getElementById("session-journey-feed");
            const errorEl = document.getElementById("session-journey-error");
            const syncedEl = document.getElementById("session-journey-synced");
            const graphCanvas = document.getElementById("session-journey-graph");
            const graphFallbackEl = document.getElementById("session-journey-graph-fallback");
            if (!boardTrackEl || !feedEl || !errorEl || !syncedEl) {
                return;
            }

            const timelineUrl = "@Url.Action("Timeline", "Sessions", new { sessionId = Model.SessionId })";
            const activeLanguage = @Html.Raw(JsonSerializer.Serialize(UiText.NormalizeLanguage(Context.Session.GetString(AuthConstants.SessionLanguageKey))));
            const browserLocale = activeLanguage === "en" ? "en-US" : "id-ID";
            const emptyMessage = @Html.Raw(JsonSerializer.Serialize(Context.T("sessions.journey.no_events")));
            const realtimeStatusTemplate = @Html.Raw(JsonSerializer.Serialize(Context.T("sessions.journey.realtime_status")));
            const realtimeNetworkMessage = @Html.Raw(JsonSerializer.Serialize(Context.T("sessions.journey.realtime_network")));
            const graphUnavailableMessage = @Html.Raw(JsonSerializer.Serialize(Context.T("sessions.journey.graph_unavailable")));
            const graphEmptyMessage = @Html.Raw(JsonSerializer.Serialize(Context.T("sessions.journey.graph_empty")));
            const graphAxisSequence = @Html.Raw(JsonSerializer.Serialize(Context.T("sessions.journey.graph_axis_seq")));
            const graphAxisOrder = @Html.Raw(JsonSerializer.Serialize(Context.T("sessions.journey.graph_axis_order")));
            const activityFallbackLabel = @Html.Raw(JsonSerializer.Serialize(Context.T("sessions.activity_default")));
            const dayLabel = @Html.Raw(JsonSerializer.Serialize(Context.T("sessions.day_label")));
            const turnLabel = @Html.Raw(JsonSerializer.Serialize(Context.T("sessions.turn_label")));
            const seqLabel = @Html.Raw(JsonSerializer.Serialize(Context.T("sessions.timeline_seq")));
            const actorLabels = {
                PLAYER: @Html.Raw(JsonSerializer.Serialize(Context.T("sessions.actor.player"))),
                SYSTEM: @Html.Raw(JsonSerializer.Serialize(Context.T("sessions.actor.system"))),
                INSTRUCTOR: @Html.Raw(JsonSerializer.Serialize(Context.T("sessions.actor.instructor"))),
                OTHER: @Html.Raw(JsonSerializer.Serialize(Context.T("sessions.actor.other")))
            };
            const playerLookupRaw = @Html.Raw(JsonSerializer.Serialize(Model.PlayerDisplayNames));
            const initialTimelineRaw = @Html.Raw(JsonSerializer.Serialize(Model.Timeline));
            const pollIntervalMs = 10000;
            const maxBoardNodes = 24;
            const maxFeedItems = 16;
            const maxGraphPoints = 40;

            const playerLookup = Object.fromEntries(
                Object.entries(playerLookupRaw ?? {}).map(([key, value]) => [String(key).toLowerCase(), value])
            );
            let timeline = [];
            let pollingTimerId = null;
            let lastSequence = 0;
            let journeyGraph = null;

            const hasOwn = (obj, key) => Object.prototype.hasOwnProperty.call(obj, key);
            const toNumber = (value, fallback = 0) => {
                const numericValue = Number(value);
                return Number.isFinite(numericValue) ? numericValue : fallback;
            };
            const readValue = (obj, camelKey, pascalKey) => {
                if (!obj || typeof obj !== "object") {
                    return undefined;
                }

                if (hasOwn(obj, camelKey)) {
                    return obj[camelKey];
                }

                if (hasOwn(obj, pascalKey)) {
                    return obj[pascalKey];
                }

                return undefined;
            };
            const escapeHtml = (text) =>
                String(text ?? "")
                    .replaceAll("&", "&amp;")
                    .replaceAll("<", "&lt;")
                    .replaceAll(">", "&gt;")
                    .replaceAll("\"", "&quot;")
                    .replaceAll("'", "&#39;");
            const actorBucket = (actorType) => {
                const normalized = String(actorType ?? "").toUpperCase();
                return normalized === "PLAYER" || normalized === "SYSTEM" || normalized === "INSTRUCTOR"
                    ? normalized
                    : "OTHER";
            };
            const flowBucket = (actionType) => {
                const normalized = String(actionType ?? "").toLowerCase();
                if (normalized.startsWith("setup.")) return "setup";
                if (normalized.startsWith("day.")) return "day";
                if (normalized.startsWith("risk.")) return "risk";
                if (normalized.startsWith("loan.")) return "loan";
                if (normalized.startsWith("saving.")) return "saving";
                if (normalized.startsWith("mission.")) return "mission";
                if (normalized.includes("order")) return "order";
                return "generic";
            };
            const actorLabel = (item) => {
                const bucket = actorBucket(item.actorType);
                if (bucket === "PLAYER") {
                    if (item.playerDisplayName) {
                        return item.playerDisplayName;
                    }
                    const lookupName = playerLookup[String(item.playerId ?? "").toLowerCase()];
                    return lookupName || actorLabels.PLAYER;
                }

                if (bucket === "SYSTEM") return actorLabels.SYSTEM;
                if (bucket === "INSTRUCTOR") return actorLabels.INSTRUCTOR;
                return actorLabels.OTHER;
            };
            const actionLabel = (item) => item.flowLabel || item.actionType || activityFallbackLabel;
            const normalizeTimeline = (rawTimeline) => {
                if (!Array.isArray(rawTimeline)) {
                    return [];
                }

                return rawTimeline
                    .map((item) => {
                        const sequenceNumber = toNumber(readValue(item, "sequenceNumber", "SequenceNumber"), 0);
                        return {
                            timestamp: readValue(item, "timestamp", "Timestamp"),
                            sequenceNumber,
                            dayIndex: toNumber(readValue(item, "dayIndex", "DayIndex"), 0),
                            weekday: String(readValue(item, "weekday", "Weekday") ?? ""),
                            turnNumber: Math.max(1, toNumber(readValue(item, "turnNumber", "TurnNumber"), 1)),
                            actorType: String(readValue(item, "actorType", "ActorType") ?? ""),
                            playerId: readValue(item, "playerId", "PlayerId"),
                            playerDisplayName: readValue(item, "playerDisplayName", "PlayerDisplayName"),
                            actionType: String(readValue(item, "actionType", "ActionType") ?? ""),
                            flowLabel: String(readValue(item, "flowLabel", "FlowLabel") ?? ""),
                            flowDescription: String(readValue(item, "flowDescription", "FlowDescription") ?? "")
                        };
                    })
                    .filter((item) => item.sequenceNumber > 0)
                    .sort((a, b) => {
                        if (a.sequenceNumber !== b.sequenceNumber) {
                            return a.sequenceNumber - b.sequenceNumber;
                        }

                        return String(a.timestamp ?? "").localeCompare(String(b.timestamp ?? ""));
                    });
            };
            const formatDateTime = (rawValue) => {
                const dt = new Date(rawValue);
                if (Number.isNaN(dt.getTime())) {
                    return "-";
                }

                return dt.toLocaleString(browserLocale, {
                    day: "2-digit",
                    month: "2-digit",
                    year: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                    second: "2-digit"
                });
            };
            const setGraphFallback = (message) => {
                if (!graphFallbackEl || !graphCanvas) {
                    return;
                }

                if (!message) {
                    graphFallbackEl.textContent = "";
                    graphFallbackEl.classList.add("hidden");
                    graphCanvas.classList.remove("hidden");
                    return;
                }

                graphFallbackEl.textContent = message;
                graphFallbackEl.classList.remove("hidden");
                graphCanvas.classList.add("hidden");
            };
            const clearFocusedItems = () => {
                boardTrackEl.querySelectorAll(".session-board-node.is-focused").forEach((node) => {
                    node.classList.remove("is-focused");
                });
                feedEl.querySelectorAll(".session-journey-feed-item.is-focused").forEach((node) => {
                    node.classList.remove("is-focused");
                });
            };
            const focusBySequence = (sequenceNumber) => {
                const normalizedSeq = toNumber(sequenceNumber, 0);
                if (normalizedSeq <= 0) {
                    return;
                }

                clearFocusedItems();
                const boardNode = boardTrackEl.querySelector(`.session-board-node[data-seq="${normalizedSeq}"]`);
                const feedNode = feedEl.querySelector(`.session-journey-feed-item[data-seq="${normalizedSeq}"]`);

                if (boardNode) {
                    boardNode.classList.add("is-focused");
                    boardNode.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "center" });
                }

                if (feedNode) {
                    feedNode.classList.add("is-focused");
                    feedNode.scrollIntoView({ behavior: "smooth", block: "nearest" });
                }
            };
            const bindJourneyInteractions = () => {
                boardTrackEl.querySelectorAll(".session-board-node[data-seq]").forEach((node) => {
                    node.addEventListener("click", () => {
                        focusBySequence(node.getAttribute("data-seq"));
                    });
                });
                feedEl.querySelectorAll(".session-journey-feed-item[data-seq]").forEach((node) => {
                    node.addEventListener("click", () => {
                        focusBySequence(node.getAttribute("data-seq"));
                    });
                });
            };
            const setError = (message) => {
                if (!message) {
                    errorEl.textContent = "";
                    errorEl.classList.add("hidden");
                    return;
                }

                errorEl.textContent = message;
                errorEl.classList.remove("hidden");
            };
            const mergeTimeline = (incoming) => {
                if (!Array.isArray(incoming) || incoming.length === 0) {
                    return;
                }

                const map = new Map(timeline.map((item) => [item.sequenceNumber, item]));
                incoming.forEach((item) => {
                    map.set(item.sequenceNumber, item);
                });
                timeline = Array.from(map.values()).sort((a, b) => a.sequenceNumber - b.sequenceNumber);
            };
            const renderJourneyBoard = () => {
                const boardEvents = timeline.slice(-maxBoardNodes);
                if (boardEvents.length === 0) {
                    boardTrackEl.innerHTML = `<div class="session-journey-empty">${escapeHtml(emptyMessage)}</div>`;
                    return;
                }

                boardTrackEl.innerHTML = boardEvents.map((item, index) => {
                    const laneClass = index % 2 === 0 ? "lane-top" : "lane-bottom";
                    const actorClass = `actor-${actorBucket(item.actorType).toLowerCase()}`;
                    const flowClass = `flow-${flowBucket(item.actionType)}`;
                    const dayTurnLabel = `${dayLabel} ${item.dayIndex + 1} | ${turnLabel} ${item.turnNumber}`;
                    const detailLabel = item.flowDescription || activityFallbackLabel;
                    return `
                        <article class="session-board-node ${laneClass} ${actorClass} ${flowClass}" data-seq="${item.sequenceNumber}">
                            <div class="session-board-node-head">
                                <span class="session-board-pin">${index + 1}</span>
                                <span class="session-board-seq">${escapeHtml(seqLabel)} ${item.sequenceNumber}</span>
                            </div>
                            <h4 class="session-board-title">${escapeHtml(actionLabel(item))}</h4>
                            <p class="session-board-subtitle">${escapeHtml(actorLabel(item))}</p>
                            <p class="session-board-meta">${escapeHtml(dayTurnLabel)} | ${escapeHtml(item.weekday || "-")}</p>
                            <p class="session-board-detail">${escapeHtml(detailLabel)}</p>
                        </article>`;
                }).join("");
            };
            const renderJourneyFeed = () => {
                const feedEvents = [...timeline].slice(-maxFeedItems).reverse();
                if (feedEvents.length === 0) {
                    feedEl.innerHTML = `<li class="session-journey-empty">${escapeHtml(emptyMessage)}</li>`;
                    return;
                }

                feedEl.innerHTML = feedEvents.map((item) => `
                    <li class="session-journey-feed-item" data-seq="${item.sequenceNumber}">
                        <div class="session-journey-feed-head">
                            <span class="session-journey-feed-seq">${escapeHtml(seqLabel)} ${item.sequenceNumber}</span>
                            <span class="session-journey-feed-time">${escapeHtml(formatDateTime(item.timestamp))}</span>
                        </div>
                        <p class="session-journey-feed-title">${escapeHtml(actionLabel(item))}</p>
                        <p class="session-journey-feed-subtitle">${escapeHtml(actorLabel(item))} | ${dayLabel} ${item.dayIndex + 1} | ${turnLabel} ${item.turnNumber}</p>
                        <p class="session-journey-feed-detail">${escapeHtml(item.flowDescription || activityFallbackLabel)}</p>
                    </li>`).join("");
            };
            const renderJourneyGraph = () => {
                if (!graphCanvas) {
                    return;
                }

                if (typeof Chart === "undefined") {
                    if (journeyGraph) {
                        journeyGraph.destroy();
                        journeyGraph = null;
                    }
                    setGraphFallback(graphUnavailableMessage);
                    return;
                }

                const playerMovements = timeline.filter((item) => actorBucket(item.actorType) === "PLAYER");
                const graphEvents = (playerMovements.length > 0 ? playerMovements : timeline).slice(-maxGraphPoints);
                if (graphEvents.length === 0) {
                    if (journeyGraph) {
                        journeyGraph.destroy();
                        journeyGraph = null;
                    }
                    setGraphFallback(graphEmptyMessage);
                    return;
                }

                setGraphFallback("");
                const graphLabels = graphEvents.map((item) => `${seqLabel} ${item.sequenceNumber}`);
                const graphPoints = graphEvents.map((item, index) => ({
                    y: index + 1,
                    sequenceNumber: item.sequenceNumber,
                    actor: actorLabel(item),
                    action: actionLabel(item),
                    timestamp: item.timestamp,
                    dayIndex: item.dayIndex,
                    turnNumber: item.turnNumber
                }));

                if (journeyGraph) {
                    journeyGraph.destroy();
                }

                journeyGraph = new Chart(graphCanvas, {
                    type: "line",
                    data: {
                        labels: graphLabels,
                        datasets: [{
                            label: graphAxisOrder,
                            data: graphPoints.map((item) => item.y),
                            borderColor: "#2d7dd2",
                            backgroundColor: "rgba(45, 125, 210, 0.14)",
                            pointBackgroundColor: "#2d7dd2",
                            pointBorderColor: "#ffffff",
                            pointBorderWidth: 1.2,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            borderWidth: 2,
                            fill: true,
                            tension: 0.2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2.2,
                        interaction: {
                            mode: "nearest",
                            intersect: true
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: graphAxisSequence
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: graphAxisOrder
                                },
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    title: (items) => {
                                        const index = items[0].dataIndex;
                                        const entry = graphPoints[index];
                                        return `${graphLabels[index]} | ${formatDateTime(entry.timestamp)}`;
                                    },
                                    label: (ctx) => {
                                        const entry = graphPoints[ctx.dataIndex];
                                        return `${entry.actor} | ${dayLabel} ${entry.dayIndex + 1} | ${turnLabel} ${entry.turnNumber} | ${entry.action}`;
                                    }
                                }
                            }
                        },
                        onClick: (_, elements) => {
                            if (!Array.isArray(elements) || elements.length === 0) {
                                return;
                            }

                            const index = elements[0].index;
                            focusBySequence(graphPoints[index]?.sequenceNumber);
                        }
                    }
                });
            };
            const renderAll = () => {
                renderJourneyBoard();
                renderJourneyFeed();
                renderJourneyGraph();
                bindJourneyInteractions();
                lastSequence = timeline.length > 0
                    ? Math.max(...timeline.map((item) => item.sequenceNumber))
                    : 0;
            };
            const syncTimeline = async () => {
                try {
                    const response = await fetch(`${timelineUrl}?fromSeq=${encodeURIComponent(lastSequence)}&limit=200`, {
                        method: "GET",
                        headers: { "Accept": "application/json" }
                    });

                    if (!response.ok) {
                        setError(realtimeStatusTemplate.replace("{status}", `${response.status}`));
                        return;
                    }

                    const data = await response.json();
                    const incomingTimeline = normalizeTimeline(data?.timeline);
                    mergeTimeline(incomingTimeline);
                    renderAll();
                    setError(data?.errorMessage || "");
                    syncedEl.textContent = formatDateTime(data?.lastSyncedAt ?? new Date().toISOString());
                } catch {
                    setError(realtimeNetworkMessage);
                }
            };
            const startPolling = () => {
                if (pollingTimerId !== null) {
                    return;
                }

                syncTimeline();
                pollingTimerId = setInterval(syncTimeline, pollIntervalMs);
            };
            const stopPolling = () => {
                if (pollingTimerId === null) {
                    return;
                }

                clearInterval(pollingTimerId);
                pollingTimerId = null;
            };
            const handleVisibility = () => {
                if (document.visibilityState === "visible") {
                    startPolling();
                    return;
                }

                stopPolling();
            };

            timeline = normalizeTimeline(initialTimelineRaw);
            renderAll();
            document.addEventListener("visibilitychange", handleVisibility);
            handleVisibility();
        })();
    </script>
}
