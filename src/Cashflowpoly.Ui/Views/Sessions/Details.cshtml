@* Fungsi file: Merender tampilan Razor untuk bagian Sessions/Details.cshtml beserta interaksi presentasinya. *@
@model Cashflowpoly.Ui.Models.SessionDetailViewModel
@{
    ViewData["Title"] = Context.T("sessions.detail_title");
    var isInstructor = Context.Session.IsInstructor();
    var playerDisplayNames = Model.PlayerDisplayNames;
    var fallbackPlayerNames = new Dictionary<Guid, string>();
    var fallbackPlayerIndex = 1;
    var knownPlayerIds = (Model.Analytics?.ByPlayer.Select(item => item.PlayerId) ?? Enumerable.Empty<Guid>())
        .Concat(Model.Timeline.Where(item => item.PlayerId.HasValue).Select(item => item.PlayerId!.Value))
        .Distinct()
        .ToList();

    foreach (var playerId in knownPlayerIds)
    {
        if (playerDisplayNames.TryGetValue(playerId, out var displayName) && !string.IsNullOrWhiteSpace(displayName))
        {
            continue;
        }

        fallbackPlayerNames[playerId] = $"{Context.T("common.player")} {fallbackPlayerIndex}";
        fallbackPlayerIndex++;
    }

    string ResolvePlayerName(Guid playerId)
    {
        if (playerDisplayNames.TryGetValue(playerId, out var displayName) && !string.IsNullOrWhiteSpace(displayName))
        {
            return displayName;
        }

        if (fallbackPlayerNames.TryGetValue(playerId, out var fallbackName))
        {
            return fallbackName;
        }

        return Context.T("common.player");
    }

    string F(double value) => value.ToString("0.##");
}

<style>
    .session-board-node[data-seq] {
        cursor: pointer;
    }

    .session-board-node.is-focused {
        outline: 3px solid #2d7dd2;
        box-shadow: 0 14px 24px rgba(45, 125, 210, 0.26);
        transform: translateY(-4px);
    }

    .session-journey-title {
        max-width: 18ch;
        line-height: 1.15;
        text-wrap: balance;
    }

    .session-board-node {
        grid-template-rows: auto auto auto auto minmax(0, 1fr);
        min-height: 10.4rem;
    }

    .session-board-detail {
        margin-top: 0.35rem;
        font-size: 0.75rem;
        line-height: 1.35;
        color: #475569;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 3;
        overflow: hidden;
    }

    .session-board-title {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
        overflow: hidden;
    }

    .session-journey-insight-grid {
        margin-top: 0.8rem;
        display: grid;
        gap: 0.65rem;
        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
    }

    .session-journey-insight-card {
        border: 1px solid #a8e5de;
        border-radius: 0.85rem;
        background: rgba(255, 255, 255, 0.9);
        padding: 0.62rem 0.7rem;
        min-width: 0;
        min-height: 4.45rem;
        display: grid;
        align-content: start;
    }

    .session-journey-insight-label {
        margin: 0;
        font-size: 0.68rem;
        letter-spacing: 0.07em;
        text-transform: uppercase;
        color: #547286;
        font-weight: 800;
    }

    .session-journey-insight-value {
        margin: 0.32rem 0 0;
        color: #15394f;
        font-size: 0.92rem;
        font-weight: 800;
        line-height: 1.25;
    }

    @@media (max-width: 640px) {
        .session-journey-title {
            max-width: none;
        }

        .session-board-node {
            min-height: 9.2rem;
        }

        .session-journey-insight-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .session-journey-insight-card:last-child {
            grid-column: 1 / -1;
        }
    }
</style>

<section class="section-shell">
    <div class="ruleset-hero">
        <div>
            <p class="eyebrow text-emerald-700">@Context.T("sessions.analytics_title")</p>
            <h1 class="headline">@Context.T("sessions.detail_title")</h1>
            <p class="mt-2 text-xs text-slate-500 font-mono">@Model.SessionId</p>
        </div>
        <div class="ruleset-hero-meta">
            @if (!string.IsNullOrWhiteSpace(Model.SessionStatus))
            {
                var sessionStatusClass = string.Equals(Model.SessionStatus, "STARTED", StringComparison.OrdinalIgnoreCase)
                    ? "status-active"
                    : string.Equals(Model.SessionStatus, "CREATED", StringComparison.OrdinalIgnoreCase)
                        ? "status-draft"
                        : "status-retired";
                <span class="status-pill @sessionStatusClass">@Context.TSessionStatus(Model.SessionStatus)</span>
            }
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
    {
        <div class="mt-4 alert alert-error" aria-live="polite">
            @Model.ErrorMessage
        </div>
    }

    <details class="mt-4 data-toggle">
        <summary>@(isInstructor ? Context.T("analytics.tips.instructor") : Context.T("analytics.tips.player"))</summary>
        <div class="mt-3 metric-panel">
            <div class="metric-list">
                @if (isInstructor)
                {
                    <div class="metric-row"><span class="metric-key">@Context.T("analytics.tip_key.input")</span><span class="metric-value">@Context.T("analytics.tip.input")</span></div>
                    <div class="metric-row"><span class="metric-key">@Context.T("analytics.tip_key.interpretation")</span><span class="metric-value">@Context.T("analytics.tip.interpretation")</span></div>
                    <div class="metric-row"><span class="metric-key">@Context.T("analytics.tip_key.followup")</span><span class="metric-value">@Context.T("analytics.tip.followup")</span></div>
                }
                else
                {
                    <div class="metric-row"><span class="metric-key">@Context.T("analytics.tip_key.select_session")</span><span class="metric-value">@Context.T("analytics.tip.select_session")</span></div>
                    <div class="metric-row"><span class="metric-key">@Context.T("analytics.tip_key.focus_score")</span><span class="metric-value">@Context.T("analytics.tip.focus_score")</span></div>
                    <div class="metric-row"><span class="metric-key">@Context.T("analytics.tip_key.risk_control")</span><span class="metric-value">@Context.T("analytics.tip.risk_control")</span></div>
                }
            </div>
        </div>
    </details>

    <div class="mt-6 metric-panel">
        <p class="eyebrow">@Context.T("sessions.active_ruleset.title")</p>
        @if (Model.Analytics?.RulesetId is Guid activeRulesetId)
        {
            <h2 class="text-xl font-semibold text-slate-900">
                @(string.IsNullOrWhiteSpace(Model.Analytics.RulesetName) ? Context.T("common.ruleset") : Model.Analytics.RulesetName)
            </h2>
            <p class="mt-1 text-xs font-mono text-slate-500">@activeRulesetId</p>
            <p class="mt-2 text-sm text-slate-600">@Context.T("sessions.active_ruleset.subtitle")</p>
            <div class="mt-3 action-toolbar">
                <a class="btn-ghost"
                   asp-controller="Rulesets"
                   asp-action="Details"
                   asp-route-rulesetId="@activeRulesetId">@Context.T("common.view")</a>
                @if (isInstructor)
                {
                    <a class="btn-primary"
                       asp-controller="Sessions"
                       asp-action="Ruleset"
                       asp-route-sessionId="@Model.SessionId">@Context.T("sessions.activate_ruleset")</a>
                }
            </div>
        }
        else
        {
            <p class="mt-2 text-sm text-slate-600">@Context.T("sessions.active_ruleset.empty")</p>
            @if (isInstructor)
            {
                <div class="mt-3 action-toolbar">
                    <a class="btn-primary"
                       asp-controller="Sessions"
                       asp-action="Ruleset"
                       asp-route-sessionId="@Model.SessionId">@Context.T("sessions.activate_ruleset")</a>
                </div>
            }
        }
    </div>

    @if (Model.Analytics is not null)
    {
        var rankedPlayers = Model.Analytics.ByPlayer
            .OrderByDescending(item => item.HappinessPointsTotal)
            .ThenByDescending(item => item.CashInTotal - item.CashOutTotal)
            .ThenBy(item => item.JoinOrder > 0 ? item.JoinOrder : int.MaxValue)
            .ThenBy(item => item.PlayerId)
            .ToList();
        var playerRankLookup = rankedPlayers
            .Select((item, index) => new { item.PlayerId, Rank = index + 1 })
            .ToDictionary(item => item.PlayerId, item => item.Rank);
        var donationChampions = Model.Analytics.ByPlayer
            .OrderByDescending(item => item.DonationPointsTotal)
            .ThenByDescending(item => item.DonationTotal)
            .ThenBy(item => item.JoinOrder > 0 ? item.JoinOrder : int.MaxValue)
            .ThenBy(item => item.PlayerId)
            .Take(3)
            .ToList();
        var pensionChampions = Model.Analytics.ByPlayer
            .OrderByDescending(item => item.PensionPointsTotal)
            .ThenByDescending(item => item.SavingGoalPointsTotal)
            .ThenByDescending(item => item.CashInTotal - item.CashOutTotal)
            .ThenBy(item => item.JoinOrder > 0 ? item.JoinOrder : int.MaxValue)
            .ThenBy(item => item.PlayerId)
            .Take(3)
            .ToList();
        var hasCategoryChampions = donationChampions.Count > 0 || pensionChampions.Count > 0;

        <div class="mt-6 grid gap-4 md:grid-cols-5">
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("metric.total_event")</p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">@Model.Analytics.Summary.EventCount</p>
            </div>
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("metric.cash_in")</p>
                <p class="mt-2 text-2xl font-semibold text-emerald-700">@Model.Analytics.Summary.CashInTotal</p>
            </div>
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("metric.cash_out")</p>
                <p class="mt-2 text-2xl font-semibold text-rose-700">@Model.Analytics.Summary.CashOutTotal</p>
            </div>
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("metric.net_cashflow")</p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">@Model.Analytics.Summary.CashflowNetTotal</p>
            </div>
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("metric.violations")</p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">@Model.Analytics.Summary.RulesViolationsCount</p>
            </div>
        </div>

        @if (hasCategoryChampions)
        {
            <div class="mt-6 winner-card">
                <div class="winner-card-icon" aria-hidden="true">
                    <svg viewBox="0 0 120 120" role="presentation">
                        <circle cx="60" cy="60" r="52" fill="#fff4c2" />
                        <path d="M40 25h40v18c0 11-9 20-20 20s-20-9-20-20V25z" fill="#f59e0b" />
                        <path d="M45 63h30v12H45z" fill="#12a89a" />
                        <path d="M42 75h36v14H42z" fill="#0d857a" />
                        <circle cx="60" cy="43" r="9" fill="#fff" />
                        <circle cx="56" cy="41" r="2" fill="#1f3f5a" />
                        <circle cx="64" cy="41" r="2" fill="#1f3f5a" />
                        <path d="M54 48c2 3 4 4 6 4s4-1 6-4" fill="none" stroke="#1f3f5a" stroke-width="2.5" stroke-linecap="round" />
                    </svg>
                </div>
                <div class="w-full">
                    <p class="eyebrow">@Context.T("sessions.champion.title")</p>
                    <h2 class="text-2xl font-semibold text-slate-900">@Context.T("sessions.champion.subtitle")</h2>
                    <div class="mt-4 grid gap-3 md:grid-cols-2">
                        <article class="metric-panel">
                            <h3>@Context.T("sessions.champion.donation")</h3>
                            <div class="mt-3 winner-meta">
                                @for (var championIndex = 0; championIndex < donationChampions.Count; championIndex++)
                                {
                                    var item = donationChampions[championIndex];
                                    <span>
                                        @Context.T("sessions.rank_label") @(championIndex + 1): @ResolvePlayerName(item.PlayerId) |
                                        @Context.T("metric.donation_points"): @F(item.DonationPointsTotal) |
                                        @Context.T("metric.donation"): @F(item.DonationTotal)
                                    </span>
                                }
                            </div>
                        </article>
                        <article class="metric-panel">
                            <h3>@Context.T("sessions.champion.pension")</h3>
                            <div class="mt-3 winner-meta">
                                @for (var championIndex = 0; championIndex < pensionChampions.Count; championIndex++)
                                {
                                    var item = pensionChampions[championIndex];
                                    <span>
                                        @Context.T("sessions.rank_label") @(championIndex + 1): @ResolvePlayerName(item.PlayerId) |
                                        @Context.T("metric.pension_points"): @F(item.PensionPointsTotal) |
                                        @Context.T("metric.saving_goal"): @F(item.SavingGoalPointsTotal)
                                    </span>
                                }
                            </div>
                        </article>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="mt-6 alert alert-info">@Context.T("sessions.champion.none")</div>
        }

        <div class="mt-8 table-wrap">
            <table class="w-full text-left text-sm mobile-card-table">
                <thead class="table-head">
                    <tr>
                        <th class="px-4 py-3 text-right">@Context.T("common.turn_order")</th>
                        <th class="px-4 py-3 text-right">@Context.T("common.rank")</th>
                        <th class="px-4 py-3">@Context.T("common.name")</th>
                        <th class="px-4 py-3 text-right">@Context.T("metric.cash_in")</th>
                        <th class="px-4 py-3 text-right">@Context.T("metric.cash_out")</th>
                        <th class="px-4 py-3 text-right">@Context.T("metric.donation")</th>
                        <th class="px-4 py-3 text-right">@Context.T("metric.donation_points")</th>
                        <th class="px-4 py-3 text-right">@Context.T("metric.pension_points")</th>
                        <th class="px-4 py-3 text-right">@Context.T("metric.gold_qty")</th>
                        <th class="px-4 py-3 text-right">@Context.T("metric.happiness")</th>
                        <th class="px-4 py-3 text-right">@Context.T("common.detail")</th>
                    </tr>
                </thead>
                <tbody>
                @if (Model.Analytics.ByPlayer.Count == 0)
                {
                    <tr>
                        <td class="px-4 py-4 text-slate-500 mobile-card-empty" colspan="11">@Context.T("state.no_player_data")</td>
                    </tr>
                }
                else
                {
                    for (var playerIndex = 0; playerIndex < Model.Analytics.ByPlayer.Count; playerIndex++)
                    {
                        var item = Model.Analytics.ByPlayer[playerIndex];
                        var rank = playerRankLookup.TryGetValue(item.PlayerId, out var resolvedRank)
                            ? resolvedRank
                            : 0;
                        var winnerRowClass = rank == 1
                            ? "winner-row"
                            : string.Empty;
                        <tr class="border-t border-slate-200 @winnerRowClass">
                            <td class="px-4 py-3 text-right text-slate-700" data-label="@Context.T("common.turn_order")">@(playerIndex + 1)</td>
                            <td class="px-4 py-3 text-right text-slate-700" data-label="@Context.T("common.rank")">@(rank > 0 ? rank : "-")</td>
                            <td class="px-4 py-3 text-slate-700" data-label="@Context.T("common.name")">
                                @ResolvePlayerName(item.PlayerId)
                            </td>
                            <td class="px-4 py-3 text-right" data-label="@Context.T("metric.cash_in")">@item.CashInTotal</td>
                            <td class="px-4 py-3 text-right" data-label="@Context.T("metric.cash_out")">@item.CashOutTotal</td>
                            <td class="px-4 py-3 text-right" data-label="@Context.T("metric.donation")">@item.DonationTotal</td>
                            <td class="px-4 py-3 text-right" data-label="@Context.T("metric.donation_points")">@F(item.DonationPointsTotal)</td>
                            <td class="px-4 py-3 text-right" data-label="@Context.T("metric.pension_points")">@F(item.PensionPointsTotal)</td>
                            <td class="px-4 py-3 text-right" data-label="@Context.T("metric.gold_qty")">@item.GoldQty</td>
                            <td class="px-4 py-3 text-right" data-label="@Context.T("metric.happiness")">@item.HappinessPointsTotal</td>
                            <td class="px-4 py-3 text-right" data-label="@Context.T("common.detail")">
                                <a class="table-link"
                                   asp-controller="Players" asp-action="Details" asp-route-sessionId="@Model.SessionId"
                                   asp-route-playerId="@item.PlayerId">@Context.T("common.view")</a>
                            </td>
                        </tr>
                    }
                }
                </tbody>
            </table>
        </div>

    }

    @await Html.PartialAsync("_SessionJourneySection", Model)
</section>

@section Scripts {
    @await Html.PartialAsync("_SessionJourneyScript", Model)
}
