@model Cashflowpoly.Ui.Models.AnalyticsSearchViewModel
@using System.Linq

@{
    ViewData["Title"] = Context.T("nav.analytics");
    var isInstructor = Model.IsInstructor;
    var playerDisplayNames = Model.PlayerDisplayNames;
    var playerSummary = !isInstructor && Model.Result is not null && Model.Result.ByPlayer.Count > 0
        ? Model.Result.ByPlayer[0]
        : null;
    var playerNetCashflow = playerSummary is null
        ? 0
        : playerSummary.CashInTotal - playerSummary.CashOutTotal;
    var fallbackPlayerNames = new Dictionary<Guid, string>();
    var fallbackPlayerIndex = 1;
    var knownPlayerIds = (Model.Result?.ByPlayer.Select(item => item.PlayerId) ?? Enumerable.Empty<Guid>())
        .Distinct()
        .ToList();

    foreach (var playerId in knownPlayerIds)
    {
        if (playerDisplayNames.TryGetValue(playerId, out var displayName) && !string.IsNullOrWhiteSpace(displayName))
        {
            continue;
        }

        fallbackPlayerNames[playerId] = $"{Context.T("common.player")} {fallbackPlayerIndex}";
        fallbackPlayerIndex++;
    }

    string F(double value) => value.ToString("0.##");
    string ResolvePlayerName(Guid playerId)
    {
        if (playerDisplayNames.TryGetValue(playerId, out var displayName) && !string.IsNullOrWhiteSpace(displayName))
        {
            return displayName;
        }

        if (fallbackPlayerNames.TryGetValue(playerId, out var fallbackName))
        {
            return fallbackName;
        }

        return Context.T("common.player");
    }
}

<section class="section-shell w-full analytics-shell analytics-page @(isInstructor ? "analytics-shell-instructor" : "analytics-shell-player")">
    <div class="page-intro analytics-hero">
        <div class="page-intro-main">
            <p class="eyebrow text-emerald-700">@(isInstructor ? Context.T("analytics.dashboard") : Context.T("analytics.player_dashboard"))</p>
            <h1 class="headline">@(isInstructor ? Context.T("analytics.title") : Context.T("analytics.player_title"))</h1>
            <p class="subhead">@(isInstructor
                ? Context.T("analytics.subtitle")
                : Context.T("analytics.player_subtitle"))</p>
        </div>
        <div class="page-intro-actions">
            <div class="badge @(isInstructor ? "badge-emerald" : "badge-amber")">@Context.T("home.realtime")</div>
        </div>
    </div>

    @if (isInstructor)
    {
        <div class="mt-6 analytics-workbench">
            <div class="analytics-workbench-header">
                <h2>@Context.T("analytics.section.session_title")</h2>
                <p>@Context.T("analytics.section.session_desc")</p>
            </div>

            <form class="analytics-session-form" method="post" asp-controller="Analytics" asp-action="Index">
                @Html.AntiForgeryToken()
                <select class="form-input"
                        id="analytics-session-id"
                        asp-for="SessionId"
                        aria-label="@Context.T("common.session")"
                        required>
                    @if (Model.Sessions.Count == 0)
                    {
                        <option value="">@Context.T("state.no_sessions")</option>
                    }
                    else
                    {
                        @foreach (var item in Model.Sessions)
                        {
                            <option value="@item.SessionId">@item.SessionName (@Context.TSessionStatus(item.Status))</option>
                        }
                    }
                </select>
                <div class="form-actions">
                    <button class="btn-primary" type="submit">@Context.T("analytics.button")</button>
                </div>
            </form>
        </div>
    }
    else
    {
        <form class="mt-6 form-panel flex flex-col gap-3 md:flex-row md:items-end" method="post" asp-controller="Analytics" asp-action="Index">
            @Html.AntiForgeryToken()
            <div class="form-field flex-1">
                <label class="form-label" for="analytics-session-id">@Context.T("common.session_id")</label>
                <select class="form-input"
                        id="analytics-session-id"
                        asp-for="SessionId">
                    @if (Model.Sessions.Count == 0)
                    {
                        <option value="">@Context.T("analytics.player_no_sessions")</option>
                    }
                    else
                    {
                        @foreach (var item in Model.Sessions)
                        {
                            <option value="@item.SessionId">@item.SessionName (@Context.TSessionStatus(item.Status))</option>
                        }
                    }
                </select>
            </div>
            <button class="btn-primary" type="submit">@Context.T("analytics.player_button")</button>
        </form>
    }

    @if (!string.IsNullOrWhiteSpace(Model.SessionLookupErrorMessage))
    {
        <div class="mt-4 alert alert-warning" aria-live="polite">
            @Model.SessionLookupErrorMessage
        </div>
    }

    @if (!string.IsNullOrWhiteSpace(Model.RulesetErrorMessage))
    {
        <div class="mt-4 alert alert-error" aria-live="polite">
            @Model.RulesetErrorMessage
        </div>
    }

    @if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
    {
        <div class="mt-4 alert alert-error" aria-live="polite">
            @Model.ErrorMessage
        </div>
    }

    <details class="mt-4 data-toggle analytics-tips">
        <summary>@(isInstructor ? Context.T("analytics.tips.instructor") : Context.T("analytics.tips.player"))</summary>
        <div class="mt-3 metric-panel">
            <div class="metric-list">
                @if (isInstructor)
                {
                    <div class="metric-row"><span class="metric-key">@Context.T("analytics.tip_key.input")</span><span class="metric-value">@Context.T("analytics.tip.input")</span></div>
                    <div class="metric-row"><span class="metric-key">@Context.T("analytics.tip_key.interpretation")</span><span class="metric-value">@Context.T("analytics.tip.interpretation")</span></div>
                    <div class="metric-row"><span class="metric-key">@Context.T("analytics.tip_key.followup")</span><span class="metric-value">@Context.T("analytics.tip.followup")</span></div>
                }
                else
                {
                    <div class="metric-row"><span class="metric-key">@Context.T("analytics.tip_key.select_session")</span><span class="metric-value">@Context.T("analytics.tip.select_session")</span></div>
                    <div class="metric-row"><span class="metric-key">@Context.T("analytics.tip_key.focus_score")</span><span class="metric-value">@Context.T("analytics.tip.focus_score")</span></div>
                    <div class="metric-row"><span class="metric-key">@Context.T("analytics.tip_key.risk_control")</span><span class="metric-value">@Context.T("analytics.tip.risk_control")</span></div>
                }
            </div>
        </div>
    </details>

    @if (Model.Result is not null)
    {
        <div class="mt-6 session-stats-grid analytics-session-stats analytics-session-stats-fix">
            <div class="stat-card session-total-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("metric.total_event")</p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">@Model.Result.Summary.EventCount</p>
            </div>
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("metric.net_cashflow")</p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">@F(Model.Result.Summary.CashflowNetTotal)</p>
            </div>
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("analytics.players")</p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">@Model.Result.ByPlayer.Count</p>
            </div>
        </div>

        @if (!isInstructor && playerSummary is not null)
        {
            <div class="mt-6 player-kpi-grid">
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("metric.cash_in")</p>
                    <p class="mt-2 text-xl font-semibold text-slate-900">@F(playerSummary.CashInTotal)</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("metric.cash_out")</p>
                    <p class="mt-2 text-xl font-semibold text-slate-900">@F(playerSummary.CashOutTotal)</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("metric.net_cashflow")</p>
                    <p class="mt-2 text-xl font-semibold text-slate-900">@F(playerNetCashflow)</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("metric.happiness")</p>
                    <p class="mt-2 text-xl font-semibold text-slate-900">@F(playerSummary.HappinessPointsTotal)</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("metric.need_points")</p>
                    <p class="mt-2 text-xl font-semibold text-slate-900">@F(playerSummary.NeedPointsTotal)</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("metric.saving_goal")</p>
                    <p class="mt-2 text-xl font-semibold text-slate-900">@F(playerSummary.SavingGoalPointsTotal)</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("metric.orders_completed")</p>
                    <p class="mt-2 text-xl font-semibold text-slate-900">@playerSummary.OrdersCompletedCount</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("metric.inventory_ingredient")</p>
                    <p class="mt-2 text-xl font-semibold text-slate-900">@playerSummary.InventoryIngredientTotal</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("metric.actions_used")</p>
                    <p class="mt-2 text-xl font-semibold text-slate-900">@playerSummary.ActionsUsedTotal</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("metric.primary_need_compliance")</p>
                    <p class="mt-2 text-xl font-semibold text-slate-900">@F(playerSummary.CompliancePrimaryNeedRate * 100)%</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("metric.violations")</p>
                    <p class="mt-2 text-xl font-semibold text-slate-900">@playerSummary.RulesViolationsCount</p>
                </div>
            </div>
        }

        @if (isInstructor)
        {
            <div class="mt-8 chart-grid">
                <article class="chart-card md:col-span-2">
                    <h3 class="chart-title">@Context.T("analytics.chart.session_summary")</h3>
                    <canvas id="summaryLineChart" height="120"></canvas>
                </article>
                <article class="chart-card md:col-span-2">
                    <h3 class="chart-title">@Context.T("analytics.chart.cashflow_per_player")</h3>
                    <canvas id="cashflowLineChart" height="120"></canvas>
                </article>
            </div>

            @if (Model.Result.ByPlayer.Count == 0)
            {
                <div class="mt-6 alert alert-info">
                    @Context.T("state.no_player_data")
                </div>
            }
            else
            {
                <div class="mt-8 chart-grid">
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.donation")</h3>
                        <canvas id="donationLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.gold_qty")</h3>
                        <canvas id="goldQtyLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.happiness")</h3>
                        <canvas id="happinessLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.need_points")</h3>
                        <canvas id="needPointsLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.need_bonus")</h3>
                        <canvas id="needBonusLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.donation_points")</h3>
                        <canvas id="donationPointsLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.gold_points")</h3>
                        <canvas id="goldPointsLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.pension_points")</h3>
                        <canvas id="pensionPointsLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.saving_goal")</h3>
                        <canvas id="savingGoalLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.mission_penalty")</h3>
                        <canvas id="missionPenaltyLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.loan_penalty")</h3>
                        <canvas id="loanPenaltyLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.loan_unpaid")</h3>
                        <canvas id="loanUnpaidLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.orders_completed")</h3>
                        <canvas id="ordersCompletedLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.inventory_ingredient")</h3>
                        <canvas id="inventoryIngredientLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.actions_used")</h3>
                        <canvas id="actionsUsedLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.primary_need_compliance")</h3>
                        <canvas id="compliancePrimaryNeedLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.violations")</h3>
                        <canvas id="rulesViolationsLineChart" height="110"></canvas>
                    </article>
                </div>
            }
        }
        else if (playerSummary is null)
        {
            <div class="mt-6 alert alert-info">
                @Context.T("state.no_player_data")
            </div>
        }
        else
        {
            <div class="mt-8 chart-grid">
                <article class="chart-card">
                    <h3 class="chart-title">@Context.T("analytics.chart.personal_cashflow")</h3>
                    <canvas id="playerFinanceChart" height="120"></canvas>
                </article>
                <article class="chart-card">
                    <h3 class="chart-title">@Context.T("analytics.chart.game_points")</h3>
                    <canvas id="playerPointsChart" height="120"></canvas>
                </article>
                <article class="chart-card">
                    <h3 class="chart-title">@Context.T("analytics.chart.risk_control")</h3>
                    <canvas id="playerRiskChart" height="120"></canvas>
                </article>
                <article class="chart-card">
                    <h3 class="chart-title">@Context.T("analytics.chart.operations")</h3>
                    <canvas id="playerOperationsChart" height="120"></canvas>
                </article>
            </div>
        }

        var matrixPlayers = (isInstructor
                ? Model.Result.ByPlayer
                : Model.Result.ByPlayer.Where(item => playerSummary is not null && item.PlayerId == playerSummary.PlayerId))
            .ToList();
        <section class="mt-10 analytics-result-shell">
            <div class="analytics-workbench-header">
                <h2>@Context.T("analytics.section.minimum_matrix_title")</h2>
                <p>@Context.T("analytics.section.minimum_matrix_desc")</p>
            </div>

            <div class="mt-4 table-wrap analytics-table-block analytics-minimum-matrix analytics-minimum-matrix-fix">
                <table class="w-full min-w-[1440px] text-left text-sm analytics-minimum-matrix-table analytics-minimum-matrix-table-fix">
                    <thead class="table-head">
                        <tr>
                            <th class="px-4 py-3 whitespace-nowrap">@Context.T("common.player")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.cash_in")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.cash_out")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.net_cashflow")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.donation")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.gold_qty")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.orders_completed")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.inventory_ingredient")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.actions_used")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.primary_need_compliance")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.violations")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.happiness")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.need_points")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.need_bonus")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.donation_points")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.gold_points")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.pension_points")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.saving_goal")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.mission_penalty")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.loan_penalty")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.loan_unpaid")</th>
                        </tr>
                    </thead>
                    <tbody>
                    @if (matrixPlayers.Count == 0)
                    {
                        <tr>
                            <td class="px-4 py-4 text-slate-500 mobile-card-empty" colspan="21">@Context.T("state.no_player_data")</td>
                        </tr>
                    }
                    else
                    {
                        foreach (var item in matrixPlayers)
                        {
                            var netCash = item.CashInTotal - item.CashOutTotal;
                            <tr class="border-t border-slate-200">
                                <td class="px-4 py-3 text-slate-700" data-label="@Context.T("common.player")">@ResolvePlayerName(item.PlayerId)</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.cash_in")">@F(item.CashInTotal)</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.cash_out")">@F(item.CashOutTotal)</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.net_cashflow")">@F(netCash)</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.donation")">@F(item.DonationTotal)</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.gold_qty")">@item.GoldQty</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.orders_completed")">@item.OrdersCompletedCount</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.inventory_ingredient")">@item.InventoryIngredientTotal</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.actions_used")">@item.ActionsUsedTotal</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.primary_need_compliance")">@F(item.CompliancePrimaryNeedRate * 100)%</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.violations")">@item.RulesViolationsCount</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.happiness")">@F(item.HappinessPointsTotal)</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.need_points")">@F(item.NeedPointsTotal)</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.need_bonus")">@F(item.NeedSetBonusPoints)</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.donation_points")">@F(item.DonationPointsTotal)</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.gold_points")">@F(item.GoldPointsTotal)</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.pension_points")">@F(item.PensionPointsTotal)</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.saving_goal")">@F(item.SavingGoalPointsTotal)</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.mission_penalty")">@F(item.MissionPenaltyTotal)</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.loan_penalty")">@F(item.LoanPenaltyTotal)</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.loan_unpaid")">@((item.HasUnpaidLoan) ? Context.T("state.true") : Context.T("state.false"))</td>
                            </tr>
                        }
                    }
                    </tbody>
                </table>
            </div>
        </section>
    }
    @await Html.PartialAsync("_RulesetAnalyticsSection", Model)
</section>

@section Scripts {
    @await Html.PartialAsync("_AnalyticsChartsScript", Model)
}
