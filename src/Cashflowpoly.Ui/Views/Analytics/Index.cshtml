@* Fungsi file: Merender tampilan Razor untuk bagian Analytics/Index.cshtml beserta interaksi presentasinya. *@
@model Cashflowpoly.Ui.Models.AnalyticsSearchViewModel
@using System.Linq

@{
    ViewData["Title"] = Context.T("nav.analytics");
    var isInstructor = Model.IsInstructor;
    var playerDisplayNames = Model.PlayerDisplayNames;
    var playerSummary = !isInstructor && Model.Result is not null && Model.Result.ByPlayer.Count > 0
        ? Model.Result.ByPlayer[0]
        : null;

    var fallbackPlayerNames = new Dictionary<Guid, string>();
    var fallbackPlayerIndex = 1;
    var knownPlayerIds = (Model.Result?.ByPlayer.Select(item => item.PlayerId) ?? Enumerable.Empty<Guid>())
        .Distinct()
        .ToList();

    foreach (var playerId in knownPlayerIds)
    {
        if (playerDisplayNames.TryGetValue(playerId, out var displayName) && !string.IsNullOrWhiteSpace(displayName))
        {
            continue;
        }

        fallbackPlayerNames[playerId] = $"{Context.T("common.player")} {fallbackPlayerIndex}";
        fallbackPlayerIndex++;
    }

    string F(double value) => value.ToString("0.##");
    string ResolvePlayerName(Guid playerId)
    {
        if (playerDisplayNames.TryGetValue(playerId, out var displayName) && !string.IsNullOrWhiteSpace(displayName))
        {
            return displayName;
        }

        if (fallbackPlayerNames.TryGetValue(playerId, out var fallbackName))
        {
            return fallbackName;
        }

        return Context.T("common.player");
    }

    var matrixPlayers = Model.Result is null
        ? new List<Cashflowpoly.Ui.Models.AnalyticsByPlayerItemDto>()
        : (isInstructor
            ? Model.Result.ByPlayer
            : Model.Result.ByPlayer.Where(item => playerSummary is not null && item.PlayerId == playerSummary.PlayerId))
            .ToList();
}

<section class="section-shell w-full analytics-shell analytics-page @(isInstructor ? "analytics-shell-instructor" : "analytics-shell-player")">
    <div class="page-intro analytics-hero">
        <div class="page-intro-main">
            <p class="eyebrow text-emerald-700">@(isInstructor ? Context.T("analytics.dashboard") : Context.T("analytics.player_dashboard"))</p>
            <h1 class="headline">@(isInstructor ? Context.T("analytics.title") : Context.T("analytics.player_title"))</h1>
            <p class="subhead">@(isInstructor
                ? Context.T("analytics.subtitle")
                : Context.T("analytics.player_subtitle"))</p>
        </div>
        <div class="page-intro-actions">
            <div class="badge @(isInstructor ? "badge-emerald" : "badge-amber")">@Context.T("home.realtime")</div>
        </div>
    </div>

    @if (isInstructor)
    {
        <div class="mt-6 analytics-workbench">
            <div class="analytics-workbench-header">
                <h2>@Context.T("analytics.section.session_title")</h2>
                <p>@Context.T("analytics.section.session_desc")</p>
            </div>

            <form class="analytics-session-form" method="post" asp-controller="Analytics" asp-action="Index">
                @Html.AntiForgeryToken()
                <select class="form-input"
                        id="analytics-session-id"
                        asp-for="SessionId"
                        aria-label="@Context.T("common.session")"
                        required>
                    @if (Model.Sessions.Count == 0)
                    {
                        <option value="">@Context.T("state.no_sessions")</option>
                    }
                    else
                    {
                        @foreach (var item in Model.Sessions)
                        {
                            <option value="@item.SessionId">@item.SessionName (@Context.TSessionStatus(item.Status))</option>
                        }
                    }
                </select>
                <div class="form-actions">
                    <button class="btn-primary" type="submit">@Context.T("analytics.button")</button>
                </div>
            </form>
        </div>
    }
    else
    {
        <form class="mt-6 form-panel flex flex-col gap-3 md:flex-row md:items-end" method="post" asp-controller="Analytics" asp-action="Index">
            @Html.AntiForgeryToken()
            <div class="form-field flex-1">
                <label class="form-label" for="analytics-session-id">@Context.T("common.session_id")</label>
                <select class="form-input"
                        id="analytics-session-id"
                        asp-for="SessionId">
                    @if (Model.Sessions.Count == 0)
                    {
                        <option value="">@Context.T("analytics.player_no_sessions")</option>
                    }
                    else
                    {
                        @foreach (var item in Model.Sessions)
                        {
                            <option value="@item.SessionId">@item.SessionName (@Context.TSessionStatus(item.Status))</option>
                        }
                    }
                </select>
            </div>
            <button class="btn-primary" type="submit">@Context.T("analytics.player_button")</button>
        </form>
    }

    @if (!string.IsNullOrWhiteSpace(Model.SessionLookupErrorMessage))
    {
        <div class="mt-4 alert alert-warning" aria-live="polite">
            @Model.SessionLookupErrorMessage
        </div>
    }

    @if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
    {
        <div class="mt-4 alert alert-error" aria-live="polite">
            @Model.ErrorMessage
        </div>
    }

    @if (Model.Result is not null)
    {
        <div class="mt-6 session-stats-grid analytics-session-stats analytics-session-stats-fix">
            <div class="stat-card session-total-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("metric.total_event")</p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">@Model.Result.Summary.EventCount</p>
            </div>
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("metric.net_cashflow")</p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">@F(Model.Result.Summary.CashflowNetTotal)</p>
            </div>
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("analytics.players")</p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">@Model.Result.ByPlayer.Count</p>
            </div>
        </div>

        @if (matrixPlayers.Count == 0)
        {
            <div class="mt-6 alert alert-info">@Context.T("state.no_player_data")</div>
        }
        else
        {
            <section class="mt-10 analytics-result-shell">
                <div class="analytics-workbench-header">
                    <h2>@Context.T("analytics.section.part1_title")</h2>
                    <p>@Context.T("analytics.section.part1_desc")</p>
                </div>

                <div class="mt-4 table-wrap analytics-table-block">
                    <table class="w-full text-left text-sm">
                        <thead class="table-head">
                            <tr>
                                <th class="px-4 py-3">@Context.T("common.player")</th>
                                <th class="px-4 py-3 text-right">@Context.T("metric.cash_in")</th>
                                <th class="px-4 py-3 text-right">@Context.T("metric.cash_out")</th>
                                <th class="px-4 py-3 text-right">@Context.T("metric.net_cashflow")</th>
                                <th class="px-4 py-3 text-right">@Context.T("metric.donation")</th>
                                <th class="px-4 py-3 text-right">@Context.T("metric.gold_qty")</th>
                                <th class="px-4 py-3 text-right">@Context.T("metric.orders_completed")</th>
                                <th class="px-4 py-3 text-right">@Context.T("metric.inventory_ingredient")</th>
                                <th class="px-4 py-3 text-right">@Context.T("metric.actions_used")</th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var item in matrixPlayers)
                        {
                            var netCash = item.CashInTotal - item.CashOutTotal;
                            <tr class="border-t border-slate-200">
                                <td class="px-4 py-3 text-slate-700">@ResolvePlayerName(item.PlayerId)</td>
                                <td class="px-4 py-3 text-right">@F(item.CashInTotal)</td>
                                <td class="px-4 py-3 text-right">@F(item.CashOutTotal)</td>
                                <td class="px-4 py-3 text-right">@F(netCash)</td>
                                <td class="px-4 py-3 text-right">@F(item.DonationTotal)</td>
                                <td class="px-4 py-3 text-right">@item.GoldQty</td>
                                <td class="px-4 py-3 text-right">@item.OrdersCompletedCount</td>
                                <td class="px-4 py-3 text-right">@item.InventoryIngredientTotal</td>
                                <td class="px-4 py-3 text-right">@item.ActionsUsedTotal</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </section>

            <section class="mt-8 analytics-result-shell">
                <div class="analytics-workbench-header">
                    <h2>@Context.T("analytics.section.part2_title")</h2>
                    <p>@Context.T("analytics.section.part2_desc")</p>
                </div>

                <div class="mt-4 table-wrap analytics-table-block">
                    <table class="w-full text-left text-sm">
                        <thead class="table-head">
                            <tr>
                                <th class="px-4 py-3">@Context.T("common.player")</th>
                                <th class="px-4 py-3 text-right">@Context.T("metric.happiness")</th>
                                <th class="px-4 py-3 text-right">@Context.T("metric.need_points")</th>
                                <th class="px-4 py-3 text-right">@Context.T("metric.need_bonus")</th>
                                <th class="px-4 py-3 text-right">@Context.T("metric.donation_points")</th>
                                <th class="px-4 py-3 text-right">@Context.T("metric.gold_points")</th>
                                <th class="px-4 py-3 text-right">@Context.T("metric.pension_points")</th>
                                <th class="px-4 py-3 text-right">@Context.T("metric.saving_goal")</th>
                                <th class="px-4 py-3 text-right">@Context.T("metric.mission_penalty")</th>
                                <th class="px-4 py-3 text-right">@Context.T("metric.loan_penalty")</th>
                                <th class="px-4 py-3 text-right">@Context.T("metric.loan_unpaid")</th>
                                <th class="px-4 py-3 text-right">@Context.T("common.detail")</th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var item in matrixPlayers)
                        {
                            <tr class="border-t border-slate-200">
                                <td class="px-4 py-3 text-slate-700">@ResolvePlayerName(item.PlayerId)</td>
                                <td class="px-4 py-3 text-right">@F(item.HappinessPointsTotal)</td>
                                <td class="px-4 py-3 text-right">@F(item.NeedPointsTotal)</td>
                                <td class="px-4 py-3 text-right">@F(item.NeedSetBonusPoints)</td>
                                <td class="px-4 py-3 text-right">@F(item.DonationPointsTotal)</td>
                                <td class="px-4 py-3 text-right">@F(item.GoldPointsTotal)</td>
                                <td class="px-4 py-3 text-right">@F(item.PensionPointsTotal)</td>
                                <td class="px-4 py-3 text-right">@F(item.SavingGoalPointsTotal)</td>
                                <td class="px-4 py-3 text-right">@F(item.MissionPenaltyTotal)</td>
                                <td class="px-4 py-3 text-right">@F(item.LoanPenaltyTotal)</td>
                                <td class="px-4 py-3 text-right">@((item.HasUnpaidLoan) ? Context.T("state.true") : Context.T("state.false"))</td>
                                <td class="px-4 py-3 text-right">
                                    <a class="table-link"
                                       asp-controller="Players"
                                       asp-action="Details"
                                       asp-route-sessionId="@Model.Result.SessionId"
                                       asp-route-playerId="@item.PlayerId">@Context.T("common.view")</a>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </section>
        }
    }
</section>
