@model Cashflowpoly.Ui.Models.AnalyticsSearchViewModel
@using System.Text.Json

@{
    ViewData["Title"] = Context.T("nav.analytics");
    var isInstructor = Model.IsInstructor;
    var playerSummary = !isInstructor && Model.Result is not null && Model.Result.ByPlayer.Count > 0
        ? Model.Result.ByPlayer[0]
        : null;
    var playerNetCashflow = playerSummary is null
        ? 0
        : playerSummary.CashInTotal - playerSummary.CashOutTotal;
}

<section class="section-shell w-full analytics-shell @(isInstructor ? "analytics-shell-instructor" : "analytics-shell-player")">
    <div class="page-intro">
        <div class="page-intro-main">
            <p class="eyebrow text-emerald-700">@(isInstructor ? Context.T("analytics.dashboard") : Context.T("analytics.player_dashboard"))</p>
            <h1 class="headline">@(isInstructor ? Context.T("analytics.title") : Context.T("analytics.player_title"))</h1>
            <p class="subhead">@(isInstructor
                ? Context.T("analytics.subtitle")
                : Context.T("analytics.player_subtitle"))</p>
        </div>
        <div class="page-intro-actions">
            <div class="badge @(isInstructor ? "badge-emerald" : "badge-amber")">@Context.T("home.realtime")</div>
        </div>
    </div>

    <form class="mt-6 form-panel flex flex-col gap-3 md:flex-row md:items-end" method="post">
        @Html.AntiForgeryToken()
        @if (isInstructor)
        {
            <div class="form-field flex-1">
                <label class="form-label" for="analytics-session-id">@Context.T("common.session_id")</label>
                <input class="form-input"
                       id="analytics-session-id"
                       asp-for="SessionId"
                       list="analytics-session-options"
                       autocomplete="off"
                       required
                       placeholder="UUID" />
                <datalist id="analytics-session-options">
                    @foreach (var item in Model.Sessions)
                    {
                        <option value="@item.SessionId">@item.SessionName (@item.Status)</option>
                    }
                </datalist>
            </div>
            <button class="btn-primary" type="submit">@Context.T("analytics.button")</button>
        }
        else
        {
            <div class="form-field flex-1">
                <label class="form-label" for="analytics-session-id">@Context.T("common.session_id")</label>
                <select class="form-input"
                        id="analytics-session-id"
                        asp-for="SessionId">
                    @if (Model.Sessions.Count == 0)
                    {
                        <option value="">@Context.T("analytics.player_no_sessions")</option>
                    }
                    else
                    {
                        @foreach (var item in Model.Sessions)
                        {
                            <option value="@item.SessionId">@item.SessionName (@item.Status)</option>
                        }
                    }
                </select>
            </div>
            <button class="btn-primary" type="submit">@Context.T("analytics.player_button")</button>
        }
    </form>

    @if (!string.IsNullOrWhiteSpace(Model.SessionLookupErrorMessage))
    {
        <div class="mt-4 alert alert-warning" aria-live="polite">
            @Model.SessionLookupErrorMessage
        </div>
    }

    @if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
    {
        <div class="mt-4 alert alert-error" aria-live="polite">
            @Model.ErrorMessage
        </div>
    }

    <details class="mt-4 data-toggle">
        <summary>@(isInstructor ? Context.T("analytics.tips.instructor") : Context.T("analytics.tips.player"))</summary>
        <div class="mt-3 metric-panel">
            <div class="metric-list">
                @if (isInstructor)
                {
                    <div class="metric-row"><span class="metric-key">@Context.T("analytics.tip_key.input")</span><span class="metric-value">@Context.T("analytics.tip.input")</span></div>
                    <div class="metric-row"><span class="metric-key">@Context.T("analytics.tip_key.interpretation")</span><span class="metric-value">@Context.T("analytics.tip.interpretation")</span></div>
                    <div class="metric-row"><span class="metric-key">@Context.T("analytics.tip_key.followup")</span><span class="metric-value">@Context.T("analytics.tip.followup")</span></div>
                }
                else
                {
                    <div class="metric-row"><span class="metric-key">@Context.T("analytics.tip_key.select_session")</span><span class="metric-value">@Context.T("analytics.tip.select_session")</span></div>
                    <div class="metric-row"><span class="metric-key">@Context.T("analytics.tip_key.focus_score")</span><span class="metric-value">@Context.T("analytics.tip.focus_score")</span></div>
                    <div class="metric-row"><span class="metric-key">@Context.T("analytics.tip_key.risk_control")</span><span class="metric-value">@Context.T("analytics.tip.risk_control")</span></div>
                }
            </div>
        </div>
    </details>

    @if (Model.Result is not null)
    {
        <div class="mt-6 ruleset-stats">
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("metric.total_event")</p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">@Model.Result.Summary.EventCount</p>
            </div>
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("metric.net_cashflow")</p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">@Model.Result.Summary.CashflowNetTotal</p>
            </div>
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("analytics.players")</p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">@Model.Result.ByPlayer.Count</p>
            </div>
        </div>

        @if (!isInstructor && playerSummary is not null)
        {
            <div class="mt-6 player-kpi-grid">
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("metric.cash_in")</p>
                    <p class="mt-2 text-xl font-semibold text-slate-900">@playerSummary.CashInTotal</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("metric.cash_out")</p>
                    <p class="mt-2 text-xl font-semibold text-slate-900">@playerSummary.CashOutTotal</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("metric.net_cashflow")</p>
                    <p class="mt-2 text-xl font-semibold text-slate-900">@playerNetCashflow</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("metric.happiness")</p>
                    <p class="mt-2 text-xl font-semibold text-slate-900">@playerSummary.HappinessPointsTotal</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("metric.need_points")</p>
                    <p class="mt-2 text-xl font-semibold text-slate-900">@playerSummary.NeedPointsTotal</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("metric.saving_goal")</p>
                    <p class="mt-2 text-xl font-semibold text-slate-900">@playerSummary.SavingGoalPointsTotal</p>
                </div>
            </div>
        }

        @if (isInstructor)
        {
            <div class="mt-8 chart-grid">
                <article class="chart-card md:col-span-2">
                    <h3 class="chart-title">@Context.T("analytics.chart.session_summary")</h3>
                    <canvas id="summaryLineChart" height="120"></canvas>
                </article>
                <article class="chart-card md:col-span-2">
                    <h3 class="chart-title">@Context.T("analytics.chart.cashflow_per_player")</h3>
                    <canvas id="cashflowLineChart" height="120"></canvas>
                </article>
            </div>

            @if (Model.Result.ByPlayer.Count == 0)
            {
                <div class="mt-6 alert alert-info">
                    @Context.T("state.no_player_data")
                </div>
            }
            else
            {
                <div class="mt-8 chart-grid">
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.donation")</h3>
                        <canvas id="donationLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.gold_qty")</h3>
                        <canvas id="goldQtyLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.happiness")</h3>
                        <canvas id="happinessLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.need_points")</h3>
                        <canvas id="needPointsLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.need_bonus")</h3>
                        <canvas id="needBonusLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.donation_points")</h3>
                        <canvas id="donationPointsLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.gold_points")</h3>
                        <canvas id="goldPointsLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.pension_points")</h3>
                        <canvas id="pensionPointsLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.saving_goal")</h3>
                        <canvas id="savingGoalLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.mission_penalty")</h3>
                        <canvas id="missionPenaltyLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.loan_penalty")</h3>
                        <canvas id="loanPenaltyLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.loan_unpaid")</h3>
                        <canvas id="loanUnpaidLineChart" height="110"></canvas>
                    </article>
                </div>
            }
        }
        else if (playerSummary is null)
        {
            <div class="mt-6 alert alert-info">
                @Context.T("state.no_player_data")
            </div>
        }
        else
        {
            <div class="mt-8 chart-grid">
                <article class="chart-card">
                    <h3 class="chart-title">@Context.T("analytics.chart.personal_cashflow")</h3>
                    <canvas id="playerFinanceChart" height="120"></canvas>
                </article>
                <article class="chart-card">
                    <h3 class="chart-title">@Context.T("analytics.chart.game_points")</h3>
                    <canvas id="playerPointsChart" height="120"></canvas>
                </article>
                <article class="chart-card">
                    <h3 class="chart-title">@Context.T("analytics.chart.risk_control")</h3>
                    <canvas id="playerRiskChart" height="120"></canvas>
                </article>
            </div>
        }
    }
</section>

@section Scripts {
    @if (Model.Result is not null)
    {
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
        <script>
            (() => {
                if (typeof Chart === "undefined") {
                    return;
                }

                const data = @Html.Raw(JsonSerializer.Serialize(Model.Result));
                const players = data.by_player ?? [];
                const playerLabels = players.map((p, idx) => `P${idx + 1}`);
                const isPlayerDashboard = @((!Model.IsInstructor).ToString().ToLowerInvariant());

                const makeChart = (canvasId, type, labels, datasets, options = {}) => {
                    const el = document.getElementById(canvasId);
                    if (!el) {
                        return;
                    }

                    new Chart(el, {
                        type,
                        data: { labels, datasets },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            aspectRatio: 2.2,
                            scales: {
                                y: { beginAtZero: true }
                            },
                            plugins: {
                                legend: { display: datasets.length > 1 }
                            },
                            ...options
                        }
                    });
                };

                if (isPlayerDashboard) {
                    const me = players[0];
                    if (!me) {
                        return;
                    }

                    const netCash = (me.cash_in_total ?? 0) - (me.cash_out_total ?? 0);

                    makeChart("playerFinanceChart", "bar",
                        ["@Context.T("analytics.chart.cash_in")", "@Context.T("analytics.chart.cash_out")", "@Context.T("analytics.chart.net")", "@Context.T("metric.donation")"],
                        [{
                            label: "@Context.T("analytics.chart.value")",
                            data: [me.cash_in_total ?? 0, me.cash_out_total ?? 0, netCash, me.donation_total ?? 0],
                            backgroundColor: ["#2d7dd2", "#e95a4b", "#1ba784", "#f39c12"],
                            borderColor: ["#1f5aa0", "#b73f31", "#157f63", "#bf7608"],
                            borderWidth: 1.2
                        }],
                        {
                            plugins: { legend: { display: false } }
                        });

                    makeChart("playerPointsChart", "bar",
                        ["@Context.T("metric.happiness")", "@Context.T("metric.need_points")", "@Context.T("metric.need_bonus")", "@Context.T("metric.donation")", "@Context.T("metric.gold_points")", "@Context.T("metric.pension_points")", "@Context.T("metric.saving_goal")"],
                        [{
                            label: "@Context.T("analytics.chart.points")",
                            data: [
                                me.happiness_points_total ?? 0,
                                me.need_points_total ?? 0,
                                me.need_set_bonus_points ?? 0,
                                me.donation_points_total ?? 0,
                                me.gold_points_total ?? 0,
                                me.pension_points_total ?? 0,
                                me.saving_goal_points_total ?? 0
                            ],
                            backgroundColor: "#3f74ff99",
                            borderColor: "#2d5ce0",
                            borderWidth: 1.2
                        }],
                        {
                            plugins: { legend: { display: false } }
                        });

                    makeChart("playerRiskChart", "bar",
                        ["@Context.T("metric.mission_penalty")", "@Context.T("metric.loan_penalty")", "@Context.T("metric.loan_unpaid")"],
                        [{
                            label: "@Context.T("analytics.chart.risk")",
                            data: [me.mission_penalty_total ?? 0, me.loan_penalty_total ?? 0, me.has_unpaid_loan ? 1 : 0],
                            backgroundColor: ["#ef4e4e99", "#d1495b99", "#37415199"],
                            borderColor: ["#bf2e2e", "#a53344", "#1f2937"],
                            borderWidth: 1.2
                        }],
                        {
                            plugins: { legend: { display: false } }
                        });

                    return;
                }

                makeChart("summaryLineChart", "line",
                    ["@Context.T("analytics.chart.event")", "@Context.T("analytics.chart.cash_in")", "@Context.T("analytics.chart.cash_out")", "@Context.T("analytics.chart.net")", "@Context.T("metric.violations")"],
                    [{
                        label: "@Context.T("analytics.chart.summary")",
                        data: [
                            data.summary.event_count,
                            data.summary.cash_in_total,
                            data.summary.cash_out_total,
                            data.summary.cashflow_net_total,
                            data.summary.rules_violations_count
                        ],
                        borderColor: "#e95a4b",
                        backgroundColor: "rgba(233, 90, 75, 0.18)",
                        tension: 0.32,
                        pointRadius: 4,
                        fill: true
                    }]);

                makeChart("cashflowLineChart", "line", playerLabels, [
                    {
                        label: "@Context.T("analytics.chart.cash_in")",
                        data: players.map((p) => p.cash_in_total),
                        borderColor: "#1ba784",
                        backgroundColor: "rgba(27, 167, 132, 0.15)",
                        tension: 0.32,
                        pointRadius: 3
                    },
                    {
                        label: "@Context.T("analytics.chart.cash_out")",
                        data: players.map((p) => p.cash_out_total),
                        borderColor: "#e95a4b",
                        backgroundColor: "rgba(233, 90, 75, 0.15)",
                        tension: 0.32,
                        pointRadius: 3
                    },
                    {
                        label: "@Context.T("metric.donation")",
                        data: players.map((p) => p.donation_total),
                        borderColor: "#3f74ff",
                        backgroundColor: "rgba(63, 116, 255, 0.15)",
                        tension: 0.32,
                        pointRadius: 3
                    }
                ]);

                const metricCharts = [
                    { id: "donationLineChart", key: "donation_total", color: "#18a8a0" },
                    { id: "goldQtyLineChart", key: "gold_qty", color: "#f39c12" },
                    { id: "happinessLineChart", key: "happiness_points_total", color: "#ef4e4e" },
                    { id: "needPointsLineChart", key: "need_points_total", color: "#2a9d8f" },
                    { id: "needBonusLineChart", key: "need_set_bonus_points", color: "#2fa56e" },
                    { id: "donationPointsLineChart", key: "donation_points_total", color: "#2d7dd2" },
                    { id: "goldPointsLineChart", key: "gold_points_total", color: "#dd9f00" },
                    { id: "pensionPointsLineChart", key: "pension_points_total", color: "#ff7f50" },
                    { id: "savingGoalLineChart", key: "saving_goal_points_total", color: "#00a6a6" },
                    { id: "missionPenaltyLineChart", key: "mission_penalty_total", color: "#c64f40" },
                    { id: "loanPenaltyLineChart", key: "loan_penalty_total", color: "#d1495b" },
                    { id: "loanUnpaidLineChart", key: "has_unpaid_loan", color: "#374151", boolToNum: true }
                ];

                metricCharts.forEach((metric) => {
                    const values = players.map((p) => {
                        if (metric.boolToNum) {
                            return p[metric.key] ? 1 : 0;
                        }
                        return p[metric.key] ?? 0;
                    });

                    makeChart(metric.id, "line", playerLabels, [{
                        label: metric.key,
                        data: values,
                        borderColor: metric.color,
                        backgroundColor: `${metric.color}33`,
                        tension: 0.32,
                        pointRadius: 3,
                        fill: true
                    }]);
                });
            })();
        </script>
    }
}
