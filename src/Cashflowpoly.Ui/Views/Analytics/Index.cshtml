@model Cashflowpoly.Ui.Models.AnalyticsSearchViewModel
@using System.Linq
@using System.Text.Json
@using Microsoft.AspNetCore.Http

@{
    ViewData["Title"] = Context.T("nav.analytics");
    var isInstructor = Model.IsInstructor;
    var playerDisplayNames = Model.PlayerDisplayNames;
    var playerSummary = !isInstructor && Model.Result is not null && Model.Result.ByPlayer.Count > 0
        ? Model.Result.ByPlayer[0]
        : null;
    var playerNetCashflow = playerSummary is null
        ? 0
        : playerSummary.CashInTotal - playerSummary.CashOutTotal;
    var rulesetResult = Model.RulesetResult;
    var fallbackPlayerNames = new Dictionary<Guid, string>();
    var fallbackPlayerIndex = 1;
    var activeLanguage = UiText.NormalizeLanguage(Context.Session.GetString(AuthConstants.SessionLanguageKey));
    var isEnglish = string.Equals(activeLanguage, AuthConstants.LanguageEn, StringComparison.OrdinalIgnoreCase);
    var knownPlayerIds = (Model.Result?.ByPlayer.Select(item => item.PlayerId) ?? Enumerable.Empty<Guid>())
        .Distinct()
        .ToList();

    foreach (var playerId in knownPlayerIds)
    {
        if (playerDisplayNames.TryGetValue(playerId, out var displayName) && !string.IsNullOrWhiteSpace(displayName))
        {
            continue;
        }

        fallbackPlayerNames[playerId] = $"{Context.T("common.player")} {fallbackPlayerIndex}";
        fallbackPlayerIndex++;
    }

    string F(double value) => value.ToString("0.##");
    string ResolvePlayerName(Guid playerId)
    {
        if (playerDisplayNames.TryGetValue(playerId, out var displayName) && !string.IsNullOrWhiteSpace(displayName))
        {
            return displayName;
        }

        if (fallbackPlayerNames.TryGetValue(playerId, out var fallbackName))
        {
            return fallbackName;
        }

        return Context.T("common.player");
    }

    string L(string id, string en) => isEnglish ? en : id;
}

<section class="section-shell w-full analytics-shell analytics-page @(isInstructor ? "analytics-shell-instructor" : "analytics-shell-player")">
    <div class="page-intro analytics-hero">
        <div class="page-intro-main">
            <p class="eyebrow text-emerald-700">@(isInstructor ? Context.T("analytics.dashboard") : Context.T("analytics.player_dashboard"))</p>
            <h1 class="headline">@(isInstructor ? Context.T("analytics.title") : Context.T("analytics.player_title"))</h1>
            <p class="subhead">@(isInstructor
                ? Context.T("analytics.subtitle")
                : Context.T("analytics.player_subtitle"))</p>
        </div>
        <div class="page-intro-actions">
            <div class="badge @(isInstructor ? "badge-emerald" : "badge-amber")">@Context.T("home.realtime")</div>
        </div>
    </div>

    @if (isInstructor)
    {
        <div class="mt-6 analytics-workbench">
            <div class="analytics-workbench-header">
                <h2>@Context.T("analytics.section.session_title")</h2>
                <p>@Context.T("analytics.section.session_desc")</p>
            </div>

            <form class="analytics-session-form" method="post" asp-controller="Analytics" asp-action="Index">
                @Html.AntiForgeryToken()
                <select class="form-input"
                        id="analytics-session-id"
                        asp-for="SessionId"
                        aria-label="@Context.T("common.session")"
                        required>
                    @if (Model.Sessions.Count == 0)
                    {
                        <option value="">@Context.T("state.no_sessions")</option>
                    }
                    else
                    {
                        @foreach (var item in Model.Sessions)
                        {
                            <option value="@item.SessionId">@item.SessionName (@Context.TSessionStatus(item.Status))</option>
                        }
                    }
                </select>
                <div class="form-actions">
                    <button class="btn-primary" type="submit">@Context.T("analytics.button")</button>
                </div>
            </form>
        </div>
    }
    else
    {
        <form class="mt-6 form-panel flex flex-col gap-3 md:flex-row md:items-end" method="post" asp-controller="Analytics" asp-action="Index">
            @Html.AntiForgeryToken()
            <div class="form-field flex-1">
                <label class="form-label" for="analytics-session-id">@Context.T("common.session_id")</label>
                <select class="form-input"
                        id="analytics-session-id"
                        asp-for="SessionId">
                    @if (Model.Sessions.Count == 0)
                    {
                        <option value="">@Context.T("analytics.player_no_sessions")</option>
                    }
                    else
                    {
                        @foreach (var item in Model.Sessions)
                        {
                            <option value="@item.SessionId">@item.SessionName (@Context.TSessionStatus(item.Status))</option>
                        }
                    }
                </select>
            </div>
            <button class="btn-primary" type="submit">@Context.T("analytics.player_button")</button>
        </form>
    }

    @if (!string.IsNullOrWhiteSpace(Model.SessionLookupErrorMessage))
    {
        <div class="mt-4 alert alert-warning" aria-live="polite">
            @Model.SessionLookupErrorMessage
        </div>
    }

    @if (!string.IsNullOrWhiteSpace(Model.RulesetErrorMessage))
    {
        <div class="mt-4 alert alert-error" aria-live="polite">
            @Model.RulesetErrorMessage
        </div>
    }

    @if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
    {
        <div class="mt-4 alert alert-error" aria-live="polite">
            @Model.ErrorMessage
        </div>
    }

    <details class="mt-4 data-toggle analytics-tips">
        <summary>@(isInstructor ? Context.T("analytics.tips.instructor") : Context.T("analytics.tips.player"))</summary>
        <div class="mt-3 metric-panel">
            <div class="metric-list">
                @if (isInstructor)
                {
                    <div class="metric-row"><span class="metric-key">@Context.T("analytics.tip_key.input")</span><span class="metric-value">@Context.T("analytics.tip.input")</span></div>
                    <div class="metric-row"><span class="metric-key">@Context.T("analytics.tip_key.interpretation")</span><span class="metric-value">@Context.T("analytics.tip.interpretation")</span></div>
                    <div class="metric-row"><span class="metric-key">@Context.T("analytics.tip_key.followup")</span><span class="metric-value">@Context.T("analytics.tip.followup")</span></div>
                }
                else
                {
                    <div class="metric-row"><span class="metric-key">@Context.T("analytics.tip_key.select_session")</span><span class="metric-value">@Context.T("analytics.tip.select_session")</span></div>
                    <div class="metric-row"><span class="metric-key">@Context.T("analytics.tip_key.focus_score")</span><span class="metric-value">@Context.T("analytics.tip.focus_score")</span></div>
                    <div class="metric-row"><span class="metric-key">@Context.T("analytics.tip_key.risk_control")</span><span class="metric-value">@Context.T("analytics.tip.risk_control")</span></div>
                }
            </div>
        </div>
    </details>

    @if (Model.Result is not null)
    {
        <div class="mt-6 session-stats-grid analytics-session-stats analytics-session-stats-fix">
            <div class="stat-card session-total-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("metric.total_event")</p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">@Model.Result.Summary.EventCount</p>
            </div>
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("metric.net_cashflow")</p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">@F(Model.Result.Summary.CashflowNetTotal)</p>
            </div>
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("analytics.players")</p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">@Model.Result.ByPlayer.Count</p>
            </div>
        </div>

        @if (!isInstructor && playerSummary is not null)
        {
            <div class="mt-6 player-kpi-grid">
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("metric.cash_in")</p>
                    <p class="mt-2 text-xl font-semibold text-slate-900">@F(playerSummary.CashInTotal)</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("metric.cash_out")</p>
                    <p class="mt-2 text-xl font-semibold text-slate-900">@F(playerSummary.CashOutTotal)</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("metric.net_cashflow")</p>
                    <p class="mt-2 text-xl font-semibold text-slate-900">@F(playerNetCashflow)</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("metric.happiness")</p>
                    <p class="mt-2 text-xl font-semibold text-slate-900">@F(playerSummary.HappinessPointsTotal)</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("metric.need_points")</p>
                    <p class="mt-2 text-xl font-semibold text-slate-900">@F(playerSummary.NeedPointsTotal)</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("metric.saving_goal")</p>
                    <p class="mt-2 text-xl font-semibold text-slate-900">@F(playerSummary.SavingGoalPointsTotal)</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("metric.orders_completed")</p>
                    <p class="mt-2 text-xl font-semibold text-slate-900">@playerSummary.OrdersCompletedCount</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("metric.inventory_ingredient")</p>
                    <p class="mt-2 text-xl font-semibold text-slate-900">@playerSummary.InventoryIngredientTotal</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("metric.actions_used")</p>
                    <p class="mt-2 text-xl font-semibold text-slate-900">@playerSummary.ActionsUsedTotal</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("metric.primary_need_compliance")</p>
                    <p class="mt-2 text-xl font-semibold text-slate-900">@F(playerSummary.CompliancePrimaryNeedRate * 100)%</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("metric.violations")</p>
                    <p class="mt-2 text-xl font-semibold text-slate-900">@playerSummary.RulesViolationsCount</p>
                </div>
            </div>
        }

        @if (isInstructor)
        {
            <div class="mt-8 chart-grid">
                <article class="chart-card md:col-span-2">
                    <h3 class="chart-title">@Context.T("analytics.chart.session_summary")</h3>
                    <canvas id="summaryLineChart" height="120"></canvas>
                </article>
                <article class="chart-card md:col-span-2">
                    <h3 class="chart-title">@Context.T("analytics.chart.cashflow_per_player")</h3>
                    <canvas id="cashflowLineChart" height="120"></canvas>
                </article>
            </div>

            @if (Model.Result.ByPlayer.Count == 0)
            {
                <div class="mt-6 alert alert-info">
                    @Context.T("state.no_player_data")
                </div>
            }
            else
            {
                <div class="mt-8 chart-grid">
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.donation")</h3>
                        <canvas id="donationLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.gold_qty")</h3>
                        <canvas id="goldQtyLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.happiness")</h3>
                        <canvas id="happinessLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.need_points")</h3>
                        <canvas id="needPointsLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.need_bonus")</h3>
                        <canvas id="needBonusLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.donation_points")</h3>
                        <canvas id="donationPointsLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.gold_points")</h3>
                        <canvas id="goldPointsLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.pension_points")</h3>
                        <canvas id="pensionPointsLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.saving_goal")</h3>
                        <canvas id="savingGoalLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.mission_penalty")</h3>
                        <canvas id="missionPenaltyLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.loan_penalty")</h3>
                        <canvas id="loanPenaltyLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.loan_unpaid")</h3>
                        <canvas id="loanUnpaidLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.orders_completed")</h3>
                        <canvas id="ordersCompletedLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.inventory_ingredient")</h3>
                        <canvas id="inventoryIngredientLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.actions_used")</h3>
                        <canvas id="actionsUsedLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.primary_need_compliance")</h3>
                        <canvas id="compliancePrimaryNeedLineChart" height="110"></canvas>
                    </article>
                    <article class="chart-card">
                        <h3 class="chart-title">@Context.T("metric.violations")</h3>
                        <canvas id="rulesViolationsLineChart" height="110"></canvas>
                    </article>
                </div>
            }
        }
        else if (playerSummary is null)
        {
            <div class="mt-6 alert alert-info">
                @Context.T("state.no_player_data")
            </div>
        }
        else
        {
            <div class="mt-8 chart-grid">
                <article class="chart-card">
                    <h3 class="chart-title">@Context.T("analytics.chart.personal_cashflow")</h3>
                    <canvas id="playerFinanceChart" height="120"></canvas>
                </article>
                <article class="chart-card">
                    <h3 class="chart-title">@Context.T("analytics.chart.game_points")</h3>
                    <canvas id="playerPointsChart" height="120"></canvas>
                </article>
                <article class="chart-card">
                    <h3 class="chart-title">@Context.T("analytics.chart.risk_control")</h3>
                    <canvas id="playerRiskChart" height="120"></canvas>
                </article>
                <article class="chart-card">
                    <h3 class="chart-title">@Context.T("analytics.chart.operations")</h3>
                    <canvas id="playerOperationsChart" height="120"></canvas>
                </article>
            </div>
        }

        var matrixPlayers = (isInstructor
                ? Model.Result.ByPlayer
                : Model.Result.ByPlayer.Where(item => playerSummary is not null && item.PlayerId == playerSummary.PlayerId))
            .ToList();
        <section class="mt-10 analytics-result-shell">
            <div class="analytics-workbench-header">
                <h2>@Context.T("analytics.section.minimum_matrix_title")</h2>
                <p>@Context.T("analytics.section.minimum_matrix_desc")</p>
            </div>

            <div class="mt-4 table-wrap analytics-table-block analytics-minimum-matrix analytics-minimum-matrix-fix">
                <table class="w-full min-w-[1440px] text-left text-sm analytics-minimum-matrix-table analytics-minimum-matrix-table-fix">
                    <thead class="table-head">
                        <tr>
                            <th class="px-4 py-3 whitespace-nowrap">@Context.T("common.player")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.cash_in")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.cash_out")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.net_cashflow")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.donation")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.gold_qty")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.orders_completed")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.inventory_ingredient")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.actions_used")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.primary_need_compliance")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.violations")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.happiness")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.need_points")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.need_bonus")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.donation_points")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.gold_points")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.pension_points")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.saving_goal")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.mission_penalty")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.loan_penalty")</th>
                            <th class="px-4 py-3 text-right whitespace-nowrap">@Context.T("metric.loan_unpaid")</th>
                        </tr>
                    </thead>
                    <tbody>
                    @if (matrixPlayers.Count == 0)
                    {
                        <tr>
                            <td class="px-4 py-4 text-slate-500 mobile-card-empty" colspan="21">@Context.T("state.no_player_data")</td>
                        </tr>
                    }
                    else
                    {
                        foreach (var item in matrixPlayers)
                        {
                            var netCash = item.CashInTotal - item.CashOutTotal;
                            <tr class="border-t border-slate-200">
                                <td class="px-4 py-3 text-slate-700" data-label="@Context.T("common.player")">@ResolvePlayerName(item.PlayerId)</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.cash_in")">@F(item.CashInTotal)</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.cash_out")">@F(item.CashOutTotal)</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.net_cashflow")">@F(netCash)</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.donation")">@F(item.DonationTotal)</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.gold_qty")">@item.GoldQty</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.orders_completed")">@item.OrdersCompletedCount</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.inventory_ingredient")">@item.InventoryIngredientTotal</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.actions_used")">@item.ActionsUsedTotal</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.primary_need_compliance")">@F(item.CompliancePrimaryNeedRate * 100)%</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.violations")">@item.RulesViolationsCount</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.happiness")">@F(item.HappinessPointsTotal)</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.need_points")">@F(item.NeedPointsTotal)</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.need_bonus")">@F(item.NeedSetBonusPoints)</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.donation_points")">@F(item.DonationPointsTotal)</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.gold_points")">@F(item.GoldPointsTotal)</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.pension_points")">@F(item.PensionPointsTotal)</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.saving_goal")">@F(item.SavingGoalPointsTotal)</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.mission_penalty")">@F(item.MissionPenaltyTotal)</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.loan_penalty")">@F(item.LoanPenaltyTotal)</td>
                                <td class="px-4 py-3 text-right" data-label="@Context.T("metric.loan_unpaid")">@((item.HasUnpaidLoan) ? Context.T("state.true") : Context.T("state.false"))</td>
                            </tr>
                        }
                    }
                    </tbody>
                </table>
            </div>
        </section>
    }

    @if (rulesetResult is not null)
    {
        var overallLearningScores = rulesetResult.Sessions
            .Select(session => session.LearningPerformanceAggregateScore)
            .Where(score => score.HasValue)
            .Select(score => score!.Value)
            .ToList();
        var overallMissionScores = rulesetResult.Sessions
            .Select(session => session.MissionPerformanceAggregateScore)
            .Where(score => score.HasValue)
            .Select(score => score!.Value)
            .ToList();

        string DescribeSessionAggregateReason(
            List<RulesetAnalyticsPlayerItemDto> players,
            Func<RulesetAnalyticsPlayerItemDto, double?> scoreSelector,
            string metricNameId,
            string metricNameEn)
        {
            var scores = players
                .Select(scoreSelector)
                .Where(score => score.HasValue)
                .Select(score => score!.Value)
                .ToList();
            if (scores.Count == 0)
            {
                return L(
                    $"{metricNameId} belum dapat dihitung karena belum ada nilai pengguna.",
                    $"{metricNameEn} is not available because there are no user scores yet.");
            }

            return L(
                $"{metricNameId} adalah rata-rata dari {scores.Count} nilai pengguna (rentang {scores.Min():0.00} - {scores.Max():0.00}).",
                $"{metricNameEn} is the average of {scores.Count} user scores (range {scores.Min():0.00} - {scores.Max():0.00}).");
        }

        string DescribeOverallAggregateReason(List<double> scores, string metricNameId, string metricNameEn)
        {
            if (scores.Count == 0)
            {
                return L(
                    $"{metricNameId} belum dapat dihitung karena belum ada data sesi.",
                    $"{metricNameEn} is not available because there is no session data yet.");
            }

            return L(
                $"{metricNameId} adalah rata-rata antar {scores.Count} sesi (rentang {scores.Min():0.00} - {scores.Max():0.00}).",
                $"{metricNameEn} is the average across {scores.Count} sessions (range {scores.Min():0.00} - {scores.Max():0.00}).");
        }

        var flatUserScores = rulesetResult.Sessions
            .SelectMany(session => session.Players.Select(player => new
            {
                session.SessionId,
                session.SessionName,
                session.Status,
                session.LearningPerformanceAggregateScore,
                session.MissionPerformanceAggregateScore,
                player.PlayerId,
                player.LearningPerformanceIndividualScore,
                player.MissionPerformanceIndividualScore
            }))
            .ToList();

        <section class="mt-10 analytics-result-shell">
            <div class="analytics-result-head">
                <div>
                    <p class="eyebrow">@Context.T("analytics.section.ruleset_title")</p>
                    <h2 class="headline text-2xl">@rulesetResult.RulesetName</h2>
                    <p class="subhead font-mono text-xs">@rulesetResult.RulesetId</p>
                </div>
            </div>

            <div class="mt-4 action-toolbar analytics-ruleset-actions">
                <a class="btn-ghost"
                   asp-controller="Rulesets"
                   asp-action="Details"
                   asp-route-rulesetId="@rulesetResult.RulesetId">@Context.T("common.view")</a>
                @if (isInstructor)
                {
                    <a class="btn-primary"
                       asp-controller="Rulesets"
                       asp-action="Edit"
                       asp-route-rulesetId="@rulesetResult.RulesetId">@Context.T("rulesets.edit")</a>
                }
            </div>

            <div class="mt-5 ruleset-stats">
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("rulesets.analytics.session_count")</p>
                    <p class="mt-2 text-2xl font-semibold text-slate-900">@rulesetResult.SessionCount</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("rulesets.analytics.learning_aggregate")</p>
                    <p class="mt-2 text-2xl font-semibold text-emerald-700">@(rulesetResult.LearningPerformanceAggregateScore?.ToString("0.00") ?? Context.T("common.na"))</p>
                    <p class="mt-2 text-xs text-slate-600">@DescribeOverallAggregateReason(overallLearningScores, Context.T("rulesets.analytics.learning_aggregate"), Context.T("rulesets.analytics.learning_aggregate"))</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs uppercase text-slate-500">@Context.T("rulesets.analytics.quest_aggregate")</p>
                    <p class="mt-2 text-2xl font-semibold text-slate-900">@(rulesetResult.MissionPerformanceAggregateScore?.ToString("0.00") ?? Context.T("common.na"))</p>
                    <p class="mt-2 text-xs text-slate-600">@DescribeOverallAggregateReason(overallMissionScores, Context.T("rulesets.analytics.quest_aggregate"), Context.T("rulesets.analytics.quest_aggregate"))</p>
                </div>
            </div>

            <div class="mt-6 table-wrap analytics-table-block">
                <table class="w-full text-left text-sm">
                    <thead class="table-head">
                        <tr>
                            <th class="px-4 py-3">@Context.T("rulesets.analytics.session")</th>
                            <th class="px-4 py-3">@Context.T("common.status")</th>
                            <th class="px-4 py-3 text-right">@Context.T("rulesets.analytics.events")</th>
                            <th class="px-4 py-3 text-right">@Context.T("rulesets.analytics.learning_aggregate")</th>
                            <th class="px-4 py-3 text-right">@Context.T("rulesets.analytics.quest_aggregate")</th>
                            <th class="px-4 py-3">@L("Alasan Agregat", "Aggregate Reason")</th>
                            <th class="px-4 py-3 text-right">@Context.T("rulesets.analytics.detail")</th>
                        </tr>
                    </thead>
                    <tbody>
                    @if (rulesetResult.Sessions.Count == 0)
                    {
                        <tr>
                            <td class="px-4 py-4 text-slate-500" colspan="7">@Context.T("rulesets.analytics.empty_sessions")</td>
                        </tr>
                    }
                    else
                    {
                        foreach (var item in rulesetResult.Sessions)
                        {
                            var learningReason = DescribeSessionAggregateReason(
                                item.Players,
                                player => player.LearningPerformanceIndividualScore,
                                Context.T("rulesets.analytics.learning_aggregate"),
                                Context.T("rulesets.analytics.learning_aggregate"));
                            var missionReason = DescribeSessionAggregateReason(
                                item.Players,
                                player => player.MissionPerformanceIndividualScore,
                                Context.T("rulesets.analytics.quest_aggregate"),
                                Context.T("rulesets.analytics.quest_aggregate"));
                            <tr class="border-t border-slate-200">
                                <td class="px-4 py-3 text-slate-700">@item.SessionName</td>
                                <td class="px-4 py-3 text-slate-700">
                                    @{
                                        var statusClass = string.Equals(item.Status, "STARTED", StringComparison.OrdinalIgnoreCase)
                                            ? "status-active"
                                            : string.Equals(item.Status, "CREATED", StringComparison.OrdinalIgnoreCase)
                                                ? "status-draft"
                                                : "status-retired";
                                    }
                                    <span class="status-pill @statusClass">@Context.TSessionStatus(item.Status)</span>
                                </td>
                                <td class="px-4 py-3 text-right">@item.EventCount</td>
                                <td class="px-4 py-3 text-right">@(item.LearningPerformanceAggregateScore?.ToString("0.00") ?? Context.T("common.na"))</td>
                                <td class="px-4 py-3 text-right">@(item.MissionPerformanceAggregateScore?.ToString("0.00") ?? Context.T("common.na"))</td>
                                <td class="px-4 py-3 text-xs text-slate-600">
                                    <div class="space-y-1">
                                        <p><span class="font-semibold text-slate-700">@Context.T("rulesets.analytics.learning_aggregate"):</span> @learningReason</p>
                                        <p><span class="font-semibold text-slate-700">@Context.T("rulesets.analytics.quest_aggregate"):</span> @missionReason</p>
                                    </div>
                                </td>
                                <td class="px-4 py-3 text-right">
                                    <a class="table-link"
                                       asp-controller="Sessions"
                                       asp-action="Details"
                                       asp-route-sessionId="@item.SessionId">@Context.T("common.view")</a>
                                </td>
                            </tr>
                        }
                    }
                    </tbody>
                </table>
            </div>

            <div class="mt-6 table-wrap analytics-table-block">
                <table class="w-full text-left text-sm">
                    <thead class="table-head">
                        <tr>
                            <th class="px-4 py-3">@Context.T("rulesets.analytics.session")</th>
                            <th class="px-4 py-3">@Context.T("common.player")</th>
                            <th class="px-4 py-3 text-right">@Context.T("rulesets.analytics.user_learning")</th>
                            <th class="px-4 py-3 text-right">@Context.T("rulesets.analytics.user_quest")</th>
                            <th class="px-4 py-3">@L("Alasan Nilai Pengguna", "User Score Reason")</th>
                        </tr>
                    </thead>
                    <tbody>
                    @if (flatUserScores.Count == 0)
                    {
                        <tr>
                            <td class="px-4 py-4 text-slate-500" colspan="5">@Context.T("rulesets.analytics.player_performance_empty")</td>
                        </tr>
                    }
                    else
                    {
                        foreach (var item in flatUserScores)
                        {
                            var userLearningReason = item.LearningPerformanceIndividualScore.HasValue
                                ? L(
                                    $"Dihitung dari 40% arus kas bersih, 35% kepatuhan kebutuhan primer, dan 25% poin kebahagiaan. Nilai ini ikut dirata-ratakan ke agregat sesi ({item.LearningPerformanceAggregateScore?.ToString("0.00") ?? Context.T("common.na")}).",
                                    $"Computed from 40% net cashflow, 35% primary-need compliance, and 25% happiness points. This score contributes to the session aggregate ({item.LearningPerformanceAggregateScore?.ToString("0.00") ?? Context.T("common.na")}).")
                                : L(
                                    "Belum ada komponen data yang cukup untuk menghitung performa pembelajaran pengguna.",
                                    "There are not enough data components yet to compute user learning performance.");
                            var userMissionReason = item.MissionPerformanceIndividualScore.HasValue
                                ? L(
                                    $"Dihitung dari 100 - (penalti misi + penalti pinjaman), lalu dibatasi 0 sampai 100. Nilai ini ikut dirata-ratakan ke agregat sesi ({item.MissionPerformanceAggregateScore?.ToString("0.00") ?? Context.T("common.na")}).",
                                    $"Computed as 100 - (mission penalty + loan penalty), then clamped to 0-100. This score contributes to the session aggregate ({item.MissionPerformanceAggregateScore?.ToString("0.00") ?? Context.T("common.na")}).")
                                : L(
                                    "Belum ada komponen penalti yang cukup untuk menghitung performa misi pengguna.",
                                    "There are not enough penalty components yet to compute user mission performance.");
                            <tr class="border-t border-slate-200">
                                <td class="px-4 py-3 text-slate-700">
                                    <div class="font-semibold">@item.SessionName</div>
                                    <div class="mt-1 text-xs text-slate-500 font-mono">@item.SessionId</div>
                                </td>
                                <td class="px-4 py-3 text-slate-700">@ResolvePlayerName(item.PlayerId)</td>
                                <td class="px-4 py-3 text-right">@(item.LearningPerformanceIndividualScore?.ToString("0.00") ?? Context.T("common.na"))</td>
                                <td class="px-4 py-3 text-right">@(item.MissionPerformanceIndividualScore?.ToString("0.00") ?? Context.T("common.na"))</td>
                                <td class="px-4 py-3 text-xs text-slate-600">
                                    <div class="space-y-1">
                                        <p><span class="font-semibold text-slate-700">@Context.T("rulesets.analytics.user_learning"):</span> @userLearningReason</p>
                                        <p><span class="font-semibold text-slate-700">@Context.T("rulesets.analytics.user_quest"):</span> @userMissionReason</p>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    </tbody>
                </table>
            </div>
        </section>
    }
</section>

@section Scripts {
    @if (Model.Result is not null)
    {
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
        <script>
            (() => {
                const chartUnavailableMessage = @Html.Raw(JsonSerializer.Serialize(Context.T("analytics.chart.unavailable")));
                const chartNoDataMessage = @Html.Raw(JsonSerializer.Serialize(Context.T("analytics.chart.no_data")));
                try {
                const renderChartMessage = (canvas, message) => {
                    if (!canvas) {
                        return;
                    }

                    const chartCard = canvas.closest(".chart-card");
                    if (!chartCard) {
                        return;
                    }

                    canvas.style.display = "none";
                    if (chartCard.querySelector(".chart-fallback-text")) {
                        return;
                    }

                    const helperText = document.createElement("p");
                    helperText.className = "chart-fallback-text mt-2 text-sm text-slate-500";
                    helperText.textContent = message;
                    chartCard.appendChild(helperText);
                };

                if (typeof Chart === "undefined") {
                    document.querySelectorAll(".chart-card canvas").forEach((canvas) => {
                        renderChartMessage(canvas, chartUnavailableMessage);
                    });
                    return;
                }

                const rawData = @Html.Raw(JsonSerializer.Serialize(Model.Result));
                const playerNameLookupRaw = @Html.Raw(JsonSerializer.Serialize(Model.PlayerDisplayNames.ToDictionary(kvp => kvp.Key.ToString(), kvp => kvp.Value)));
                const isPlayerDashboard = @((!Model.IsInstructor).ToString().ToLowerInvariant());
                const playerLabelPrefix = @Html.Raw(JsonSerializer.Serialize(Context.T("common.player")));
                const chartText = {
                    event: @Html.Raw(JsonSerializer.Serialize(Context.T("analytics.chart.event"))),
                    cashIn: @Html.Raw(JsonSerializer.Serialize(Context.T("analytics.chart.cash_in"))),
                    cashOut: @Html.Raw(JsonSerializer.Serialize(Context.T("analytics.chart.cash_out"))),
                    net: @Html.Raw(JsonSerializer.Serialize(Context.T("analytics.chart.net"))),
                    summary: @Html.Raw(JsonSerializer.Serialize(Context.T("analytics.chart.summary"))),
                    value: @Html.Raw(JsonSerializer.Serialize(Context.T("analytics.chart.value"))),
                    points: @Html.Raw(JsonSerializer.Serialize(Context.T("analytics.chart.points"))),
                    risk: @Html.Raw(JsonSerializer.Serialize(Context.T("analytics.chart.risk"))),
                    donation: @Html.Raw(JsonSerializer.Serialize(Context.T("metric.donation"))),
                    happiness: @Html.Raw(JsonSerializer.Serialize(Context.T("metric.happiness"))),
                    needPoints: @Html.Raw(JsonSerializer.Serialize(Context.T("metric.need_points"))),
                    needBonus: @Html.Raw(JsonSerializer.Serialize(Context.T("metric.need_bonus"))),
                    donationPoints: @Html.Raw(JsonSerializer.Serialize(Context.T("metric.donation_points"))),
                    goldPoints: @Html.Raw(JsonSerializer.Serialize(Context.T("metric.gold_points"))),
                    pensionPoints: @Html.Raw(JsonSerializer.Serialize(Context.T("metric.pension_points"))),
                    savingGoal: @Html.Raw(JsonSerializer.Serialize(Context.T("metric.saving_goal"))),
                    missionPenalty: @Html.Raw(JsonSerializer.Serialize(Context.T("metric.mission_penalty"))),
                    loanPenalty: @Html.Raw(JsonSerializer.Serialize(Context.T("metric.loan_penalty"))),
                    loanUnpaid: @Html.Raw(JsonSerializer.Serialize(Context.T("metric.loan_unpaid"))),
                    ordersCompleted: @Html.Raw(JsonSerializer.Serialize(Context.T("metric.orders_completed"))),
                    inventoryIngredient: @Html.Raw(JsonSerializer.Serialize(Context.T("metric.inventory_ingredient"))),
                    actionsUsed: @Html.Raw(JsonSerializer.Serialize(Context.T("metric.actions_used"))),
                    primaryNeedCompliance: @Html.Raw(JsonSerializer.Serialize(Context.T("metric.primary_need_compliance"))),
                    violations: @Html.Raw(JsonSerializer.Serialize(Context.T("metric.violations")))
                };

                const hasOwn = (obj, key) => Object.prototype.hasOwnProperty.call(obj, key);
                const toCamel = (key) => key.replace(/_([a-z])/g, (_, character) => character.toUpperCase());
                const toPascal = (key) => key.length === 0 ? key : `${key[0].toUpperCase()}${key.slice(1)}`;
                const getProp = (obj, snakeKey, explicitPascalKey = null) => {
                    if (!obj || typeof obj !== "object") {
                        return undefined;
                    }

                    if (hasOwn(obj, snakeKey)) {
                        return obj[snakeKey];
                    }

                    const camelKey = toCamel(snakeKey);
                    if (hasOwn(obj, camelKey)) {
                        return obj[camelKey];
                    }

                    const pascalKey = explicitPascalKey ?? toPascal(camelKey);
                    if (hasOwn(obj, pascalKey)) {
                        return obj[pascalKey];
                    }

                    return undefined;
                };
                const toNumber = (value, fallback = 0) => {
                    const numericValue = Number(value);
                    return Number.isFinite(numericValue) ? numericValue : fallback;
                };
                const toBoolean = (value) => {
                    if (typeof value === "boolean") {
                        return value;
                    }

                    if (typeof value === "number") {
                        return value !== 0;
                    }

                    if (typeof value === "string") {
                        const normalizedValue = value.trim().toLowerCase();
                        return normalizedValue === "true" || normalizedValue === "1";
                    }

                    return false;
                };

                const summarySource = getProp(rawData, "summary", "Summary") ?? {};
                const rawPlayers = getProp(rawData, "by_player", "ByPlayer");
                const players = Array.isArray(rawPlayers)
                    ? rawPlayers.map((player) => ({
                        player_id: `${getProp(player, "player_id", "PlayerId") ?? ""}`,
                        cash_in_total: toNumber(getProp(player, "cash_in_total", "CashInTotal")),
                        cash_out_total: toNumber(getProp(player, "cash_out_total", "CashOutTotal")),
                        donation_total: toNumber(getProp(player, "donation_total", "DonationTotal")),
                        gold_qty: toNumber(getProp(player, "gold_qty", "GoldQty")),
                        happiness_points_total: toNumber(getProp(player, "happiness_points_total", "HappinessPointsTotal")),
                        need_points_total: toNumber(getProp(player, "need_points_total", "NeedPointsTotal")),
                        need_set_bonus_points: toNumber(getProp(player, "need_set_bonus_points", "NeedSetBonusPoints")),
                        donation_points_total: toNumber(getProp(player, "donation_points_total", "DonationPointsTotal")),
                        gold_points_total: toNumber(getProp(player, "gold_points_total", "GoldPointsTotal")),
                        pension_points_total: toNumber(getProp(player, "pension_points_total", "PensionPointsTotal")),
                        saving_goal_points_total: toNumber(getProp(player, "saving_goal_points_total", "SavingGoalPointsTotal")),
                        mission_penalty_total: toNumber(getProp(player, "mission_penalty_total", "MissionPenaltyTotal")),
                        loan_penalty_total: toNumber(getProp(player, "loan_penalty_total", "LoanPenaltyTotal")),
                        has_unpaid_loan: toBoolean(getProp(player, "has_unpaid_loan", "HasUnpaidLoan")),
                        orders_completed_count: toNumber(getProp(player, "orders_completed_count", "OrdersCompletedCount")),
                        inventory_ingredient_total: toNumber(getProp(player, "inventory_ingredient_total", "InventoryIngredientTotal")),
                        actions_used_total: toNumber(getProp(player, "actions_used_total", "ActionsUsedTotal")),
                        compliance_primary_need_rate: toNumber(getProp(player, "compliance_primary_need_rate", "CompliancePrimaryNeedRate")),
                        rules_violations_count: toNumber(getProp(player, "rules_violations_count", "RulesViolationsCount"))
                    }))
                    : [];
                const summary = {
                    event_count: toNumber(getProp(summarySource, "event_count", "EventCount")),
                    cash_in_total: toNumber(getProp(summarySource, "cash_in_total", "CashInTotal")),
                    cash_out_total: toNumber(getProp(summarySource, "cash_out_total", "CashOutTotal")),
                    cashflow_net_total: toNumber(getProp(summarySource, "cashflow_net_total", "CashflowNetTotal")),
                    rules_violations_count: toNumber(getProp(summarySource, "rules_violations_count", "RulesViolationsCount"))
                };

                const playerNameLookup = Object.fromEntries(
                    Object.entries(playerNameLookupRaw ?? {}).map(([key, value]) => [key.toLowerCase(), value])
                );
                const playerLabels = players.map((player, idx) => {
                    const playerId = `${player.player_id ?? ""}`.toLowerCase();
                    return playerNameLookup[playerId] ?? `${playerLabelPrefix} ${idx + 1}`;
                });
                const metricPlayerSlots = [0, 1, 2, 3];
                const metricPlayerLabels = metricPlayerSlots.map((idx) => `${playerLabelPrefix} ${idx + 1}`);

                const makeChart = (canvasId, type, labels, datasets, options = {}) => {
                    const el = document.getElementById(canvasId);
                    if (!el) {
                        return;
                    }

                    if (!Array.isArray(labels) || labels.length === 0 || !Array.isArray(datasets) || datasets.length === 0) {
                        renderChartMessage(el, chartNoDataMessage);
                        return;
                    }

                    const hasDatasetValue = datasets.some((dataset) =>
                        Array.isArray(dataset?.data) && dataset.data.some((value) => Number.isFinite(Number(value)))
                    );
                    if (!hasDatasetValue) {
                        renderChartMessage(el, chartNoDataMessage);
                        return;
                    }

                    try {
                        new Chart(el, {
                            type,
                            data: { labels, datasets },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                aspectRatio: 2.2,
                                scales: {
                                    y: { beginAtZero: true }
                                },
                                plugins: {
                                    legend: { display: datasets.length > 1 }
                                },
                                ...options
                            }
                        });
                    } catch (error) {
                        console.error("Failed to render chart", canvasId, error);
                        renderChartMessage(el, chartUnavailableMessage);
                    }
                };

                if (isPlayerDashboard) {
                    const me = players[0];
                    if (!me) {
                        document.querySelectorAll(".chart-card canvas").forEach((canvas) => {
                            renderChartMessage(canvas, chartNoDataMessage);
                        });
                        return;
                    }

                    const netCash = (me.cash_in_total ?? 0) - (me.cash_out_total ?? 0);

                    makeChart("playerFinanceChart", "bar",
                        [chartText.cashIn, chartText.cashOut, chartText.net, chartText.donation],
                        [{
                            label: chartText.value,
                            data: [me.cash_in_total ?? 0, me.cash_out_total ?? 0, netCash, me.donation_total ?? 0],
                            backgroundColor: ["#2d7dd2", "#e95a4b", "#1ba784", "#f39c12"],
                            borderColor: ["#1f5aa0", "#b73f31", "#157f63", "#bf7608"],
                            borderWidth: 1.2
                        }],
                        {
                            plugins: { legend: { display: false } }
                        });

                    makeChart("playerPointsChart", "bar",
                        [chartText.happiness, chartText.needPoints, chartText.needBonus, chartText.donationPoints, chartText.goldPoints, chartText.pensionPoints, chartText.savingGoal],
                        [{
                            label: chartText.points,
                            data: [
                                me.happiness_points_total ?? 0,
                                me.need_points_total ?? 0,
                                me.need_set_bonus_points ?? 0,
                                me.donation_points_total ?? 0,
                                me.gold_points_total ?? 0,
                                me.pension_points_total ?? 0,
                                me.saving_goal_points_total ?? 0
                            ],
                            backgroundColor: "#3f74ff99",
                            borderColor: "#2d5ce0",
                            borderWidth: 1.2
                        }],
                        {
                            plugins: { legend: { display: false } }
                        });

                    makeChart("playerRiskChart", "bar",
                        [chartText.missionPenalty, chartText.loanPenalty, chartText.loanUnpaid],
                        [{
                            label: chartText.risk,
                            data: [me.mission_penalty_total ?? 0, me.loan_penalty_total ?? 0, me.has_unpaid_loan ? 1 : 0],
                            backgroundColor: ["#ef4e4e99", "#d1495b99", "#37415199"],
                            borderColor: ["#bf2e2e", "#a53344", "#1f2937"],
                            borderWidth: 1.2
                        }],
                        {
                            plugins: { legend: { display: false } }
                        });

                    makeChart("playerOperationsChart", "bar",
                        [chartText.ordersCompleted, chartText.inventoryIngredient, chartText.actionsUsed, chartText.primaryNeedCompliance, chartText.violations],
                        [{
                            label: chartText.value,
                            data: [
                                me.orders_completed_count ?? 0,
                                me.inventory_ingredient_total ?? 0,
                                me.actions_used_total ?? 0,
                                (me.compliance_primary_need_rate ?? 0) * 100,
                                me.rules_violations_count ?? 0
                            ],
                            backgroundColor: ["#2563eb99", "#0ea5e999", "#7c3aed99", "#16a34a99", "#dc262699"],
                            borderColor: ["#1d4ed8", "#0284c7", "#6d28d9", "#15803d", "#b91c1c"],
                            borderWidth: 1.2
                        }],
                        {
                            plugins: { legend: { display: false } }
                        });

                    return;
                }

                makeChart("summaryLineChart", "line",
                    [chartText.event, chartText.cashIn, chartText.cashOut, chartText.net, chartText.violations],
                    [{
                        label: chartText.summary,
                        data: [
                            summary.event_count,
                            summary.cash_in_total,
                            summary.cash_out_total,
                            summary.cashflow_net_total,
                            summary.rules_violations_count
                        ],
                        borderColor: "#e95a4b",
                        backgroundColor: "rgba(233, 90, 75, 0.18)",
                        tension: 0.32,
                        pointRadius: 4,
                        fill: true
                    }]);

                makeChart("cashflowLineChart", "line", playerLabels, [
                    {
                        label: chartText.cashIn,
                        data: players.map((p) => p.cash_in_total),
                        borderColor: "#1ba784",
                        backgroundColor: "rgba(27, 167, 132, 0.15)",
                        tension: 0.32,
                        pointRadius: 3
                    },
                    {
                        label: chartText.cashOut,
                        data: players.map((p) => p.cash_out_total),
                        borderColor: "#e95a4b",
                        backgroundColor: "rgba(233, 90, 75, 0.15)",
                        tension: 0.32,
                        pointRadius: 3
                    },
                    {
                        label: chartText.donation,
                        data: players.map((p) => p.donation_total),
                        borderColor: "#3f74ff",
                        backgroundColor: "rgba(63, 116, 255, 0.15)",
                        tension: 0.32,
                        pointRadius: 3
                    }
                ]);

                const metricCharts = [
                    { id: "donationLineChart", key: "donation_total", color: "#18a8a0", label: chartText.donation },
                    { id: "goldQtyLineChart", key: "gold_qty", color: "#f39c12", label: @Html.Raw(JsonSerializer.Serialize(Context.T("metric.gold_qty"))) },
                    { id: "happinessLineChart", key: "happiness_points_total", color: "#ef4e4e", label: chartText.happiness },
                    { id: "needPointsLineChart", key: "need_points_total", color: "#2a9d8f", label: chartText.needPoints },
                    { id: "needBonusLineChart", key: "need_set_bonus_points", color: "#2fa56e", label: chartText.needBonus },
                    { id: "donationPointsLineChart", key: "donation_points_total", color: "#2d7dd2", label: chartText.donationPoints },
                    { id: "goldPointsLineChart", key: "gold_points_total", color: "#dd9f00", label: chartText.goldPoints },
                    { id: "pensionPointsLineChart", key: "pension_points_total", color: "#ff7f50", label: chartText.pensionPoints },
                    { id: "savingGoalLineChart", key: "saving_goal_points_total", color: "#00a6a6", label: chartText.savingGoal },
                    { id: "missionPenaltyLineChart", key: "mission_penalty_total", color: "#c64f40", label: chartText.missionPenalty },
                    { id: "loanPenaltyLineChart", key: "loan_penalty_total", color: "#d1495b", label: chartText.loanPenalty },
                    { id: "loanUnpaidLineChart", key: "has_unpaid_loan", color: "#374151", boolToNum: true, label: chartText.loanUnpaid },
                    { id: "ordersCompletedLineChart", key: "orders_completed_count", color: "#2563eb", label: chartText.ordersCompleted },
                    { id: "inventoryIngredientLineChart", key: "inventory_ingredient_total", color: "#0ea5e9", label: chartText.inventoryIngredient },
                    { id: "actionsUsedLineChart", key: "actions_used_total", color: "#7c3aed", label: chartText.actionsUsed },
                    { id: "compliancePrimaryNeedLineChart", key: "compliance_primary_need_rate", color: "#16a34a", multiply: 100, label: chartText.primaryNeedCompliance },
                    { id: "rulesViolationsLineChart", key: "rules_violations_count", color: "#dc2626", label: chartText.violations }
                ];

                metricCharts.forEach((metric) => {
                    const values = metricPlayerSlots.map((slotIndex) => {
                        const p = players[slotIndex];
                        if (!p) {
                            return 0;
                        }

                        if (metric.boolToNum) {
                            return p[metric.key] ? 1 : 0;
                        }
                        const numericValue = p[metric.key] ?? 0;
                        return metric.multiply ? numericValue * metric.multiply : numericValue;
                    });

                    makeChart(metric.id, "line", metricPlayerLabels, [{
                        label: metric.label,
                        data: values,
                        borderColor: metric.color,
                        backgroundColor: `${metric.color}33`,
                        tension: 0.32,
                        pointRadius: 3,
                        fill: true
                    }]);
                });
                } catch (error) {
                    console.error("Failed to initialize analytics charts", error);
                    document.querySelectorAll(".chart-card canvas").forEach((canvas) => {
                        const chartCard = canvas.closest(".chart-card");
                        if (!chartCard || chartCard.querySelector(".chart-fallback-text")) {
                            return;
                        }

                        canvas.style.display = "none";
                        const helperText = document.createElement("p");
                        helperText.className = "chart-fallback-text mt-2 text-sm text-slate-500";
                        helperText.textContent = chartUnavailableMessage;
                        chartCard.appendChild(helperText);
                    });
                }
            })();
        </script>

    }
}
