@* Fungsi file: Merender tampilan Razor untuk bagian Analytics/_RulesetAnalyticsSection.cshtml beserta interaksi presentasinya. *@
@model Cashflowpoly.Ui.Models.AnalyticsSearchViewModel
@using System.Linq
@using Microsoft.AspNetCore.Http

@{
    var isInstructor = Model.IsInstructor;
    var rulesetResult = Model.RulesetResult;
    var playerDisplayNames = Model.PlayerDisplayNames;
    var activeLanguage = UiText.NormalizeLanguage(Context.Session.GetString(AuthConstants.SessionLanguageKey));
    var isEnglish = string.Equals(activeLanguage, AuthConstants.LanguageEn, StringComparison.OrdinalIgnoreCase);
    string L(string id, string en) => isEnglish ? en : id;

    string ResolvePlayerName(Guid playerId)
    {
        if (playerDisplayNames.TryGetValue(playerId, out var displayName) && !string.IsNullOrWhiteSpace(displayName))
        {
            return displayName;
        }

        return Context.T("common.player");
    }
}

@if (rulesetResult is not null)
{
    var overallLearningScores = rulesetResult.Sessions
        .Select(session => session.LearningPerformanceAggregateScore)
        .Where(score => score.HasValue)
        .Select(score => score!.Value)
        .ToList();
    var overallMissionScores = rulesetResult.Sessions
        .Select(session => session.MissionPerformanceAggregateScore)
        .Where(score => score.HasValue)
        .Select(score => score!.Value)
        .ToList();

    string DescribeSessionAggregateReason(
        List<RulesetAnalyticsPlayerItemDto> players,
        Func<RulesetAnalyticsPlayerItemDto, double?> scoreSelector,
        string metricNameId,
        string metricNameEn)
    {
        var scores = players
            .Select(scoreSelector)
            .Where(score => score.HasValue)
            .Select(score => score!.Value)
            .ToList();
        if (scores.Count == 0)
        {
            return L(
                $"{metricNameId} belum dapat dihitung karena belum ada nilai pengguna.",
                $"{metricNameEn} is not available because there are no user scores yet.");
        }

        return L(
            $"{metricNameId} adalah rata-rata dari {scores.Count} nilai pengguna (rentang {scores.Min():0.00} - {scores.Max():0.00}).",
            $"{metricNameEn} is the average of {scores.Count} user scores (range {scores.Min():0.00} - {scores.Max():0.00}).");
    }

    string DescribeOverallAggregateReason(List<double> scores, string metricNameId, string metricNameEn)
    {
        if (scores.Count == 0)
        {
            return L(
                $"{metricNameId} belum dapat dihitung karena belum ada data sesi.",
                $"{metricNameEn} is not available because there is no session data yet.");
        }

        return L(
            $"{metricNameId} adalah rata-rata antar {scores.Count} sesi (rentang {scores.Min():0.00} - {scores.Max():0.00}).",
            $"{metricNameEn} is the average across {scores.Count} sessions (range {scores.Min():0.00} - {scores.Max():0.00}).");
    }

    var flatUserScores = rulesetResult.Sessions
        .SelectMany(session => session.Players.Select(player => new
        {
            session.SessionId,
            session.SessionName,
            session.Status,
            session.LearningPerformanceAggregateScore,
            session.MissionPerformanceAggregateScore,
            player.PlayerId,
            player.LearningPerformanceIndividualScore,
            player.MissionPerformanceIndividualScore
        }))
        .ToList();
    var userLearningInfo = L(
        "Performa pembelajaran pengguna dihitung dari 40% arus kas bersih, 35% kepatuhan kebutuhan primer, dan 25% poin kebahagiaan.",
        "User learning performance is computed from 40% net cashflow, 35% primary-need compliance, and 25% happiness points.");
    var userMissionInfo = L(
        "Performa misi pengguna dihitung dengan rumus 100 - (penalti misi + penalti pinjaman), lalu dibatasi pada rentang 0 sampai 100.",
        "User mission performance is computed as 100 - (mission penalty + loan penalty), then clamped to 0-100.");

    <section class="mt-10 analytics-result-shell">
        <div class="analytics-result-head">
            <div>
                <p class="eyebrow">@Context.T("analytics.section.ruleset_title")</p>
                <h2 class="headline text-2xl">@rulesetResult.RulesetName</h2>
                <p class="subhead font-mono text-xs">@rulesetResult.RulesetId</p>
            </div>
        </div>

        <div class="mt-4 action-toolbar analytics-ruleset-actions">
            <a class="btn-ghost"
               asp-controller="Rulesets"
               asp-action="Details"
               asp-route-rulesetId="@rulesetResult.RulesetId">@Context.T("common.view")</a>
            @if (isInstructor)
            {
                <a class="btn-primary"
                   asp-controller="Rulesets"
                   asp-action="Edit"
                   asp-route-rulesetId="@rulesetResult.RulesetId">@Context.T("rulesets.edit")</a>
            }
        </div>

        <div class="mt-5 ruleset-stats">
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("rulesets.analytics.session_count")</p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">@rulesetResult.SessionCount</p>
            </div>
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("rulesets.analytics.learning_aggregate")</p>
                <p class="mt-2 text-2xl font-semibold text-emerald-700">@(rulesetResult.LearningPerformanceAggregateScore?.ToString("0.00") ?? Context.T("common.na"))</p>
                <p class="mt-2 text-xs text-slate-600">@DescribeOverallAggregateReason(overallLearningScores, Context.T("rulesets.analytics.learning_aggregate"), Context.T("rulesets.analytics.learning_aggregate"))</p>
            </div>
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("rulesets.analytics.quest_aggregate")</p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">@(rulesetResult.MissionPerformanceAggregateScore?.ToString("0.00") ?? Context.T("common.na"))</p>
                <p class="mt-2 text-xs text-slate-600">@DescribeOverallAggregateReason(overallMissionScores, Context.T("rulesets.analytics.quest_aggregate"), Context.T("rulesets.analytics.quest_aggregate"))</p>
            </div>
        </div>

        <div class="mt-6 table-wrap analytics-table-block">
            <table class="w-full text-left text-sm">
                <thead class="table-head">
                    <tr>
                        <th class="px-4 py-3">@Context.T("rulesets.analytics.session")</th>
                        <th class="px-4 py-3">@Context.T("common.status")</th>
                        <th class="px-4 py-3 text-right">@Context.T("rulesets.analytics.events")</th>
                        <th class="px-4 py-3 text-right">@Context.T("rulesets.analytics.learning_aggregate")</th>
                        <th class="px-4 py-3 text-right">@Context.T("rulesets.analytics.quest_aggregate")</th>
                        <th class="px-4 py-3">@L("Alasan Agregat", "Aggregate Reason")</th>
                        <th class="px-4 py-3 text-right">@Context.T("rulesets.analytics.detail")</th>
                    </tr>
                </thead>
                <tbody>
                @if (rulesetResult.Sessions.Count == 0)
                {
                    <tr>
                        <td class="px-4 py-4 text-slate-500" colspan="7">@Context.T("rulesets.analytics.empty_sessions")</td>
                    </tr>
                }
                else
                {
                    foreach (var item in rulesetResult.Sessions)
                    {
                        var learningReason = DescribeSessionAggregateReason(
                            item.Players,
                            player => player.LearningPerformanceIndividualScore,
                            Context.T("rulesets.analytics.learning_aggregate"),
                            Context.T("rulesets.analytics.learning_aggregate"));
                        var missionReason = DescribeSessionAggregateReason(
                            item.Players,
                            player => player.MissionPerformanceIndividualScore,
                            Context.T("rulesets.analytics.quest_aggregate"),
                            Context.T("rulesets.analytics.quest_aggregate"));
                        <tr class="border-t border-slate-200">
                            <td class="px-4 py-3 text-slate-700">@item.SessionName</td>
                            <td class="px-4 py-3 text-slate-700">
                                @{
                                    var statusClass = string.Equals(item.Status, "STARTED", StringComparison.OrdinalIgnoreCase)
                                        ? "status-active"
                                        : string.Equals(item.Status, "CREATED", StringComparison.OrdinalIgnoreCase)
                                            ? "status-draft"
                                            : "status-retired";
                                }
                                <span class="status-pill @statusClass">@Context.TSessionStatus(item.Status)</span>
                            </td>
                            <td class="px-4 py-3 text-right">@item.EventCount</td>
                            <td class="px-4 py-3 text-right">@(item.LearningPerformanceAggregateScore?.ToString("0.00") ?? Context.T("common.na"))</td>
                            <td class="px-4 py-3 text-right">@(item.MissionPerformanceAggregateScore?.ToString("0.00") ?? Context.T("common.na"))</td>
                            <td class="px-4 py-3 text-xs text-slate-600">
                                <div class="space-y-1">
                                    <p><span class="font-semibold text-slate-700">@Context.T("rulesets.analytics.learning_aggregate"):</span> @learningReason</p>
                                    <p><span class="font-semibold text-slate-700">@Context.T("rulesets.analytics.quest_aggregate"):</span> @missionReason</p>
                                </div>
                            </td>
                            <td class="px-4 py-3 text-right">
                                <a class="table-link"
                                   asp-controller="Sessions"
                                   asp-action="Details"
                                   asp-route-sessionId="@item.SessionId">@Context.T("common.view")</a>
                            </td>
                        </tr>
                    }
                }
                </tbody>
            </table>
        </div>

        <div class="mt-6 table-wrap analytics-table-block">
            <table class="w-full text-left text-sm">
                <thead class="table-head">
                    <tr>
                        <th class="px-4 py-3">@Context.T("rulesets.analytics.session")</th>
                        <th class="px-4 py-3">@Context.T("common.player")</th>
                        <th class="px-4 py-3 text-right">
                            <div class="metric-head-info">
                                <span>@Context.T("rulesets.analytics.user_learning")</span>
                                <details class="score-info">
                                    <summary class="score-info__button">@L("Info", "Info")</summary>
                                    <div class="score-info__panel">@userLearningInfo</div>
                                </details>
                            </div>
                        </th>
                        <th class="px-4 py-3 text-right">
                            <div class="metric-head-info">
                                <span>@Context.T("rulesets.analytics.user_quest")</span>
                                <details class="score-info">
                                    <summary class="score-info__button">@L("Info", "Info")</summary>
                                    <div class="score-info__panel">@userMissionInfo</div>
                                </details>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                @if (flatUserScores.Count == 0)
                {
                    <tr>
                        <td class="px-4 py-4 text-slate-500" colspan="4">@Context.T("rulesets.analytics.player_performance_empty")</td>
                    </tr>
                }
                else
                {
                    foreach (var item in flatUserScores)
                    {
                        <tr class="border-t border-slate-200">
                            <td class="px-4 py-3 text-slate-700">
                                <div class="font-semibold">@item.SessionName</div>
                                <div class="mt-1 text-xs text-slate-500 font-mono">@item.SessionId</div>
                            </td>
                            <td class="px-4 py-3 text-slate-700">@ResolvePlayerName(item.PlayerId)</td>
                            <td class="px-4 py-3 text-right">@(item.LearningPerformanceIndividualScore?.ToString("0.00") ?? Context.T("common.na"))</td>
                            <td class="px-4 py-3 text-right">@(item.MissionPerformanceIndividualScore?.ToString("0.00") ?? Context.T("common.na"))</td>
                        </tr>
                    }
                }
                </tbody>
            </table>
        </div>
    </section>
}
