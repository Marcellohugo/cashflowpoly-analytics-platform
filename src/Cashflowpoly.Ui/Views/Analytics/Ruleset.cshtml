@model Cashflowpoly.Ui.Models.RulesetAnalyticsViewModel

@{
    ViewData["Title"] = Context.T("rulesets.analytics.title");
}

<section class="section-shell">
    <div class="ruleset-hero">
        <div>
            <p class="eyebrow text-emerald-700">@Context.T("rulesets.analytics.title")</p>
            <h1 class="headline">@Context.T("rulesets.analytics.subtitle")</h1>
            <p class="mt-2 text-xs text-slate-500 font-mono">@Model.RulesetId</p>
        </div>
        <div class="ruleset-hero-meta">
            <a class="btn-ghost" asp-controller="Rulesets" asp-action="Details" asp-route-rulesetId="@Model.RulesetId">@Context.T("rulesets.analytics.back")</a>
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
    {
        <div class="mt-4 alert alert-error" aria-live="polite">
            @Model.ErrorMessage
        </div>
    }

    @if (Model.Result is not null)
    {
        var flatUserScores = Model.Result.Sessions
            .SelectMany(session => session.Players.Select(player => new
            {
                session.SessionId,
                session.SessionName,
                session.Status,
                player.PlayerId,
                player.LearningPerformanceIndividualScore,
                player.MissionPerformanceIndividualScore
            }))
            .ToList();

        <div class="mt-6 grid gap-4 md:grid-cols-3">
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("rulesets.analytics.session_count")</p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">@Model.Result.SessionCount</p>
            </div>
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("rulesets.analytics.learning_aggregate")</p>
                <p class="mt-2 text-2xl font-semibold text-emerald-700">@(Model.Result.LearningPerformanceAggregateScore?.ToString("0.00") ?? "N/A")</p>
            </div>
            <div class="stat-card">
                <p class="text-xs uppercase text-slate-500">@Context.T("rulesets.analytics.quest_aggregate")</p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">@(Model.Result.MissionPerformanceAggregateScore?.ToString("0.00") ?? "N/A")</p>
            </div>
        </div>

        <div class="mt-8 table-wrap">
            <table class="w-full text-left text-sm">
                <thead class="table-head">
                    <tr>
                        <th class="px-4 py-3">@Context.T("rulesets.analytics.session")</th>
                        <th class="px-4 py-3">@Context.T("common.status")</th>
                        <th class="px-4 py-3 text-right">@Context.T("rulesets.analytics.events")</th>
                        <th class="px-4 py-3 text-right">@Context.T("rulesets.analytics.learning_aggregate")</th>
                        <th class="px-4 py-3 text-right">@Context.T("rulesets.analytics.quest_aggregate")</th>
                        <th class="px-4 py-3 text-right">@Context.T("rulesets.analytics.detail")</th>
                    </tr>
                </thead>
                <tbody>
                @if (Model.Result.Sessions.Count == 0)
                {
                    <tr>
                        <td class="px-4 py-4 text-slate-500" colspan="6">@Context.T("rulesets.analytics.empty_sessions")</td>
                    </tr>
                }
                else
                {
                    foreach (var item in Model.Result.Sessions)
                    {
                        <tr class="border-t border-slate-200">
                            <td class="px-4 py-3 text-slate-700">@item.SessionName</td>
                            <td class="px-4 py-3 text-slate-700">
                                @{
                                    var statusClass = string.Equals(item.Status, "STARTED", StringComparison.OrdinalIgnoreCase)
                                        ? "status-active"
                                        : string.Equals(item.Status, "CREATED", StringComparison.OrdinalIgnoreCase)
                                            ? "status-draft"
                                            : "status-retired";
                                }
                                <span class="status-pill @statusClass">@item.Status</span>
                            </td>
                            <td class="px-4 py-3 text-right">@item.EventCount</td>
                            <td class="px-4 py-3 text-right">@(item.LearningPerformanceAggregateScore?.ToString("0.00") ?? "N/A")</td>
                            <td class="px-4 py-3 text-right">@(item.MissionPerformanceAggregateScore?.ToString("0.00") ?? "N/A")</td>
                            <td class="px-4 py-3 text-right">
                                <a class="table-link"
                                   asp-controller="Sessions"
                                   asp-action="Details"
                                   asp-route-sessionId="@item.SessionId">@Context.T("common.view")</a>
                            </td>
                        </tr>
                    }
                }
                </tbody>
            </table>
        </div>

        <div class="mt-8 table-wrap">
            <table class="w-full text-left text-sm">
                <thead class="table-head">
                    <tr>
                        <th class="px-4 py-3">@Context.T("rulesets.analytics.session")</th>
                        <th class="px-4 py-3">@Context.T("common.player_id")</th>
                        <th class="px-4 py-3 text-right">@Context.T("rulesets.analytics.user_learning")</th>
                        <th class="px-4 py-3 text-right">@Context.T("rulesets.analytics.user_quest")</th>
                    </tr>
                </thead>
                <tbody>
                @if (flatUserScores.Count == 0)
                {
                    <tr>
                        <td class="px-4 py-4 text-slate-500" colspan="4">@Context.T("rulesets.analytics.player_performance_empty")</td>
                    </tr>
                }
                else
                {
                    foreach (var item in flatUserScores)
                    {
                        <tr class="border-t border-slate-200">
                            <td class="px-4 py-3 text-slate-700">
                                <div class="font-semibold">@item.SessionName</div>
                                <div class="mt-1 text-xs text-slate-500 font-mono">@item.SessionId</div>
                            </td>
                            <td class="px-4 py-3 font-mono text-xs text-slate-600">@item.PlayerId</td>
                            <td class="px-4 py-3 text-right">@(item.LearningPerformanceIndividualScore?.ToString("0.00") ?? "N/A")</td>
                            <td class="px-4 py-3 text-right">@(item.MissionPerformanceIndividualScore?.ToString("0.00") ?? "N/A")</td>
                        </tr>
                    }
                }
                </tbody>
            </table>
        </div>
    }
</section>
