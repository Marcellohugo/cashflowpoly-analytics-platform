@model Cashflowpoly.Ui.Models.CreateRulesetViewModel

@{
    ViewData["Title"] = Context.T("rulesets.create");
}

<section class="section-shell">
    <div class="page-intro">
        <div class="page-intro-main">
            <p class="eyebrow">@Context.T("rulesets.management")</p>
            <h1 class="headline">@Context.T("rulesets.create_title")</h1>
            <p class="subhead">@Context.T("rulesets.create_subtitle")</p>
        </div>
        <div class="page-intro-actions">
            <a class="btn-ghost" asp-controller="Rulesets" asp-action="Index">@Context.T("rulesets.back_to_list")</a>
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
    {
        <div class="mt-4 alert alert-error" aria-live="polite">
            @Model.ErrorMessage
        </div>
    }

    <div class="mt-6 ruleset-unified">
        <div class="ruleset-tipline">
            <span>@Context.T("rulesets.tip.versioning_draft")</span>
            <span>@Context.T("rulesets.tip.consistency")</span>
            <span>@Context.T("rulesets.tip.safety_before_start")</span>
        </div>

        <form class="mt-4 form-grid" method="post">
            @Html.AntiForgeryToken()
            <div class="form-field">
                <label class="form-label" for="ruleset-name">@Context.T("common.name")</label>
                <input class="form-input"
                       id="ruleset-name"
                       asp-for="Name"
                       required />
            </div>
            <div class="form-field">
                <label class="form-label" for="ruleset-description">@Context.T("common.description")</label>
                <input class="form-input"
                       id="ruleset-description"
                       asp-for="Description" />
            </div>

            <div class="ruleset-form-section">
                <h3>@Context.T("rulesets.form.core_setup")</h3>
                <div class="grid gap-3 md:grid-cols-2 mt-3">
                    <div>
                        <label class="form-label" for="cfg-mode">@Context.T("rulesets.form.mode")</label>
                        <select id="cfg-mode" class="form-input">
                            <option value="PEMULA">@Context.T("rulesets.form.mode_beginner")</option>
                            <option value="MAHIR">@Context.T("rulesets.form.mode_advanced")</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label" for="cfg-actions">@Context.T("rulesets.form.actions_per_turn")</label>
                        <input id="cfg-actions" type="number" min="1" class="form-input" value="2" />
                    </div>
                    <div>
                        <label class="form-label" for="cfg-cash">@Context.T("rulesets.form.starting_cash")</label>
                        <input id="cfg-cash" type="number" min="0" class="form-input" value="20" />
                    </div>
                    <div>
                        <label class="form-label" for="cfg-freelance-income">@Context.T("rulesets.form.freelance_income")</label>
                        <input id="cfg-freelance-income" type="number" min="0" class="form-input" value="1" />
                    </div>
                </div>
            </div>

            <div class="ruleset-form-section">
                <h3>@Context.T("rulesets.form.weekday_features")</h3>
                <div class="grid gap-3 md:grid-cols-3 mt-3">
                    <label class="metric-row"><span class="metric-key">@Context.T("rulesets.form.friday_donation")</span><input id="cfg-friday" type="checkbox" checked /></label>
                    <label class="metric-row"><span class="metric-key">@Context.T("rulesets.form.saturday_gold_trade")</span><input id="cfg-saturday" type="checkbox" checked /></label>
                    <label class="metric-row"><span class="metric-key">@Context.T("rulesets.form.sunday_rest")</span><input id="cfg-sunday" type="checkbox" checked /></label>
                </div>
            </div>

            <div class="ruleset-form-section">
                <h3>@Context.T("rulesets.form.constraints")</h3>
                <div class="grid gap-3 md:grid-cols-2 mt-3">
                    <div>
                        <label class="form-label" for="cfg-cash-min">@Context.T("rulesets.form.cash_min")</label>
                        <input id="cfg-cash-min" type="number" class="form-input" value="0" />
                    </div>
                    <div>
                        <label class="form-label" for="cfg-max-ing-total">@Context.T("rulesets.form.max_ingredient_total")</label>
                        <input id="cfg-max-ing-total" type="number" min="1" class="form-input" value="6" />
                    </div>
                    <div>
                        <label class="form-label" for="cfg-max-same-ing">@Context.T("rulesets.form.max_same_ingredient")</label>
                        <input id="cfg-max-same-ing" type="number" min="1" class="form-input" value="3" />
                    </div>
                    <div>
                        <label class="form-label" for="cfg-primary-max-day">@Context.T("rulesets.form.primary_need_max_day")</label>
                        <input id="cfg-primary-max-day" type="number" min="1" class="form-input" value="1" />
                    </div>
                    <label class="metric-row md:col-span-2"><span class="metric-key">@Context.T("rulesets.form.require_primary_first")</span><input id="cfg-require-primary" type="checkbox" checked /></label>
                </div>
            </div>

            <div class="ruleset-form-section">
                <h3>@Context.T("rulesets.form.economy_advanced")</h3>
                <div class="grid gap-3 md:grid-cols-2 mt-3">
                    <div>
                        <label class="form-label" for="cfg-donation-min">@Context.T("rulesets.form.donation_min")</label>
                        <input id="cfg-donation-min" type="number" min="0" class="form-input" value="1" />
                    </div>
                    <div>
                        <label class="form-label" for="cfg-donation-max">@Context.T("rulesets.form.donation_max")</label>
                        <input id="cfg-donation-max" type="number" min="0" class="form-input" value="999999" />
                    </div>
                    <label class="metric-row"><span class="metric-key">@Context.T("rulesets.form.gold_buy")</span><input id="cfg-gold-buy" type="checkbox" checked /></label>
                    <label class="metric-row"><span class="metric-key">@Context.T("rulesets.form.gold_sell")</span><input id="cfg-gold-sell" type="checkbox" checked /></label>
                    <label class="metric-row"><span class="metric-key">@Context.T("rulesets.form.loan_enabled")</span><input id="cfg-adv-loan" type="checkbox" /></label>
                    <label class="metric-row"><span class="metric-key">@Context.T("rulesets.form.insurance_enabled")</span><input id="cfg-adv-insurance" type="checkbox" /></label>
                    <label class="metric-row"><span class="metric-key">@Context.T("rulesets.form.saving_goal_enabled")</span><input id="cfg-adv-saving-goal" type="checkbox" /></label>
                </div>
            </div>

            <textarea asp-for="ConfigJson" class="hidden"></textarea>
            <div class="form-actions">
                <button class="btn-primary"
                        type="submit">@Context.T("rulesets.save")</button>
                <a class="text-link" asp-controller="Rulesets" asp-action="Index">@Context.T("common.cancel")</a>
            </div>
        </form>
    </div>
</section>

@section Scripts {
    <script>
        (() => {
            const getEl = (id) => document.getElementById(id);
            const toInt = (id, fallback = 0) => {
                const v = parseInt(getEl(id)?.value ?? "", 10);
                return Number.isFinite(v) ? v : fallback;
            };
            const toBool = (id) => !!getEl(id)?.checked;
            const configTextArea = getEl("ConfigJson");

            const scoreDefaults = {
                donation_rank_points: [{ rank: 1, points: 7 }, { rank: 2, points: 5 }, { rank: 3, points: 2 }],
                gold_points_by_qty: [{ qty: 1, points: 3 }, { qty: 2, points: 5 }, { qty: 3, points: 8 }, { qty: 4, points: 12 }],
                pension_rank_points: [{ rank: 1, points: 5 }, { rank: 2, points: 3 }, { rank: 3, points: 1 }]
            };

            const readForm = () => ({
                mode: getEl("cfg-mode")?.value ?? "PEMULA",
                actions_per_turn: toInt("cfg-actions", 2),
                starting_cash: toInt("cfg-cash", 20),
                weekday_rules: {
                    friday: { feature: "DONATION", enabled: toBool("cfg-friday") },
                    saturday: { feature: "GOLD_TRADE", enabled: toBool("cfg-saturday") },
                    sunday: { feature: "REST", enabled: toBool("cfg-sunday") }
                },
                constraints: {
                    cash_min: toInt("cfg-cash-min", 0),
                    max_ingredient_total: toInt("cfg-max-ing-total", 6),
                    max_same_ingredient: toInt("cfg-max-same-ing", 3),
                    primary_need_max_per_day: toInt("cfg-primary-max-day", 1),
                    require_primary_before_others: toBool("cfg-require-primary")
                },
                donation: {
                    min_amount: toInt("cfg-donation-min", 1),
                    max_amount: toInt("cfg-donation-max", 999999)
                },
                gold_trade: {
                    allow_buy: toBool("cfg-gold-buy"),
                    allow_sell: toBool("cfg-gold-sell")
                },
                advanced: {
                    loan: { enabled: toBool("cfg-adv-loan") },
                    insurance: { enabled: toBool("cfg-adv-insurance") },
                    saving_goal: { enabled: toBool("cfg-adv-saving-goal") }
                },
                freelance: { income: toInt("cfg-freelance-income", 1) },
                scoring: scoreDefaults
            });

            const writeFormFromConfig = (cfg) => {
                if (!cfg || typeof cfg !== "object") return;
                getEl("cfg-mode").value = cfg.mode ?? "PEMULA";
                getEl("cfg-actions").value = cfg.actions_per_turn ?? 2;
                getEl("cfg-cash").value = cfg.starting_cash ?? 20;
                getEl("cfg-freelance-income").value = cfg.freelance?.income ?? 1;
                getEl("cfg-friday").checked = !!cfg.weekday_rules?.friday?.enabled;
                getEl("cfg-saturday").checked = !!cfg.weekday_rules?.saturday?.enabled;
                getEl("cfg-sunday").checked = !!cfg.weekday_rules?.sunday?.enabled;
                getEl("cfg-cash-min").value = cfg.constraints?.cash_min ?? 0;
                getEl("cfg-max-ing-total").value = cfg.constraints?.max_ingredient_total ?? 6;
                getEl("cfg-max-same-ing").value = cfg.constraints?.max_same_ingredient ?? 3;
                getEl("cfg-primary-max-day").value = cfg.constraints?.primary_need_max_per_day ?? 1;
                getEl("cfg-require-primary").checked = cfg.constraints?.require_primary_before_others ?? true;
                getEl("cfg-donation-min").value = cfg.donation?.min_amount ?? 1;
                getEl("cfg-donation-max").value = cfg.donation?.max_amount ?? 999999;
                getEl("cfg-gold-buy").checked = cfg.gold_trade?.allow_buy ?? true;
                getEl("cfg-gold-sell").checked = cfg.gold_trade?.allow_sell ?? true;
                getEl("cfg-adv-loan").checked = !!cfg.advanced?.loan?.enabled;
                getEl("cfg-adv-insurance").checked = !!cfg.advanced?.insurance?.enabled;
                getEl("cfg-adv-saving-goal").checked = !!cfg.advanced?.saving_goal?.enabled;
            };

            const refreshConfig = () => {
                const cfg = readForm();
                const json = JSON.stringify(cfg, null, 2);
                configTextArea.value = json;
            };

            try {
                if (configTextArea?.value?.trim()) {
                    writeFormFromConfig(JSON.parse(configTextArea.value));
                }
            } catch (_) {}

            document.querySelectorAll("input, select").forEach((el) => {
                el.addEventListener("input", refreshConfig);
                el.addEventListener("change", refreshConfig);
            });

            refreshConfig();
        })();
    </script>
}
