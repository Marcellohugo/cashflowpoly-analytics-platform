@* Fungsi file: Merender tampilan Razor untuk bagian Players/Details.cshtml beserta interaksi presentasinya. *@
@using System.Text.Json
@using Microsoft.AspNetCore.Http
@using Cashflowpoly.Ui.Infrastructure
@model Cashflowpoly.Ui.Models.PlayerDetailViewModel

@{
    ViewData["Title"] = Context.T("players.detail_title");

    var activeLanguage = UiText.NormalizeLanguage(Context.Session.GetString(AuthConstants.SessionLanguageKey));
    var isEnglish = string.Equals(activeLanguage, AuthConstants.LanguageEn, StringComparison.OrdinalIgnoreCase);
    string L(string id, string en) => isEnglish ? en : id;

    static string FormatJsonLeafValue(JsonElement element)
    {
        return element.ValueKind switch
        {
            JsonValueKind.String => element.GetString() ?? string.Empty,
            JsonValueKind.True => "true",
            JsonValueKind.False => "false",
            JsonValueKind.Number => element.GetRawText(),
            JsonValueKind.Null => "null",
            _ => element.GetRawText()
        };
    }

    static List<(string Path, string Value)> FlattenJsonLeaves(JsonElement? root)
    {
        var rows = new List<(string Path, string Value)>();
        if (!root.HasValue)
        {
            return rows;
        }

        static void Visit(JsonElement element, string path, List<(string Path, string Value)> output)
        {
            switch (element.ValueKind)
            {
                case JsonValueKind.Object:
                {
                    var hasProperty = false;
                    foreach (var property in element.EnumerateObject())
                    {
                        hasProperty = true;
                        var nextPath = string.IsNullOrWhiteSpace(path) ? property.Name : $"{path}.{property.Name}";
                        Visit(property.Value, nextPath, output);
                    }

                    if (!hasProperty && !string.IsNullOrWhiteSpace(path))
                    {
                        output.Add((path, "{}"));
                    }

                    break;
                }
                case JsonValueKind.Array:
                {
                    var index = 0;
                    foreach (var item in element.EnumerateArray())
                    {
                        Visit(item, $"{path}[{index}]", output);
                        index += 1;
                    }

                    if (index == 0 && !string.IsNullOrWhiteSpace(path))
                    {
                        output.Add((path, "[]"));
                    }

                    break;
                }
                case JsonValueKind.String:
                case JsonValueKind.True:
                case JsonValueKind.False:
                case JsonValueKind.Number:
                case JsonValueKind.Null:
                    output.Add((string.IsNullOrWhiteSpace(path) ? "value" : path, FormatJsonLeafValue(element)));
                    break;
                default:
                    output.Add((string.IsNullOrWhiteSpace(path) ? "value" : path, element.ToString()));
                    break;
            }
        }

        Visit(root.Value, string.Empty, rows);
        return rows;
    }

    static List<(string GroupKey, List<(string Path, string Value)> Rows)> BuildMetricGroups(JsonElement? root)
    {
        var groups = new List<(string GroupKey, List<(string Path, string Value)> Rows)>();
        if (!root.HasValue || root.Value.ValueKind != JsonValueKind.Object)
        {
            return groups;
        }

        var scalarRows = new List<(string Path, string Value)>();
        foreach (var property in root.Value.EnumerateObject())
        {
            if (property.Value.ValueKind == JsonValueKind.Object || property.Value.ValueKind == JsonValueKind.Array)
            {
                var rows = FlattenJsonLeaves(property.Value);
                if (rows.Count == 0)
                {
                    rows.Add(("value", FormatJsonLeafValue(property.Value)));
                }

                groups.Add((property.Name, rows));
                continue;
            }

            scalarRows.Add((property.Name, FormatJsonLeafValue(property.Value)));
        }

        if (scalarRows.Count > 0)
        {
            groups.Insert(0, ("summary", scalarRows));
        }

        return groups;
    }

    string FormatMetricFieldValue(string rawValue)
    {
        if (string.Equals(rawValue, "true", StringComparison.OrdinalIgnoreCase))
        {
            return Context.T("state.true");
        }

        if (string.Equals(rawValue, "false", StringComparison.OrdinalIgnoreCase))
        {
            return Context.T("state.false");
        }

        if (string.Equals(rawValue, "null", StringComparison.OrdinalIgnoreCase))
        {
            return Context.T("common.na");
        }

        return string.IsNullOrEmpty(rawValue) ? "\"\"" : rawValue;
    }

    static List<(string Path, string Value)> MergeUniqueRows(params IEnumerable<(string Path, string Value)>[] rowSets)
    {
        var result = new List<(string Path, string Value)>();
        var seen = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        foreach (var rowSet in rowSets)
        {
            foreach (var row in rowSet)
            {
                if (string.IsNullOrWhiteSpace(row.Path))
                {
                    continue;
                }

                if (seen.Add(row.Path))
                {
                    result.Add(row);
                }
            }
        }

        return result;
    }

    static List<(string Path, string Value)> GetGroupRows(
        Dictionary<string, List<(string Path, string Value)>> source,
        params string[] keys)
    {
        var rows = new List<(string Path, string Value)>();
        foreach (var key in keys)
        {
            if (!source.TryGetValue(key, out var groupRows))
            {
                continue;
            }

            rows.AddRange(groupRows);
        }

        return rows;
    }

    static List<(string Path, string Value)> FilterRowsByKeywords(
        IEnumerable<(string Path, string Value)> rows,
        params string[] keywords)
    {
        return rows
            .Where(row => keywords.Any(keyword => row.Path.Contains(keyword, StringComparison.OrdinalIgnoreCase)))
            .ToList();
    }

    var rawGroups = BuildMetricGroups(Model.GameplayRaw);
    var derivedGroups = BuildMetricGroups(Model.GameplayDerived);
    var rawGroupMap = rawGroups.ToDictionary(item => item.GroupKey, item => item.Rows, StringComparer.OrdinalIgnoreCase);
    var derivedGroupMap = derivedGroups.ToDictionary(item => item.GroupKey, item => item.Rows, StringComparer.OrdinalIgnoreCase);

    var mappedRawKeys = new HashSet<string>(
        new[] { "coins", "ingredients", "meal_orders", "needs", "donations", "gold", "pension", "life_risk", "financial_goals", "actions", "turns" },
        StringComparer.OrdinalIgnoreCase);
    var rawFallbackKeys = rawGroupMap.Keys.Where(key => !mappedRawKeys.Contains(key)).ToArray();

    var part11Rows = MergeUniqueRows(
        GetGroupRows(rawGroupMap, "turns"),
        GetGroupRows(rawGroupMap, rawFallbackKeys));

    var part1Sections = new List<(string Code, string Title, string Description, List<(string Path, string Value)> Rows)>
    {
        ("1.1", L("Variabel Koin & Finansial", "Coin-Based Financial Variables"), L("Modal awal, arus kas, donasi, tabungan, dan saldo akhir.", "Starting capital, cashflow, donations, savings, and end balance."), GetGroupRows(rawGroupMap, "coins")),
        ("1.2", L("Variabel Kartu Bahan", "Ingredient Card Variables"), L("Perolehan, stok, penggunaan, dan pemborosan bahan.", "Ingredient acquisition, stock, usage, and waste."), GetGroupRows(rawGroupMap, "ingredients")),
        ("1.3", L("Variabel Pesanan Makanan", "Meal Order Variables"), L("Jumlah pesanan, pendapatan pesanan, dan keputusan melewati pesanan.", "Order count, order income, and pass decisions."), GetGroupRows(rawGroupMap, "meal_orders")),
        ("1.4", L("Variabel Kartu Kebutuhan", "Need Card Variables"), L("Kepemilikan kebutuhan primer-sekunder-tersier dan status misi koleksi.", "Primary-secondary-tertiary needs ownership and collection mission status."), GetGroupRows(rawGroupMap, "needs")),
        ("1.5", L("Variabel Donasi", "Donation Variables"), L("Nominal donasi, ranking donasi, dan poin donasi.", "Donation amount, donation rank, and donation points."), GetGroupRows(rawGroupMap, "donations")),
        ("1.6", L("Variabel Investasi Emas", "Gold Investment Variables"), L("Pembelian, penjualan, posisi akhir, dan arus kas emas.", "Gold buy/sell, ending position, and gold cashflow."), GetGroupRows(rawGroupMap, "gold")),
        ("1.7", L("Variabel Dana Pensiun", "Pension Fund Variables"), L("Komponen dana pensiun akhir dan peringkat poin pensiun.", "End-game pension components and pension ranking points."), GetGroupRows(rawGroupMap, "pension")),
        ("1.8", L("Variabel Risiko Hidup", "Life Risk Variables"), L("Frekuensi risiko, biaya risiko, dan mitigasi asuransi.", "Risk frequency, risk costs, and insurance mitigation."), GetGroupRows(rawGroupMap, "life_risk")),
        ("1.9", L("Variabel Target Finansial", "Financial Goal Variables"), L("Progres target finansial, pinjaman, dan status pelunasan.", "Financial goal progress, loans, and repayment status."), GetGroupRows(rawGroupMap, "financial_goals")),
        ("1.10", L("Variabel Penggunaan Token Aksi", "Action Token Usage Variables"), L("Distribusi aksi per giliran, repetisi aksi, dan aksi terlewati.", "Per-turn action distribution, repetitions, and skipped actions."), GetGroupRows(rawGroupMap, "actions")),
        ("1.11", L("Variabel Progres Giliran", "Turn-by-Turn Progression Variables"), L("Perkembangan ekonomi dari awal sampai akhir permainan.", "Economic progression from start to end of the game."), part11Rows)
    };

    var derivedSummaryRows = GetGroupRows(derivedGroupMap, "summary");

    var financialDerivedRows = MergeUniqueRows(
        FilterRowsByKeywords(
            derivedSummaryRows,
            "net_worth",
            "income_diversification",
            "expense_management",
            "business_profit",
            "business_efficiency",
            "gold_roi",
            "growth_pattern"),
        GetGroupRows(derivedGroupMap, "expense_management_components"));

    var strategicDerivedRows = MergeUniqueRows(
        FilterRowsByKeywords(
            derivedSummaryRows,
            "risk_appetite",
            "debt_leverage",
            "debt_ratio",
            "loan_repayment",
            "goal_setting_ambition",
            "risk_exposure",
            "risk_mitigation"),
        GetGroupRows(derivedGroupMap, "risk_appetite_components"));

    var behaviorDerivedRows = FilterRowsByKeywords(
        derivedSummaryRows,
        "action_efficiency",
        "meal_order_success",
        "planning_horizon",
        "donation_aggressiveness",
        "donation_stability");

    var flourishingDerivedRows = MergeUniqueRows(
        FilterRowsByKeywords(
            derivedSummaryRows,
            "fulfillment_diversity",
            "donation_commitment",
            "mission_achievement"),
        GetGroupRows(derivedGroupMap, "happiness_portfolio"));

    var mappedDerivedPaths = new HashSet<string>(
        financialDerivedRows
            .Concat(strategicDerivedRows)
            .Concat(behaviorDerivedRows)
            .Concat(flourishingDerivedRows)
            .Select(row => row.Path),
        StringComparer.OrdinalIgnoreCase);
    var fallbackDerivedRows = derivedSummaryRows.Where(row => !mappedDerivedPaths.Contains(row.Path)).ToList();
    if (fallbackDerivedRows.Count > 0)
    {
        behaviorDerivedRows = MergeUniqueRows(behaviorDerivedRows, fallbackDerivedRows);
    }

    var part2Sections = new List<(string Code, string Title, string Description, List<(string Path, string Value)> Rows)>
    {
        ("2.1", L("Metrik Performa Finansial", "Financial Performance Metrics"), L("Indeks kekayaan, diversifikasi pendapatan, efisiensi pengeluaran, dan margin laba.", "Net worth index, income diversification, spending efficiency, and profit margin."), financialDerivedRows),
        ("2.2", L("Metrik Keputusan Strategis", "Strategic Decision Metrics"), L("Selera risiko, leverage utang, dan ambisi target finansial.", "Risk appetite, debt leverage, and financial goal ambition."), strategicDerivedRows),
        ("2.3", L("Metrik Perilaku Pemain", "Player Behavior Metrics"), L("Efisiensi aksi, keberhasilan pesanan, dan orientasi perencanaan.", "Action efficiency, order success, and planning orientation."), behaviorDerivedRows),
        ("2.4", L("Metrik Flourishing", "Flourishing-Related Metrics"), L("Keberagaman pemenuhan, komitmen donasi, dan komposisi portofolio kebahagiaan.", "Fulfillment diversity, donation commitment, and happiness portfolio composition."), flourishingDerivedRows)
    };

    var hasGameplayData = Model.GameplayDerived.HasValue || Model.GameplayRaw.HasValue;
}

<section class="section-shell">
    <div>
        <p class="eyebrow text-emerald-700">@Context.T("players.analytics_title")</p>
        <h1 class="headline">@Context.T("players.detail_title")</h1>
        @if (!string.IsNullOrWhiteSpace(Model.PlayerDisplayName))
        {
            <p class="mt-2 text-base font-semibold text-slate-700">@Model.PlayerDisplayName</p>
        }
        <p class="mt-2 text-xs text-slate-500 font-mono">@Model.PlayerId</p>
        @if (Model.GameplayComputedAt.HasValue)
        {
            <p class="mt-2 text-xs text-slate-500">@Context.T("common.computed"): @Model.GameplayComputedAt.Value.ToString("dd/MM/yyyy HH:mm")</p>
        }
    </div>

    @if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
    {
        <div class="mt-4 alert alert-error" aria-live="polite">
            @Model.ErrorMessage
        </div>
    }

    @if (!string.IsNullOrWhiteSpace(Model.GameplayErrorMessage))
    {
        <div class="mt-4 alert alert-warning" aria-live="polite">
            @Model.GameplayErrorMessage
        </div>
    }

    @if (!hasGameplayData)
    {
        <div class="mt-6 alert alert-info" aria-live="polite">
            @Context.T("state.no_player_data")
        </div>
    }
    else
    {
        <div class="players-fusion-metrics mt-6">
            <div class="players-fusion-head">
                <div class="page-intro-main">
                    <p class="eyebrow">@Context.T("gameplay.raw")</p>
                    <h2 class="headline text-xl">@L("Part 1: Variabel Permainan Fisik", "Part 1: Physical Gameplay Variables")</h2>
                    <p class="subhead text-sm">@L("Semua variabel mentah disusun sesuai 11 domain observasi komponen permainan.", "All raw variables are organized into the 11 observable gameplay component domains.")</p>
                </div>
            </div>

            <div class="metric-domain-layout mt-6">
                @foreach (var partSection in part1Sections)
                {
                    <details class="metric-domain-card" open>
                        <summary>
                            <span>@partSection.Code @partSection.Title</span>
                            <span class="metric-domain-count">@partSection.Rows.Count @Context.T("players.metric_items_suffix")</span>
                        </summary>
                        <p class="metric-domain-intro">@partSection.Description</p>
                        @if (partSection.Rows.Count == 0)
                        {
                            <p class="text-sm text-slate-500">@Context.T("common.na")</p>
                        }
                        else
                        {
                            <div class="metric-list metric-list-compact">
                                @foreach (var row in partSection.Rows)
                                {
                                    <div class="metric-row metric-row-dense">
                                        <span class="metric-key metric-key-path">@row.Path</span>
                                        <span class="metric-value metric-value-path">@FormatMetricFieldValue(row.Value)</span>
                                    </div>
                                }
                            </div>
                        }
                    </details>
                }
            </div>
        </div>

        <div class="players-fusion-metrics mt-6">
            <div class="players-fusion-head">
                <div class="page-intro-main">
                    <p class="eyebrow">@Context.T("gameplay.derived")</p>
                    <h2 class="headline text-xl">@L("Part 2: Metrik Turunan Analitika", "Part 2: Derived Analytics Metrics")</h2>
                    <p class="subhead text-sm">@L("Metrik turunan dikelompokkan ke 4 area evaluasi sesuai kerangka metrik yang Anda tetapkan.", "Derived metrics are grouped into 4 evaluation areas based on your metric framework.")</p>
                </div>
            </div>

            <div class="metric-domain-layout mt-6">
                @foreach (var partSection in part2Sections)
                {
                    <details class="metric-domain-card" open>
                        <summary>
                            <span>@partSection.Code @partSection.Title</span>
                            <span class="metric-domain-count">@partSection.Rows.Count @Context.T("players.metric_items_suffix")</span>
                        </summary>
                        <p class="metric-domain-intro">@partSection.Description</p>
                        @if (partSection.Rows.Count == 0)
                        {
                            <p class="text-sm text-slate-500">@Context.T("common.na")</p>
                        }
                        else
                        {
                            <div class="metric-list metric-list-compact">
                                @foreach (var row in partSection.Rows)
                                {
                                    <div class="metric-row metric-row-dense">
                                        <span class="metric-key metric-key-path">@row.Path</span>
                                        <span class="metric-value metric-value-path">@FormatMetricFieldValue(row.Value)</span>
                                    </div>
                                }
                            </div>
                        }
                    </details>
                }
            </div>
        </div>
    }
</section>
