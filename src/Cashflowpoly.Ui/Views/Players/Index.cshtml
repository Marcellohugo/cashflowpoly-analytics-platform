@model Cashflowpoly.Ui.Models.PlayerDirectoryViewModel

@{
    ViewData["Title"] = Context.T("nav.players");
}

<section class="section-shell w-full">
    <div class="page-intro">
        <div class="page-intro-main">
            <p class="eyebrow">@Context.T("players.management")</p>
            <h1 class="headline">@Context.T("players.title")</h1>
            <p class="subhead">@Context.T("players.subtitle")</p>
        </div>
    </div>

    <div class="mt-5 ruleset-stats">
        <div class="stat-card">
            <p class="text-xs uppercase text-slate-500">@Context.T("players.total_players")</p>
            <p class="mt-2 text-2xl font-semibold text-slate-900">@Model.Players.Count</p>
        </div>
        <div class="stat-card">
            <p class="text-xs uppercase text-slate-500">@Context.T("players.total_sessions")</p>
            <p class="mt-2 text-2xl font-semibold text-slate-900">@Model.SessionGroups.Count</p>
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
    {
        <div class="mt-4 alert alert-error" aria-live="polite">
            @Model.ErrorMessage
        </div>
    }

    <details class="mt-4 data-toggle">
        <summary>@Context.T("players.tips.title")</summary>
        <div class="mt-3 metric-panel">
            <div class="metric-list">
                <div class="metric-row"><span class="metric-key">@Context.T("players.tip_key.validate")</span><span class="metric-value">@Context.T("players.tip.validate")</span></div>
                <div class="metric-row"><span class="metric-key">@Context.T("players.tip_key.tracking")</span><span class="metric-value">@Context.T("players.tip.tracking")</span></div>
                <div class="metric-row"><span class="metric-key">@Context.T("players.tip_key.analysis")</span><span class="metric-value">@Context.T("players.tip.analysis")</span></div>
            </div>
        </div>
    </details>

    @if (Model.SessionGroups.Count == 0)
    {
        <div class="mt-6 table-wrap">
            <table class="w-full text-left text-sm">
                <thead class="table-head">
                    <tr>
                        <th class="px-4 py-3">@Context.T("common.name")</th>
                        <th class="px-4 py-3">@Context.T("common.player_id")</th>
                    </tr>
                </thead>
                <tbody>
                @if (Model.Players.Count == 0)
                {
                    <tr>
                        <td class="px-4 py-4 text-slate-500" colspan="2">@Context.T("state.no_players")</td>
                    </tr>
                }
                else
                {
                    foreach (var player in Model.Players)
                    {
                        <tr class="border-t border-slate-200">
                            <td class="px-4 py-3">
                                <span class="font-medium text-slate-900">@player.DisplayName</span>
                            </td>
                            <td class="px-4 py-3 font-mono text-xs text-slate-600">@player.PlayerId</td>
                        </tr>
                    }
                }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="mt-6 space-y-4">
            @foreach (var session in Model.SessionGroups)
            {
                <details class="data-toggle" open>
                    <summary>
                        @session.SessionName
                        <span class="ml-2 text-xs text-slate-500">(@session.Players.Count @Context.T("players.count_suffix"))</span>
                    </summary>
                    <div class="mt-3 alert alert-info text-xs">
                        <span class="font-semibold">@Context.T("common.session_id"):</span> <span class="font-mono">@session.SessionId</span>
                        <span class="ml-3 font-semibold">@Context.T("common.status"):</span> @Context.TSessionStatus(session.Status)
                        @if (session.StartedAt.HasValue)
                        {
                            <span class="ml-3 font-semibold">@Context.T("common.start"):</span> @session.StartedAt.Value.ToString("dd/MM/yyyy HH:mm")
                        }
                        @if (session.EndedAt.HasValue)
                        {
                            <span class="ml-3 font-semibold">@Context.T("common.finish"):</span> @session.EndedAt.Value.ToString("dd/MM/yyyy HH:mm")
                        }
                    </div>

                    <div class="mt-3 table-wrap">
                        <table class="w-full text-left text-sm">
                            <thead class="table-head">
                                <tr>
                                    <th class="px-4 py-3 text-right">@Context.T("common.turn_order")</th>
                                    <th class="px-4 py-3 text-right">@Context.T("common.rank")</th>
                                    <th class="px-4 py-3 text-right">@Context.T("sessions.champion.donation")</th>
                                    <th class="px-4 py-3 text-right">@Context.T("sessions.champion.pension")</th>
                                    <th class="px-4 py-3">@Context.T("common.name")</th>
                                    <th class="px-4 py-3">@Context.T("common.player_id")</th>
                                    <th class="px-4 py-3 text-right">@Context.T("metric.net_cashflow")</th>
                                    <th class="px-4 py-3 text-right">@Context.T("metric.happiness")</th>
                                    <th class="px-4 py-3 text-right">@Context.T("common.detail")</th>
                                </tr>
                            </thead>
                            <tbody>
                            @{
                                var rankedPlayers = session.Players
                                    .OrderByDescending(p => p.HappinessPointsTotal)
                                    .ThenByDescending(p => p.CashInTotal - p.CashOutTotal)
                                    .ThenBy(p => p.JoinOrder > 0 ? p.JoinOrder : int.MaxValue)
                                    .ThenBy(p => p.PlayerId)
                                    .ToList();
                                var sessionRankLookup = rankedPlayers
                                    .Select((player, index) => new { player.PlayerId, Rank = index + 1 })
                                    .ToDictionary(item => item.PlayerId, item => item.Rank);
                                var donationChampionLookup = session.Players
                                    .OrderByDescending(p => p.DonationPointsTotal)
                                    .ThenByDescending(p => p.DonationTotal)
                                    .ThenBy(p => p.JoinOrder > 0 ? p.JoinOrder : int.MaxValue)
                                    .ThenBy(p => p.PlayerId)
                                    .Take(3)
                                    .Select((player, index) => new { player.PlayerId, Rank = index + 1 })
                                    .ToDictionary(item => item.PlayerId, item => item.Rank);
                                var pensionChampionLookup = session.Players
                                    .OrderByDescending(p => p.PensionPointsTotal)
                                    .ThenByDescending(p => p.CashInTotal - p.CashOutTotal)
                                    .ThenBy(p => p.JoinOrder > 0 ? p.JoinOrder : int.MaxValue)
                                    .ThenBy(p => p.PlayerId)
                                    .Take(3)
                                    .Select((player, index) => new { player.PlayerId, Rank = index + 1 })
                                    .ToDictionary(item => item.PlayerId, item => item.Rank);
                            }
                            @foreach (var player in session.Players)
                            {
                                var netCashflow = player.CashInTotal - player.CashOutTotal;
                                var rank = sessionRankLookup.TryGetValue(player.PlayerId, out var resolvedRank)
                                    ? resolvedRank
                                    : 0;
                                var donationRank = donationChampionLookup.TryGetValue(player.PlayerId, out var donationResolvedRank)
                                    ? donationResolvedRank
                                    : 0;
                                var pensionRank = pensionChampionLookup.TryGetValue(player.PlayerId, out var pensionResolvedRank)
                                    ? pensionResolvedRank
                                    : 0;
                                var isSessionWinner = rank == 1;
                                <tr class="border-t border-slate-200 @(isSessionWinner ? "winner-row" : string.Empty)">
                                    <td class="px-4 py-3 text-right text-slate-700">@(player.JoinOrder > 0 ? player.JoinOrder : "-")</td>
                                    <td class="px-4 py-3 text-right text-slate-700">@(rank > 0 ? rank : "-")</td>
                                    <td class="px-4 py-3 text-right text-slate-700">@(donationRank > 0 ? donationRank : "-")</td>
                                    <td class="px-4 py-3 text-right text-slate-700">@(pensionRank > 0 ? pensionRank : "-")</td>
                                    <td class="px-4 py-3">
                                        <span class="font-medium text-slate-900">@player.DisplayName</span>
                                    </td>
                                    <td class="px-4 py-3 font-mono text-xs text-slate-600">@player.PlayerId</td>
                                    <td class="px-4 py-3 text-right">@netCashflow</td>
                                    <td class="px-4 py-3 text-right">@player.HappinessPointsTotal</td>
                                    <td class="px-4 py-3 text-right">
                                        <a class="table-link"
                                           asp-controller="Players"
                                           asp-action="Details"
                                           asp-route-sessionId="@session.SessionId"
                                           asp-route-playerId="@player.PlayerId">@Context.T("common.view")</a>
                                    </td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                </details>
            }
        </div>
    }
</section>
